# Lefthook git hooks configuration
# https://github.com/evilmartians/lefthook
#
# Skip hooks: LEFTHOOK=0 git push
# Skip specific hook: LEFTHOOK_EXCLUDE=validate-changeset git push
# Git native skip: git push --no-verify

pre-commit:
  commands:
    oxlint:
      glob: "*.{ts,tsx,js,jsx,astro}"
      run: pnpm oxlint --config .oxlintrc.json {staged_files}

pre-push:
  skip:
    - ref: main
  commands:
    validate-changeset:
      run: pnpm tsx ci/scripts/validate-kumo-changeset.ts
      skip:
        - merge
        - rebase
    check-agents-staleness:
      run: |
        hash=$(sed -n 's/.*\*\*Commit:\*\* \([a-f0-9]*\).*/\1/p' AGENTS.md 2>/dev/null) || true
        if [ -n "$hash" ] && git rev-parse "$hash" >/dev/null 2>&1; then
          count=$(git rev-list --count "$hash"..HEAD 2>/dev/null) || true
          if [ "${count:-0}" -gt 50 ]; then
            echo "WARNING: AGENTS.md is $count commits stale (generated at $hash). Consider regenerating."
          fi
        fi
      skip:
        - merge
        - rebase
