{
  "prdName": "interactivity-and-exports",
  "tasks": [
    {
      "id": "renderer-1",
      "category": "renderer",
      "description": "Button/Link onClick→action bridging in UITreeRenderer. When an element has an action field and the component type is Button or Link, inject onClick handler that calls the action handler instead of injecting onAction.",
      "steps": [
        "Counter increment/decrement buttons update the count in React SPA",
        "Counter increment/decrement buttons update the count in HTML/UMD cross-boundary",
        "Other Button actions (non-counter) dispatch ActionEvents to host",
        "Link elements with actions dispatch on click",
        "Existing onClick props from LLM output are preserved (not overwritten)",
        "New test cases for Button/Link action injection in UITreeRenderer"
      ],
      "passes": true
    },
    {
      "id": "action-1",
      "category": "action",
      "description": "Create action handler registry (src/core/action-registry.ts) with ActionHandlerMap, ActionResult discriminated union, and built-in handlers for counter, form-submit, and navigation actions.",
      "steps": [
        "ActionHandlerMap type exists mapping action names to handler functions",
        "ActionResult discriminated union covers patch, message, external, none",
        "BUILTIN_HANDLERS includes increment, decrement, submit_form, navigate",
        "Counter handler produces correct RFC 6902 patches",
        "Tests: action registry handlers return correct ActionResult types"
      ],
      "passes": true
    },
    {
      "id": "action-2",
      "category": "action",
      "description": "Wire ChatDemo.tsx to use action registry instead of hardcoded counter bridge. handleAction dispatches to registry, processes ActionResult (apply patches, send messages, fire external calls).",
      "steps": [
        "Counter actions still work via registry (regression test)",
        "Form-submit actions send form data as a chat message",
        "Unknown actions are logged but don't crash",
        "Tests: message dispatch, form collection"
      ],
      "passes": true
    },
    {
      "id": "action-3",
      "category": "action",
      "description": "Update cross-boundary.html action handling to use same registry pattern. Counter actions remain inline, add form-submit handler that sends as next chat message.",
      "steps": [
        "Counter actions work in cross-boundary HTML",
        "Form-submit actions trigger streamChat with form data",
        "Unknown actions logged to action event panel without crash"
      ],
      "passes": true
    },
    {
      "id": "action-4",
      "category": "action",
      "description": "Add form-submit action examples and generic action guidelines to system-prompt.ts.",
      "steps": [
        "System prompt includes submit_form action example with params",
        "System prompt includes generic action usage guidelines",
        "Existing counter action example preserved"
      ],
      "passes": true
    },
    {
      "id": "export-1",
      "category": "export",
      "description": "Add ai/schemas as a Vite entry point in packages/kumo/vite.config.ts so it produces a stable dist/ai/schemas.js.",
      "steps": [
        "ai/schemas entry added to vite.config.ts build.lib.entry",
        "pnpm --filter @cloudflare/kumo build produces dist/ai/schemas.js",
        "dist/ai/schemas.js is a stable (non-hashed) output file",
        "zod added to externals in vite config"
      ],
      "passes": true
    },
    {
      "id": "export-2",
      "category": "export",
      "description": "Update packages/kumo/package.json ./ai/schemas export to point at compiled dist output instead of raw .ts.",
      "steps": [
        "import { ButtonSchema } from '@cloudflare/kumo/ai/schemas' works with Node.js (no TS loader)",
        "import type { ... } from '@cloudflare/kumo/ai/schemas' still resolves types",
        "Catalog's lazy schema loading still works",
        "Build passes, existing tests pass"
      ],
      "passes": true
    },
    {
      "id": "infra-1",
      "category": "infra",
      "description": "Switch kumo-stream from bun to pnpm. Delete bun.lock, change dependency to workspace:*, add _examples/kumo-stream to pnpm-workspace.yaml, update scripts.",
      "steps": [
        "bun.lock removed",
        "pnpm install from root resolves @cloudflare/kumo correctly",
        "pnpm dev, pnpm build, pnpm test all work from _examples/kumo-stream/",
        "pnpm build:loadable produces dist/loadable/ correctly",
        "No bun references remain in package.json scripts"
      ],
      "passes": true
    },
    {
      "id": "wellknown-1",
      "category": "wellknown",
      "description": "Add .well-known static routes to server/index.ts serving component-loadable.umd.js, component-registry.json, stylesheet.css, and generative-ui.json discovery endpoint.",
      "steps": [
        "GET /.well-known/component-loadable.umd.js returns the UMD bundle",
        "GET /.well-known/component-registry.json returns the component registry",
        "GET /.well-known/stylesheet.css returns the compiled CSS",
        "GET /.well-known/generative-ui.json returns discovery metadata with version, paths, and streaming info"
      ],
      "passes": true
    },
    {
      "id": "wellknown-2",
      "category": "wellknown",
      "description": "Update cross-boundary.html to load from .well-known paths instead of /dist/loadable/.",
      "steps": [
        "cross-boundary.html stylesheet link points to /.well-known/stylesheet.css",
        "cross-boundary.html script src points to /.well-known/component-loadable.umd.js",
        "Page renders correctly with .well-known paths"
      ],
      "passes": false
    },
    {
      "id": "a11y-1",
      "category": "a11y",
      "description": "Add accessibility rules and DOM nesting anti-patterns to system-prompt.ts.",
      "steps": [
        "System prompt includes rule: every Input MUST have label or aria-label",
        "System prompt includes rule: every Checkbox/Select MUST have label",
        "System prompt includes rule: never nest Text inside Banner as direct children",
        "System prompt includes rule: never nest block-level elements inside Text",
        "Counter preset example has proper labels on any form elements"
      ],
      "passes": false
    },
    {
      "id": "docs-1",
      "category": "docs",
      "description": "Update GENERATIVE-UI.md streaming section with JSONL + RFC 6902 pattern and code examples.",
      "steps": [
        "Streaming section documents JSONL format with line-by-line RFC 6902 patches",
        "Includes code examples showing SSE wire format and patch application"
      ],
      "passes": false
    },
    {
      "id": "docs-2",
      "category": "docs",
      "description": "Add action system section to GENERATIVE-UI.md explaining ActionEvent → host dispatch → effect pattern.",
      "steps": [
        "Action system section explains ActionEvent structure",
        "Documents host dispatch pattern with handler registry",
        "Shows ActionResult types and their effects"
      ],
      "passes": false
    },
    {
      "id": "docs-3",
      "category": "docs",
      "description": "Update .well-known convention section in GENERATIVE-UI.md to match implementation (.umd.js not .umd.cjs), document kumo-stream as reference, clarify registry hosting.",
      "steps": [
        ".well-known section uses .umd.js extension (not .umd.cjs)",
        "kumo-stream documented as reference implementation",
        "Registry hosting clarified: serve from node_modules/@cloudflare/kumo or re-host"
      ],
      "passes": false
    },
    {
      "id": "validation-1",
      "category": "validation",
      "description": "Validate LLM-generated UI tree elements against @cloudflare/kumo/ai/schemas before rendering. Log validation errors with element key and schema violation details. Invalid elements degrade gracefully via ErrorBoundary.",
      "steps": [
        "LLM-generated UI elements are validated against Kumo Zod schemas before rendering",
        "Validation errors logged with element key and schema violation details",
        "Invalid elements degrade gracefully (ErrorBoundary fallback, don't block tree)",
        "Valid elements pass through with no performance overhead",
        "Tests: valid tree passes, invalid props caught, missing required props caught, rendering continues after validation failure"
      ],
      "passes": false
    },
    {
      "id": "ui-align-1",
      "category": "ui",
      "description": "Align React SPA (ChatDemo.tsx) layout to match the HTML/UMD cross-boundary.html design. The React app should adopt the same single-column, centered page layout with header, dark mode toggle, status text, and action log panel below the conversation area — matching the polished look of the HTML version.",
      "steps": [
        "Single-column layout: remove 2-column flex split, use max-w-[960px] mx-auto centered page",
        "Header: add page title ('Kumo Streaming Demo') and subtitle, with dark mode toggle button top-right",
        "Dark mode toggle: implement light/dark theme switching via data-mode attribute on a wrapper element",
        "Preset pills: style as rounded pill buttons (border-radius full, smaller text) matching HTML version",
        "Controls row: input + Generate/Stop/Reset buttons in a single horizontal row matching HTML styling",
        "Status text: add 'Generating UI...' / 'Done.' / 'Error: ...' status line above conversation area",
        "Action log panel: move below conversation area (not side-by-side), match HTML panel styling with header bar and monospace log",
        "Conversation area: scrollable with max-height, user bubbles right-aligned, assistant snapshots with border",
        "Overall visual parity with cross-boundary.html verified by side-by-side comparison"
      ],
      "passes": false
    }
  ],
  "context": {
    "patterns": [
      "StatefulWrapper pattern: src/core/stateful-wrappers.tsx",
      "Action→Patch bridge: src/core/action-patch-bridge.ts",
      "UITree rendering: src/core/UITreeRenderer.tsx",
      "Cross-boundary UMD: src/loadable/index.ts + vite.loadable.config.ts",
      "Vite entry points: packages/kumo/vite.config.ts",
      "Component map: src/core/component-map.ts"
    ],
    "keyFiles": [
      "src/core/UITreeRenderer.tsx",
      "src/core/action-patch-bridge.ts",
      "src/app/ChatDemo.tsx",
      "src/core/system-prompt.ts",
      "server/index.ts",
      "public/cross-boundary.html",
      "packages/kumo/vite.config.ts",
      "packages/kumo/package.json",
      "pnpm-workspace.yaml",
      "_examples/GENERATIVE-UI.md"
    ],
    "nonGoals": [
      "OAuth/social login",
      "Async action handlers",
      ".well-known convention in kumo main package",
      "Schema endpoint in generative-ui.json discovery"
    ]
  }
}
