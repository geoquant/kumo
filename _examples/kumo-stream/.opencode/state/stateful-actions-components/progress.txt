# Progress Log
PRD: stateful-actions-components
Started: 2026-02-19

## Codebase Patterns
- **BRANCH: `geoquant/streaming-ui`** — ALL work for this PRD goes on this branch. Do NOT create new branches. `git checkout geoquant/streaming-ui` before any work.
- **Stateful wrapper onAction**: `OnActionCallback = (context?: Record<string, unknown>) => void` — wrappers call `onAction?.({ value/checked/open: next })` on state change
- **Action type**: `Action { name, params?: Record<string, DynamicValue>, confirm?, onSuccess?, onError? }` from `@cloudflare/kumo/catalog`
- **DynamicValue resolution deferred**: params passed as-is (no path resolution in v1)
- **Test pattern**: vitest + happy-dom, relative imports from `../core/`, `vi.fn()` for mocks
- **Optional field elision**: use `...(val != null ? { key: val } : undefined)` to omit undefined keys entirely from event objects
- **Spy component for renderer tests**: inject a SpyComponent into COMPONENT_MAP, use `data-spy-key` prop + `capturedPropsMap` to assert per-element props. Clean up in afterEach.
- **Hook options pattern**: `useUITree(options?: UseUITreeOptions)` — options object for extensibility. Pass-through values (like `onAction`) returned alongside state so consumers wire them to renderers.
- **Module-level Set + test cleanup**: for pub/sub patterns with module-level state (e.g. subscriber Set), export a `_clear*()` function for test cleanup in afterEach. Vitest reuses module state across tests.
- **Dual-React in tests**: kumo `dist/` components can't render in test env (bundled React ≠ test React). Test COMPONENT_MAP wiring by asserting no `.text-kumo-warning` (Unknown component), not by full DOM rendering.

---

## Task - functional-1
- **Implemented**: `ActionEvent` interface and `createActionHandler` factory in `src/core/action-handler.ts`
- **Files changed**:
  - `src/core/action-handler.ts` (new) — ActionEvent type, ActionDispatch type, createActionHandler factory
  - `src/__tests__/action-handler.test.ts` (new) — 6 unit tests covering dispatch, params merge, context passthrough, optional field elision
- **Learnings**: Action.params uses DynamicValue but renderer passes through raw — future task may resolve paths. The spread pattern `...(x != null ? { k: x } : undefined)` cleanly omits optional keys without `if` branching.

## Task - functional-2
- **Implemented**: UITreeRenderer reads `element.action` and injects `onAction` prop via `createActionHandler`
- **Files changed**:
  - `src/core/UITreeRenderer.tsx` (modified) — added `onAction?: ActionDispatch` to `UITreeRendererProps`, threaded through `RenderElement` recursion (Div branch + component branch), inject `onAction` handler when `element.action != null && onAction != null`
  - `src/__tests__/ui-tree-renderer-action.test.tsx` (new) — 6 tests: injection when action present, no injection when absent, no injection when dispatch omitted, prop preservation, correct ActionEvent dispatch, nested child threading
- **Learnings**: Testing React component prop injection requires a Spy component pattern — register a spy in COMPONENT_MAP, capture props per-key via `data-spy-key` to distinguish multiple instances in a tree. `@testing-library/react` works with happy-dom env despite LSP not resolving types.

## Task - functional-3
- **Implemented**: `useUITree` hook accepts optional `onAction` callback via options object and surfaces it in return value for threading to `UITreeRenderer`
- **Files changed**:
  - `src/core/hooks.ts` (modified) — added `UseUITreeOptions` interface with optional `onAction: ActionDispatch`, `useUITree` now accepts `options?` param, `UseUITreeReturn` includes `onAction` field (pass-through)
  - `src/__tests__/use-ui-tree-on-action.test.tsx` (new) — 6 tests: onAction returned from options, undefined when omitted, undefined when empty options, existing return unaffected, full integration test (hook → renderer → spy component → dispatch), no-onAction integration
- **Learnings**: Hook is a pure state manager — it doesn't own the render, so `onAction` is a pass-through rather than internally consumed. Integration tests using a wrapper component that renders both `useUITree` and `UITreeRenderer` together are the most thorough way to verify end-to-end wiring. `renderHook` from `@testing-library/react` available for unit-level hook tests.

## Task - functional-4
- **Implemented**: Cross-boundary UMD API action dispatch with pub/sub + CustomEvent
- **Files changed**:
  - `src/loadable/action-dispatch.ts` (new) — subscriber Set, `dispatch()` fans out to all handlers + fires `CustomEvent('kumo-action')` on window, `onAction()` returns unsubscribe fn, SSR guard on CustomEvent, error isolation per handler
  - `src/loadable/index.ts` (modified) — import `dispatchAction`/`onAction`, pass `dispatchAction` as `onAction` to `UITreeRenderer` in both `renderContainer` and `renderTree`, add `onAction` to `CloudflareKumoAPI` interface + `api` object
  - `src/__tests__/action-dispatch.test.ts` (new) — 10 tests: subscribe/receive, unsubscribe stops delivery, multi-subscriber fanout, selective unsubscribe, error isolation, CustomEvent fire, detail with params/context, detail without optional fields, no-subscriber safety, CustomEvent fires without subscribers
- **Learnings**: Separate action dispatch module from loadable/index.ts keeps each file focused. `_clearSubscribers()` test utility needed since module-level Set persists across tests in vitest. Error isolation via try/catch per handler prevents one bad subscriber from blocking others. Optional field elision pattern reused from action-handler for CustomEvent detail.

## Task - functional-5
- **Implemented**: Textarea (InputArea) added to COMPONENT_MAP; RadioGroup, RadioItem, Collapsible verified as already present
- **Files changed**:
  - `src/core/component-map.ts` (modified) — added `InputArea` import, `Textarea: InputArea` entry in uncontrolled section; removed unused `Select` import (pre-existing lint fix)
  - `src/__tests__/component-map-new-entries.test.tsx` (new) — 10 tests: KNOWN_TYPES includes RadioGroup/RadioItem/Textarea/Collapsible; COMPONENT_MAP entries defined; UITreeRenderer resolves RadioGroup+RadioItem and Textarea types (no "Unknown component" error)
- **Learnings**: RadioGroup/RadioItem were already in COMPONENT_MAP from a prior task. Kumo `dist/` components fail to render in tests due to dual-React issue (bundled vs test env) — error boundary catches gracefully. Test rendering by asserting no "Unknown component" warning (`.text-kumo-warning`) rather than full DOM output. `forwardRef` components have `typeof === 'object'` not `'function'`.

## Task - functional-6
- **Implemented**: System prompt updated with action field docs, new component docs, and worked example
- **Files changed**:
  - `src/core/system-prompt.ts` (modified) — added "Action Field (Interactive Events)" section with format, supported components, rules; added RadioGroup/RadioItem, Textarea, Collapsible to Interactive section; added Example 4 (notification preferences form with Select + Checkbox + Button actions)
- **Learnings**: System prompt is a pure string template — no type or runtime implications. Changes only affect LLM output quality. The worked example demonstrates action field on Select, Checkbox, and Button simultaneously, which is the most common real-world pattern (form with interactive controls + submit).
