# Progress Log
PRD: stateful-actions-components
Started: 2026-02-19

## Codebase Patterns
- **BRANCH: `geoquant/streaming-ui`** — ALL work for this PRD goes on this branch. Do NOT create new branches. `git checkout geoquant/streaming-ui` before any work.
- **Stateful wrapper onAction**: `OnActionCallback = (context?: Record<string, unknown>) => void` — wrappers call `onAction?.({ value/checked/open: next })` on state change
- **Action type**: `Action { name, params?: Record<string, DynamicValue>, confirm?, onSuccess?, onError? }` from `@cloudflare/kumo/catalog`
- **DynamicValue resolution deferred**: params passed as-is (no path resolution in v1)
- **Test pattern**: vitest + happy-dom, relative imports from `../core/`, `vi.fn()` for mocks
- **Optional field elision**: use `...(val != null ? { key: val } : undefined)` to omit undefined keys entirely from event objects
- **Spy component for renderer tests**: inject a SpyComponent into COMPONENT_MAP, use `data-spy-key` prop + `capturedPropsMap` to assert per-element props. Clean up in afterEach.
- **Hook options pattern**: `useUITree(options?: UseUITreeOptions)` — options object for extensibility. Pass-through values (like `onAction`) returned alongside state so consumers wire them to renderers.
- **Module-level Set + test cleanup**: for pub/sub patterns with module-level state (e.g. subscriber Set), export a `_clear*()` function for test cleanup in afterEach. Vitest reuses module state across tests.
- **Dual-React in tests**: kumo `dist/` components can't render in test env (bundled React ≠ test React). Test COMPONENT_MAP wiring by asserting no `.text-kumo-warning` (Unknown component), not by full DOM rendering.
- **Mock kumo components for wrapper tests**: `vi.mock("@cloudflare/kumo")` with test doubles that expose onChange callbacks via trigger buttons + `data-*` attributes for state assertion. See `stateful-wrappers.test.tsx`.

---

## Task - functional-1
- **Implemented**: `ActionEvent` interface and `createActionHandler` factory in `src/core/action-handler.ts`
- **Files changed**:
  - `src/core/action-handler.ts` (new) — ActionEvent type, ActionDispatch type, createActionHandler factory
  - `src/__tests__/action-handler.test.ts` (new) — 6 unit tests covering dispatch, params merge, context passthrough, optional field elision
- **Learnings**: Action.params uses DynamicValue but renderer passes through raw — future task may resolve paths. The spread pattern `...(x != null ? { k: x } : undefined)` cleanly omits optional keys without `if` branching.

## Task - functional-2
- **Implemented**: UITreeRenderer reads `element.action` and injects `onAction` prop via `createActionHandler`
- **Files changed**:
  - `src/core/UITreeRenderer.tsx` (modified) — added `onAction?: ActionDispatch` to `UITreeRendererProps`, threaded through `RenderElement` recursion (Div branch + component branch), inject `onAction` handler when `element.action != null && onAction != null`
  - `src/__tests__/ui-tree-renderer-action.test.tsx` (new) — 6 tests: injection when action present, no injection when absent, no injection when dispatch omitted, prop preservation, correct ActionEvent dispatch, nested child threading
- **Learnings**: Testing React component prop injection requires a Spy component pattern — register a spy in COMPONENT_MAP, capture props per-key via `data-spy-key` to distinguish multiple instances in a tree. `@testing-library/react` works with happy-dom env despite LSP not resolving types.

## Task - functional-3
- **Implemented**: `useUITree` hook accepts optional `onAction` callback via options object and surfaces it in return value for threading to `UITreeRenderer`
- **Files changed**:
  - `src/core/hooks.ts` (modified) — added `UseUITreeOptions` interface with optional `onAction: ActionDispatch`, `useUITree` now accepts `options?` param, `UseUITreeReturn` includes `onAction` field (pass-through)
  - `src/__tests__/use-ui-tree-on-action.test.tsx` (new) — 6 tests: onAction returned from options, undefined when omitted, undefined when empty options, existing return unaffected, full integration test (hook → renderer → spy component → dispatch), no-onAction integration
- **Learnings**: Hook is a pure state manager — it doesn't own the render, so `onAction` is a pass-through rather than internally consumed. Integration tests using a wrapper component that renders both `useUITree` and `UITreeRenderer` together are the most thorough way to verify end-to-end wiring. `renderHook` from `@testing-library/react` available for unit-level hook tests.

## Task - functional-4
- **Implemented**: Cross-boundary UMD API action dispatch with pub/sub + CustomEvent
- **Files changed**:
  - `src/loadable/action-dispatch.ts` (new) — subscriber Set, `dispatch()` fans out to all handlers + fires `CustomEvent('kumo-action')` on window, `onAction()` returns unsubscribe fn, SSR guard on CustomEvent, error isolation per handler
  - `src/loadable/index.ts` (modified) — import `dispatchAction`/`onAction`, pass `dispatchAction` as `onAction` to `UITreeRenderer` in both `renderContainer` and `renderTree`, add `onAction` to `CloudflareKumoAPI` interface + `api` object
  - `src/__tests__/action-dispatch.test.ts` (new) — 10 tests: subscribe/receive, unsubscribe stops delivery, multi-subscriber fanout, selective unsubscribe, error isolation, CustomEvent fire, detail with params/context, detail without optional fields, no-subscriber safety, CustomEvent fires without subscribers
- **Learnings**: Separate action dispatch module from loadable/index.ts keeps each file focused. `_clearSubscribers()` test utility needed since module-level Set persists across tests in vitest. Error isolation via try/catch per handler prevents one bad subscriber from blocking others. Optional field elision pattern reused from action-handler for CustomEvent detail.

## Task - functional-5
- **Implemented**: Textarea (InputArea) added to COMPONENT_MAP; RadioGroup, RadioItem, Collapsible verified as already present
- **Files changed**:
  - `src/core/component-map.ts` (modified) — added `InputArea` import, `Textarea: InputArea` entry in uncontrolled section; removed unused `Select` import (pre-existing lint fix)
  - `src/__tests__/component-map-new-entries.test.tsx` (new) — 10 tests: KNOWN_TYPES includes RadioGroup/RadioItem/Textarea/Collapsible; COMPONENT_MAP entries defined; UITreeRenderer resolves RadioGroup+RadioItem and Textarea types (no "Unknown component" error)
- **Learnings**: RadioGroup/RadioItem were already in COMPONENT_MAP from a prior task. Kumo `dist/` components fail to render in tests due to dual-React issue (bundled vs test env) — error boundary catches gracefully. Test rendering by asserting no "Unknown component" warning (`.text-kumo-warning`) rather than full DOM output. `forwardRef` components have `typeof === 'object'` not `'function'`.

## Task - functional-6
- **Implemented**: System prompt updated with action field docs, new component docs, and worked example
- **Files changed**:
  - `src/core/system-prompt.ts` (modified) — added "Action Field (Interactive Events)" section with format, supported components, rules; added RadioGroup/RadioItem, Textarea, Collapsible to Interactive section; added Example 4 (notification preferences form with Select + Checkbox + Button actions)
- **Learnings**: System prompt is a pure string template — no type or runtime implications. Changes only affect LLM output quality. The worked example demonstrates action field on Select, Checkbox, and Button simultaneously, which is the most common real-world pattern (form with interactive controls + submit).

## Task - functional-7
- **Implemented**: Action event log panel in cross-boundary demo
- **Files changed**:
  - `public/cross-boundary.html` (modified) — added "Action Events" log panel with dark mode support, `kumo-action` CustomEvent listener that renders timestamped entries with actionName/sourceKey/params/context, clear button, auto-scroll, empty state placeholder, XSS-safe via `escapeHtml()` using DOM text node
- **Learnings**: Button styles in the page are scoped to `.controls button` and `.header button` — the log panel's clear button needed its own `.action-log-header button` rules to avoid inheriting kumo container Tailwind resets. `CustomEvent.detail` carries the same shape as ActionEvent but without TS types — the log formatter handles optional params/context gracefully.

## Task - testing-1
- **Implemented**: Verified existing unit tests for action handler factory (written during functional-1) cover all PRD steps
- **Files changed**: None — tests already existed in `src/__tests__/action-handler.test.ts` with 6 passing tests
- **Verification**: `vitest run` passes all 6 tests, `tsc --noEmit` clean
- **Learnings**: Tests were written alongside implementation in functional-1 but PRD task wasn't marked passing. Always mark testing tasks when tests are written proactively.

## Task - testing-2
- **Implemented**: Unit tests for all 5 stateful wrappers with onAction integration
- **Files changed**:
  - `src/__tests__/stateful-wrappers.test.tsx` (new) — 12 tests across 5 describe blocks: StatefulSelect (3), StatefulCheckbox (2), StatefulSwitch (2), StatefulTabs (3), StatefulCollapsible (2)
- **Strategy**: `vi.mock("@cloudflare/kumo")` replaces kumo components with minimal test doubles that expose onChange callbacks via DOM buttons + display controlled values via `data-*` attributes. Avoids dual-React issue entirely.
- **Learnings**: Mocking the component library is cleaner than fighting the dual-React bundling issue. Each mock renders a trigger button that fires the onChange with a predictable value, and a `data-*` attribute for asserting current state. This pattern is reusable for any test that needs to verify wrapper behavior without rendering real kumo components.

## Task - testing-3
- **Implemented**: Integration tests for streaming form with action dispatch — 6 tests across 3 describe blocks
- **Files changed**:
  - `src/__tests__/streaming-action-integration.test.tsx` (new) — 6 tests:
    1. Form tree with 3 action elements: all dispatch correct ActionEvents with actionName, sourceKey, params, context
    2. sourceKey matches UIElement key (not spy key) — verifies handler binding
    3. Elements without action field get no onAction handler
    4. `streaming=true`: present elements dispatch actions while missing ones render as null
    5. `streaming=true` + rerender: newly arrived elements get action handlers on next render
    6. `streaming=false`: shows "Missing element" error but present element actions still work
- **Strategy**: Spy component pattern (same as ui-tree-renderer-action tests) + `triggerAction()` helper that invokes captured onAction handler by spy key. Simulates streaming by omitting elements from the tree then re-rendering with them added.
- **Learnings**: `rerender()` from `@testing-library/react` is key for testing streaming — re-render with an updated tree that has new elements. Must clear `capturedPropsMap` before rerender to get fresh captures. The `streaming` prop only affects missing element rendering (null vs error div) — action dispatch works identically in both modes.

## Task - testing-4
- **Implemented**: Verified all 163 tests pass across 12 test files — zero regressions
- **Files changed**: None — verification only
- **Results**: rfc6902 (27), jsonl-parser (21), regression (40), streaming-integration (8), loadable-css (11), action-handler (6), action-dispatch (10), component-map-new-entries (10), stateful-wrappers (12), ui-tree-renderer-action (6), use-ui-tree-on-action (6), streaming-action-integration (6). `tsc --noEmit` clean.
- **Learnings**: The dual-React stderr warnings in component-map-new-entries are expected (bundled vs test React) — error boundary catches gracefully, tests pass. Total test count grew from ~107 to 163 due to new test files added in testing-1 through testing-3.

## Task - validation-1
- **Implemented**: Verified UMD bundle size under 500KB limit
- **Results**: `vite build --config vite.loadable.config.ts` produces `dist/loadable/component-loadable.umd.js` at **419.51 KB** (gzip: 134.74 KB), CSS at 71.80 KB (gzip: 13.07 KB)
- **Verification**: `tsc --noEmit` clean, 163/163 tests pass, build succeeds
- **Files changed**: None — validation only
- **Learnings**: Bundle includes all stateful wrappers, action dispatch, component map additions, and system prompt changes from prior tasks and still comfortably fits under 500KB. The ~80KB headroom leaves room for future component additions.
