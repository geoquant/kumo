{
  "prdName": "stateful-actions-components",
  "tasks": [
    {
      "id": "functional-1",
      "category": "functional",
      "description": "ActionEvent type and createActionHandler factory exist in src/core/action-handler.ts",
      "steps": [
        "ActionEvent interface exported from action-handler.ts with fields: actionName (string), sourceKey (string), params (optional Record<string, unknown>), context (optional Record<string, unknown>)",
        "createActionHandler(action, sourceKey, dispatch) returns a function that calls dispatch with well-formed ActionEvent",
        "Factory merges action.params into the event",
        "Factory passes through context from the wrapper's onAction call",
        "TypeScript compiles with no errors — no `any`, no type assertions"
      ],
      "passes": true
    },
    {
      "id": "functional-2",
      "category": "functional",
      "description": "UITreeRenderer reads element.action and injects onAction prop into components",
      "steps": [
        "RenderElement reads element.action from UIElement",
        "When element.action exists, creates handler via createActionHandler and passes as onAction prop",
        "When element.action is undefined, no onAction prop is injected",
        "Existing prop spreading unchanged — onAction is additive",
        "Render a tree with an element that has action field — verify onAction reaches the component"
      ],
      "passes": true
    },
    {
      "id": "functional-3",
      "category": "functional",
      "description": "useUITree hook accepts onAction callback and wires it through the render pipeline",
      "steps": [
        "useUITree accepts optional onAction parameter in its options",
        "onAction callback is passed through to UITreeRenderer",
        "When a component triggers onAction, the callback fires with ActionEvent payload",
        "Omitting onAction still works (no errors, no changes to existing behavior)"
      ],
      "passes": true
    },
    {
      "id": "functional-4",
      "category": "functional",
      "description": "Cross-boundary UMD API exposes onAction subscription and dispatches CustomEvent",
      "steps": [
        "CloudflareKumo.onAction(handler) registers a callback",
        "onAction returns an unsubscribe function",
        "Calling unsubscribe stops delivery to that handler",
        "Multiple subscribers each receive the same ActionEvent",
        "window.dispatchEvent(new CustomEvent('kumo-action', { detail })) fires on every action",
        "CustomEvent detail contains actionName, sourceKey, params, context",
        "Guard: typeof window !== 'undefined' check prevents SSR errors"
      ],
      "passes": false
    },
    {
      "id": "functional-5",
      "category": "functional",
      "description": "RadioGroup, RadioItem, and Textarea added to COMPONENT_MAP",
      "steps": [
        "RadioGroup maps to Radio.Group in component-map.ts",
        "RadioItem maps to Radio.Item in component-map.ts",
        "Textarea maps to InputArea (uncontrolled alias) in component-map.ts",
        "Collapsible already mapped to StatefulCollapsible — verify it exists",
        "KNOWN_TYPES set includes all new entries",
        "Rendering a tree with RadioGroup > RadioItem children produces working radio buttons",
        "Rendering a tree with Textarea produces a working text area with defaultValue"
      ],
      "passes": false
    },
    {
      "id": "functional-6",
      "category": "functional",
      "description": "System prompt teaches LLM about action fields and new components",
      "steps": [
        "system-prompt.ts documents action prop format: { \"action\": { \"name\": \"action_name\" } }",
        "Documents that interactive elements can trigger named actions via action field",
        "Includes worked example: form with Select + Checkbox + Button where Button has submit action",
        "Documents Radio.Group + Radio.Item component pattern with props",
        "Documents Textarea as alias for InputArea",
        "Documents Collapsible component with open/defaultOpen props"
      ],
      "passes": false
    },
    {
      "id": "functional-7",
      "category": "functional",
      "description": "Cross-boundary demo shows interactive forms with action event logging",
      "steps": [
        "public/cross-boundary.html has a visible action event log panel",
        "Demo registers a kumo-action event listener that appends to the log panel",
        "Generating a form produces interactive components (Select, Checkbox, Switch)",
        "Interacting with components shows action events in the log panel",
        "Dark mode toggle still works",
        "Existing button styling still correct"
      ],
      "passes": false
    },
    {
      "id": "testing-1",
      "category": "testing",
      "description": "Unit tests for action handler factory",
      "steps": [
        "Test: createActionHandler calls dispatch with correct actionName and sourceKey",
        "Test: createActionHandler includes action.params in the event",
        "Test: createActionHandler passes through context from wrapper call",
        "Test: handler works with no params and no context (both optional)",
        "All tests pass via vitest run"
      ],
      "passes": false
    },
    {
      "id": "testing-2",
      "category": "testing",
      "description": "Unit tests for stateful wrappers with onAction integration",
      "steps": [
        "Test: StatefulSelect renders, holds selection, calls onAction with { value }",
        "Test: StatefulCheckbox toggles, calls onAction with { checked }",
        "Test: StatefulSwitch flips, calls onAction with { checked }",
        "Test: StatefulTabs switches panels, calls onAction with { value }",
        "Test: StatefulCollapsible opens/closes, calls onAction with { open }",
        "All tests pass via vitest run"
      ],
      "passes": false
    },
    {
      "id": "testing-3",
      "category": "testing",
      "description": "Integration test: streaming form with action dispatch",
      "steps": [
        "Test: render a UITree with a form containing elements with action fields",
        "Test: simulate user interaction (e.g. button click) and verify ActionEvent dispatched",
        "Test: verify action dispatch works during streaming (streaming=true)",
        "All tests pass via vitest run"
      ],
      "passes": false
    },
    {
      "id": "testing-4",
      "category": "testing",
      "description": "All existing tests still pass — no regressions",
      "steps": [
        "Run vitest run in _examples/kumo-stream/",
        "All ~107 existing tests pass",
        "No new test failures in rfc6902, jsonl-parser, regression, streaming-integration, loadable-css"
      ],
      "passes": false
    },
    {
      "id": "validation-1",
      "category": "validation",
      "description": "UMD bundle size remains under 500KB",
      "steps": [
        "Run build:loadable in _examples/kumo-stream/",
        "Check dist/loadable/component-loadable.umd.js size",
        "Size is under 500KB"
      ],
      "passes": false
    }
  ],
  "branch": "geoquant/streaming-ui",
  "context": {
    "patterns": [
      "Stateful wrapper pattern: src/core/stateful-wrappers.tsx — useState bridge + onAction callback",
      "Component map: src/core/component-map.ts — string type → React component mapping",
      "Prop spreading: UITreeRenderer.tsx — element.props spread onto component, onAction injected alongside",
      "Catalog types: @cloudflare/kumo/catalog — Action, ActionHandler, UIElement.action defined",
      "UMD loadable API: src/loadable/index.ts — window.CloudflareKumo with applyPatch, renderTree, etc."
    ],
    "keyFiles": [
      "src/core/stateful-wrappers.tsx",
      "src/core/component-map.ts",
      "src/core/UITreeRenderer.tsx",
      "src/core/types.ts",
      "src/core/hooks.ts",
      "src/core/system-prompt.ts",
      "src/loadable/index.ts",
      "public/cross-boundary.html",
      "packages/kumo/src/catalog/types.ts"
    ],
    "nonGoals": [
      "Data binding / DynamicValue path resolution",
      "VisibilityCondition evaluation",
      "Multi-provider LLM support",
      "Portalled components (Dialog, Popover, Toast)",
      "MCP server",
      "Additional layout primitives beyond Stack/Cluster",
      "Combobox stateful wrapper",
      "ActionConfirm dialog support"
    ]
  }
}
