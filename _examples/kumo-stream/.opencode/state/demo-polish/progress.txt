# Progress Log
PRD: demo-polish
Started: 2026-02-19
**Branch: `geoquant/streaming-ui`** — all work lives here. Do NOT create a separate branch.

## Codebase Patterns
- App shell: `src/app/App.tsx` wraps `<ChatDemo />` inside `kumo-root` div with `data-mode`
- Dark mode: `data-mode="light"|"dark"` on root wrapper; Kumo tokens auto-adapt via `light-dark()`
- Kumo `Button` with `variant="outline" size="sm"` for chrome controls (dark mode toggle)
- Plain HTML (`h1`, `p`) for non-interactive text; Kumo `Text` only in component rendering
- ChatDemo controls: `flex gap-2` form, Input `flex-1`, action buttons inline
- Pre-existing lint false positives: `UITreeRenderer.tsx` lines 65/162 (semantic tokens misdetected as raw colors)
- UITree is plain data (`{ root: string, elements: Record<string, UIElement> }`), safe to `structuredClone` for snapshots
- `AssistantSnapshot` renders read-only past turns by omitting `onAction` from `UITreeRenderer`
- `ChatHistoryEntry` discriminated union: `role: "user"` has `content`, `role: "assistant"` has `tree`
- HTML/UMD history: deferred-push pattern — current user message tracked via `lastUserMessage`, archived to `chatHistory` on next turn (avoids duplication with server's `message` field)
- `pointer-events: none` on `.history-assistant-snapshot` to disable interaction in vanilla JS history

---

## Task - ui-1
- Restyled App.tsx to match cross-boundary.html layout
- Container: `max-w-[960px] p-8 px-6` (was `max-w-4xl p-8`)
- Header: flex row with h1 (text-xl font-semibold) + dark mode toggle (Kumo Button outline/sm)
- Subtitle: plain `<p>` with `text-[13px] opacity-60` (was Kumo `Text variant="secondary"`)
- Dark mode: `useState` toggle, sets `data-mode` on root wrapper
- Removed Kumo `Text` import from App.tsx (no longer needed)
- Files changed: `src/app/App.tsx`
- **Learnings:** ChatDemo controls already matched target layout (flex gap-2, Input flex-1). Only App.tsx shell needed restyling.

## Task - ui-2
- Added scrollable conversation history to React SPA
- `ChatHistoryEntry` discriminated union type for user/assistant turns
- `handleSubmit` snapshots current tree (if renderable) + user prompt into `chatHistory` before resetting
- `ChatHistoryView` renders history: `UserBubble` (right-aligned, `bg-kumo-brand-subtle`) and `AssistantSnapshot` (rendered UITree, no `onAction`)
- Scrollable container: `max-h-[70vh] overflow-y-auto` with `useEffect` auto-scroll on `[chatHistory, tree]`
- `handleReset` clears `chatHistory` alongside messages/tree
- Separator `<hr>` between history and current turn when both exist
- Files changed: `src/app/ChatDemo.tsx`
- **Learnings:** `structuredClone(tree)` works perfectly for UITree snapshots since it's plain data. Omitting `onAction` from `UITreeRenderer` is sufficient to make past turns non-interactive — no special prop needed.

## Task - ui-3
- Added scrollable conversation history + multi-turn to HTML/UMD demo
- New DOM structure: `#conversation-area` wraps `#chat-history` + `#kumo-container` with `max-height: 70vh; overflow-y: auto`
- `snapshotToHistory(msg)` archives previous turn's user+assistant pair into both DOM and `chatHistory` array
- User bubbles: `history-user-bubble` (right-aligned, orange-tinted bg); Assistant: `history-assistant-snapshot` (border, `pointer-events: none` for non-interactive)
- History separator `<hr>` between past turns and active container
- `chatHistory` array sent with each `/api/chat` request via `history` field for multi-turn
- Deferred history tracking: current user message tracked via `lastUserMessage`, pushed to `chatHistory` on *next* turn to avoid duplication (server already appends current `message`)
- Reset clears both `chatHistory = []` and `chatHistoryEl.innerHTML = ""`
- `scrollConversation()` called on new patches and completion
- Files changed: `public/cross-boundary.html`
- **Learnings:** Server appends current `message` to the messages array after iterating `history`, so `chatHistory` must NOT include the current user message — only previous turns. Using `lastUserMessage` + deferred push pattern avoids duplication. `pointer-events: none` on snapshot divs is simpler than removing event listeners for making past turns non-interactive in vanilla JS.

## Task - ui-4
- Ported preset prompt pill buttons to HTML/UMD demo
- CSS: `.presets` container (flex-wrap, gap-8px) between header and controls; pill buttons with `border-radius: 16px`, outline style, hover highlights border orange
- HTML: `<div id="presets" class="presets"></div>` between header and controls
- JS: `PRESET_PROMPTS` array matches React SPA list (7 presets); buttons created via `forEach` + `createElement`; click triggers `streamChat(text)` directly
- `setStreaming()` updated to disable/enable all preset buttons during streaming
- Dark mode styles applied via `body[data-mode="dark"] .presets button`
- Files changed: `public/cross-boundary.html`
- **Learnings:** Scoping page button styles (`.controls button`, `.header button`) was already established to avoid leaking into `#kumo-container` Tailwind classes. `.presets button` follows same pattern. Dynamic DOM creation via `forEach` + `createElement` is idiomatic for the IIFE vanilla JS style used throughout.
