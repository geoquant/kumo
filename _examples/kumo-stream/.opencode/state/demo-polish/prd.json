{
  "prdName": "demo-polish",
  "tasks": [
    {
      "id": "ui-1",
      "category": "ui",
      "description": "Restyle App.tsx and ChatDemo.tsx to match cross-boundary.html: full-width 960px layout, header bar with dark mode toggle, horizontal controls toolbar",
      "steps": [
        "App.tsx uses max-w-[960px] container with p-8 px-6",
        "Header is flex row: title left (20px semibold h1) + dark mode toggle right",
        "Subtitle is muted text (not Kumo Text component)",
        "Controls bar is horizontal flex gap-2: Input fills space, Generate/Stop/Reset in row",
        "Dark mode toggle sets data-mode on root wrapper and affects Kumo components",
        "Visual structure matches cross-boundary.html layout"
      ],
      "passes": true
    },
    {
      "id": "ui-2",
      "category": "ui",
      "description": "Add scrollable conversation history to React SPA with user prompt bubbles and rendered UITree responses",
      "steps": [
        "ChatHistory state tracks array of { role, content, tree? } entries",
        "On completed response, user message + UITree snapshot pushed to history",
        "History renders as scrollable list above current streaming response",
        "User messages show as right-aligned bubble with muted background",
        "Assistant responses show as rendered UITree (read-only, non-interactive)",
        "Auto-scrolls to bottom on new messages",
        "Reset clears all history",
        "Previous turns' actions don't fire (only latest turn interactive)"
      ],
      "passes": true
    },
    {
      "id": "ui-3",
      "category": "ui",
      "description": "Add scrollable conversation history and multi-turn support to HTML/UMD demo",
      "steps": [
        "chatHistory array tracks conversation in IIFE state",
        "Before each streamChat(), current kumo-container innerHTML snapshotted",
        "On completion, snapshot + user prompt moved to history section above active container",
        "User messages render as styled divs; assistant responses as static HTML",
        "history array sent with each /api/chat request (multi-turn works)",
        "Reset clears history and history DOM"
      ],
      "passes": false
    },
    {
      "id": "ui-4",
      "category": "ui",
      "description": "Port preset prompt pill buttons to HTML/UMD demo",
      "steps": [
        ".presets container between header and controls",
        "Pill buttons for each preset including Counter (rounded, outline, border-radius 16px)",
        "Clicking a pill triggers streamChat() with preset text",
        "Pills disabled during streaming, re-enabled after",
        "Same list as React SPA presets"
      ],
      "passes": false
    },
    {
      "id": "ui-5",
      "category": "ui",
      "description": "Add action events panel to React SPA with 2-column layout and simulated POST lines",
      "steps": [
        "2-column layout: left 60-65% (chat), right 35-40% (action panel)",
        "ActionPanel component with header: Action Events + Clear button",
        "Scrollable monospace log area",
        "Each entry: timestamp + action name (orange) + source key + params/context",
        "Below each entry: faded -> POST /api/actions { ... } line",
        "Empty state text shown when no events",
        "Auto-scrolls to latest entry",
        "Clear and Reset both clear log",
        "Stacks vertically below md breakpoint"
      ],
      "passes": false
    },
    {
      "id": "functional-1",
      "category": "functional",
      "description": "Add data-key={element.key} attribute to rendered elements in UITreeRenderer for DOM identification",
      "steps": [
        "Each rendered element receives data-key attribute",
        "Attribute visible in DOM inspector",
        "HTML page can locate elements via document.querySelector('[data-key=\"count-display\"]')"
      ],
      "passes": false
    },
    {
      "id": "functional-2",
      "category": "functional",
      "description": "Add worked counter example to system-prompt.ts for reliable LLM counter generation",
      "steps": [
        "Example 5 — Stateful Counter section added to system prompt",
        "Example shows JSONL patches with action names 'increment'/'decrement'",
        "Example uses key 'count-display' for count text element",
        "LLM generates correct counter UI when given counter preset (test 3+ generations)"
      ],
      "passes": false
    },
    {
      "id": "functional-3",
      "category": "functional",
      "description": "Create action-to-patch bridge module mapping action events to UITree patches for known interaction patterns",
      "steps": [
        "src/core/action-patch-bridge.ts exports actionToPatch(event, tree) returning JsonPatchOp or null",
        "Returns replace op for increment: increments count-display text by 1",
        "Returns replace op for decrement: decrements count-display text by 1",
        "Returns null for unknown action names",
        "Handles missing count-display element gracefully (returns null)",
        "Handles non-numeric text gracefully (defaults to 0)"
      ],
      "passes": false
    },
    {
      "id": "functional-4",
      "category": "functional",
      "description": "Wire counter preset, onAction callback, and tree mutation into React SPA",
      "steps": [
        "Counter preset in PRESET_PROMPTS array",
        "ChatDemo passes onAction to useUITree",
        "onAction calls actionToPatch for increment/decrement",
        "Patch applied via applyPatches — count display updates",
        "Clicking + increments, clicking - decrements",
        "Actions during streaming logged but patches not applied"
      ],
      "passes": false
    },
    {
      "id": "functional-5",
      "category": "functional",
      "description": "Wire counter preset pill and inline DOM manipulation for count updates in HTML/UMD",
      "steps": [
        "Counter preset pill exists",
        "kumo-action listener checks for increment/decrement actionName",
        "Finds count element via document.querySelector('[data-key=\"count-display\"]')",
        "Parses textContent as integer, updates to current +/- 1",
        "Action still logged to action panel"
      ],
      "passes": false
    }
  ],
  "context": {
    "patterns": [
      "React SPA entry: src/app/main.tsx -> App.tsx -> ChatDemo.tsx",
      "HTML/UMD demo: public/cross-boundary.html (580 lines, inline CSS + JS)",
      "UMD API: CloudflareKumo.{createParser, applyPatch, reset, setTheme, onAction}",
      "Action dispatch: action-handler.ts -> ActionEvent via onAction callback",
      "Stateful wrappers: stateful-wrappers.tsx (Select, Checkbox, Switch, Tabs, Collapsible)",
      "Tree rendering: UITreeRenderer.tsx uses COMPONENT_MAP from component-map.ts",
      "Patch engine: rfc6902.ts handles add/replace/remove ops on UITree (immutable)",
      "Server SSE: server/index.ts POST /api/chat accepts { message, history? }"
    ],
    "keyFiles": [
      "src/app/App.tsx",
      "src/app/ChatDemo.tsx",
      "public/cross-boundary.html",
      "src/core/UITreeRenderer.tsx",
      "src/core/hooks.ts",
      "src/core/action-handler.ts",
      "src/core/system-prompt.ts",
      "src/core/rfc6902.ts",
      "src/core/types.ts",
      "server/index.ts"
    ],
    "nonGoals": [
      "localStorage persistence of chat history",
      "Actual external service integration (log/simulation only)",
      "New Kumo components or modifications to packages/kumo/",
      "Combobox stateful wrapper",
      "Changes outside geoquant/streaming-ui branch"
    ]
  }
}
