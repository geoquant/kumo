{
  "prdName": "streaming-patches",
  "tasks": [
    {
      "id": "core-1",
      "category": "core",
      "description": "RFC 6902 patch application function that applies add/replace/remove operations to a Spec (UITree) using JSON Pointer paths",
      "steps": [
        "src/core/rfc6902.ts exists with applyPatch(spec, patch) and parsePatchLine(line) exports",
        "applyPatch with op:add to /root sets the root field",
        "applyPatch with op:add to /elements/{key} adds an element to the elements map",
        "applyPatch with op:add using /- suffix appends to an array (e.g. /elements/card/children/-)",
        "applyPatch with op:replace overwrites an existing value at path",
        "applyPatch with op:remove deletes the value at path",
        "applyPatch on nonexistent path for remove is a no-op (no throw)",
        "applyPatch returns a new shallow copy of Spec on every call (never mutates input)",
        "parsePatchLine returns null for invalid JSON or missing op/path fields",
        "Only add/replace/remove ops supported — no move/copy/test"
      ],
      "passes": true
    },
    {
      "id": "core-2",
      "category": "core",
      "description": "JSONL line parser that accumulates text chunks, splits on newlines, and returns parsed JsonPatchOp arrays",
      "steps": [
        "src/core/jsonl-parser.ts exists with createJsonlParser() export returning { push, flush }",
        "push(chunk) with a single complete line (ending in \\n) returns one JsonPatchOp",
        "push(chunk) with multiple lines in one chunk returns multiple JsonPatchOps",
        "push(chunk) with a line split across two chunks buffers the first, returns parsed on second",
        "Empty lines are skipped (not returned)",
        "Invalid JSON lines are silently skipped (not thrown)",
        "Lines starting with ``` (markdown fences) are silently skipped",
        "flush() returns the buffered incomplete line as a parsed JsonPatchOp if valid"
      ],
      "passes": true
    },
    {
      "id": "core-3",
      "category": "core",
      "description": "useUITree hook rewritten to accept RFC 6902 patches instead of custom UITreePatch, with batched applyPatches",
      "steps": [
        "src/core/hooks.ts exports useUITree() returning { tree, applyPatch, applyPatches, reset }",
        "applyPatch(patch: JsonPatchOp) applies a single patch and triggers re-render",
        "applyPatches(patches: JsonPatchOp[]) applies multiple patches in a single setState call",
        "reset() returns tree to empty state { root: '', elements: {} }",
        "No DataModel in the return type — data model is dropped",
        "Imports applyPatch from rfc6902.ts, not patches.ts"
      ],
      "passes": true
    },
    {
      "id": "core-4",
      "category": "core",
      "description": "System prompt rewritten to instruct LLM to emit JSONL patch lines instead of monolithic JSON",
      "steps": [
        "src/core/system-prompt.ts instructs LLM to respond with JSONL (one JSON Patch op per line)",
        "Prompt specifies: first line sets /root, subsequent lines add elements top-down",
        "Prompt specifies: parent elements include full children array upfront (Strategy A)",
        "Prompt specifies: one element per line, no markdown fences, no explanations",
        "Prompt includes 2-3 complete JSONL examples showing the wire format",
        "All existing component documentation, design rules, and anti-patterns are preserved"
      ],
      "passes": true
    },
    {
      "id": "functional-1",
      "category": "functional",
      "description": "ChatDemo.tsx wired to streaming pipeline: useUITree + JSONL parser replaces monolithic setTree",
      "steps": [
        "ChatDemo.tsx uses useUITree() hook instead of raw useState<UITree>",
        "ChatDemo.tsx creates a JSONL parser via createJsonlParser() per stream",
        "onText callback passes delta to parser.push(), applies returned patches via applyPatches",
        "onDone callback calls parser.flush() and applies remaining patches",
        "On new message or reset, calls reset() and creates a new parser instance",
        "extractUITree import removed from primary path (or demoted to fallback only)"
      ],
      "passes": true
    },
    {
      "id": "functional-2",
      "category": "functional",
      "description": "UITreeRenderer tolerates missing element keys during streaming by rendering nothing instead of error divs",
      "steps": [
        "During streaming, children array keys that reference nonexistent elements render as null (invisible)",
        "After streaming completes, missing keys can render as errors (existing behavior)",
        "Mechanism exists to distinguish streaming vs. complete state (prop or context)"
      ],
      "passes": true
    },
    {
      "id": "cleanup-1",
      "category": "cleanup",
      "description": "Delete custom patch system and its tests, replaced by RFC 6902",
      "steps": [
        "src/core/patches.ts is deleted",
        "src/__tests__/patches.test.ts is deleted",
        "No remaining imports of patches.ts anywhere in the codebase",
        "TypeScript compiles without errors after deletion"
      ],
      "passes": true
    },
    {
      "id": "testing-1",
      "category": "testing",
      "description": "RFC 6902 applyPatch unit tests covering all operations and edge cases",
      "steps": [
        "src/__tests__/rfc6902.test.ts exists",
        "Tests add to /root path",
        "Tests add element to /elements/{key}",
        "Tests add to array with /- suffix",
        "Tests replace existing value",
        "Tests remove element",
        "Tests no-op on remove of nonexistent path",
        "Tests invalid path handling",
        "Tests immutability (input not mutated)",
        "All tests pass via pnpm --filter kumo-stream test"
      ],
      "passes": true
    },
    {
      "id": "testing-2",
      "category": "testing",
      "description": "JSONL parser unit tests covering chunking, edge cases, and error tolerance",
      "steps": [
        "src/__tests__/jsonl-parser.test.ts exists",
        "Tests single complete line",
        "Tests multiple lines in one chunk",
        "Tests line split across chunks",
        "Tests empty lines skipped",
        "Tests invalid JSON skipped",
        "Tests markdown fence lines skipped",
        "Tests flush returns buffered incomplete line",
        "All tests pass via pnpm --filter kumo-stream test"
      ],
      "passes": true
    },
    {
      "id": "testing-3",
      "category": "testing",
      "description": "Streaming integration test simulating token-by-token JSONL delivery and verifying incremental tree growth",
      "steps": [
        "src/__tests__/streaming-integration.test.ts exists",
        "Simulates token-by-token delivery of a multi-line JSONL response",
        "Verifies tree grows incrementally (after N tokens, tree has M elements)",
        "Verifies final tree after all tokens matches expected UITree structure",
        "All tests pass via pnpm --filter kumo-stream test"
      ],
      "passes": true
    },
    {
      "id": "regression-1",
      "category": "regression",
      "description": "All existing functionality preserved: presets, multi-turn, stop, errors",
      "steps": [
        "All 7 preset prompts produce valid streaming UI (manual or automated test)",
        "Multi-turn conversation works (send prompt, get response, send another)",
        "Stop button halts streaming and partial UI remains visible",
        "Error states display correctly when API key missing or stream fails",
        "pnpm --filter kumo-stream test passes with zero failures"
      ],
      "passes": true
    },
    {
      "id": "cross-1",
      "category": "cross-boundary",
      "description": "UMD loadable entry point exposing window.CloudflareKumo with patch-aware rendering, JSONL parser, theme control, and tree reset",
      "steps": [
        "src/loadable/index.ts exists and assigns window.CloudflareKumo object",
        "CloudflareKumo.applyPatch(op, containerId) applies one RFC 6902 op to internal tree state and re-renders the container",
        "CloudflareKumo.applyPatches(ops, containerId) applies multiple ops in a single render pass",
        "CloudflareKumo.renderTree(tree, containerId) replaces entire tree wholesale (non-streaming use case)",
        "CloudflareKumo.createParser() returns a JsonlParser instance with push() and flush()",
        "CloudflareKumo.setTheme(mode) dispatches kumo-theme-change CustomEvent and sets data-mode on document.body",
        "CloudflareKumo.reset(containerId) clears tree state and unmounts the container",
        "Internal Map<containerId, UITree> tracks per-container tree state",
        "Internal Map<containerId, ReactRoot> reuses React roots (no destroy/recreate per render)",
        "React is bundled inside the UMD (not externalized)",
        "pnpm build:loadable succeeds and outputs to dist/loadable/"
      ],
      "passes": false
    },
    {
      "id": "cross-2",
      "category": "cross-boundary",
      "description": "ThemeWrapper component and theme support in UITreeRenderer — reactive light/dark mode via CustomEvent",
      "steps": [
        "src/loadable/theme.tsx exports ThemeWrapper component",
        "ThemeWrapper renders children inside <div data-mode={mode} className=\"kumo-root\">",
        "ThemeWrapper listens for kumo-theme-change CustomEvent on window and updates mode state",
        "setTheme() also sets data-mode on document.body for portalled elements (Select dropdowns, etc.)",
        "UITreeRenderer in loadable context is wrapped by ThemeWrapper (not hardcoded data-mode=\"light\")",
        "Theme change causes re-render of all rendered components in new mode"
      ],
      "passes": false
    },
    {
      "id": "cross-3",
      "category": "cross-boundary",
      "description": "Express proxy server that streams Anthropic responses as SSE, keeping API key server-side",
      "steps": [
        "server/index.ts exists with Express app",
        "POST /api/chat accepts { message: string, history?: Array<{role, content}> } JSON body",
        "Server reads ANTHROPIC_API_KEY from process.env (not VITE_ prefixed)",
        "Server imports SYSTEM_PROMPT from src/core/system-prompt.ts",
        "Server streams Anthropic text deltas as SSE: data: {\"type\":\"text\",\"delta\":\"...\"}\n\n",
        "Server sends data: {\"type\":\"done\"}\n\n on stream completion",
        "Server sends data: {\"type\":\"error\",\"message\":\"...\"}\n\n on failure",
        "CORS enabled for local development",
        "Server serves dist/loadable/ and public/ as static files",
        "package.json has \"serve\" script that starts the server",
        "express, cors, and dotenv added to devDependencies in package.json"
      ],
      "passes": false
    },
    {
      "id": "cross-4",
      "category": "cross-boundary",
      "description": "Plain HTML cross-boundary demo page that loads UMD bundle and renders streaming kumo components with zero React in the host",
      "steps": [
        "public/cross-boundary.html exists — plain HTML, no JSX, no build step",
        "Page loads dist/loadable/component-loadable.umd.js via <script> tag",
        "Page loads dist/loadable/style.css via <link> tag",
        "Page has a text input, Generate button, and theme toggle button",
        "Generate button POSTs to /api/chat and reads the SSE response stream",
        "Text deltas are fed to CloudflareKumo.createParser().push(delta)",
        "Parsed ops are applied via CloudflareKumo.applyPatch(op, 'container-id')",
        "Kumo components appear progressively inside a container div",
        "Theme toggle calls CloudflareKumo.setTheme() and components switch light/dark",
        "Reset/new prompt calls CloudflareKumo.reset() before starting new stream"
      ],
      "passes": false
    },
    {
      "id": "cross-5",
      "category": "cross-boundary",
      "description": "UMD loadable build produces correct CSS output that kumo components can use without Tailwind in the host page",
      "steps": [
        "pnpm build:loadable outputs both component-loadable.umd.js and style.css to dist/loadable/",
        "style.css includes kumo's standalone CSS (semantic tokens, component styles)",
        "Loading style.css in a plain HTML page is sufficient for kumo components to render correctly",
        "No Tailwind build step required in the host page",
        "Components render with correct colors, spacing, and typography in the cross-boundary demo"
      ],
      "passes": false
    }
  ],
  "context": {
    "patterns": [
      "Flat UITree format: { root: string, elements: Record<string, UIElement> } from @cloudflare/kumo/catalog",
      "Recursive rendering: UITreeRenderer.tsx walks flat element map from root, resolves children by key",
      "Anthropic SDK streaming: stream-client.ts wraps client.messages.stream() with onText/onDone/onError",
      "React 18 batching: multiple setState calls in same handler batched into single render",
      "UMD loadable pattern: window.CloudflareKumo global with _roots Map for React root reuse (from kumo-provider)",
      "flushSync for synchronous DOM updates during progressive rendering (from kumo-provider)",
      "ThemeWrapper with kumo-theme-change CustomEvent + data-mode attribute (from kumo-provider)",
      "SSE streaming: server sends data: JSON\\n\\n lines, client reads via ReadableStream reader + TextDecoder"
    ],
    "keyFiles": [
      "src/app/ChatDemo.tsx",
      "src/core/json-extractor.ts",
      "src/core/system-prompt.ts",
      "src/core/UITreeRenderer.tsx",
      "src/core/hooks.ts",
      "src/core/patches.ts",
      "src/__tests__/patches.test.ts",
      "src/core/stream-client.ts",
      "src/core/types.ts",
      "src/core/component-map.ts",
      "src/core/rfc6902.ts",
      "src/core/jsonl-parser.ts",
      "vite.loadable.config.ts",
      "../kumo-provider/src/loader.tsx",
      "../kumo-provider/server.js"
    ],
    "nonGoals": [
      "No Cloudflare Worker — local Express only",
      "No useCatalogStream hook — library-level abstraction deferred",
      "No diffUITree — LLM emits patches directly",
      "No structural sharing / React.memo — shallow copies, optimize later",
      "No multi-turn streaming improvements — per-turn only",
      "No state / $bindState / form interactivity — DataModel dropped",
      "No library integration into @cloudflare/kumo — deferred until example proves out",
      "No dynamic registry fetching — 16 hardcoded components proves the pattern",
      "No stateful component wrappers — no Combobox/Dialog/Popover; stateless proves architecture",
      "No full 38-component parity — 16 is sufficient for the demo",
      "No MutationObserver animations — defer polish",
      "No multi-turn in cross-boundary demo — single prompt only"
    ]
  }
}
