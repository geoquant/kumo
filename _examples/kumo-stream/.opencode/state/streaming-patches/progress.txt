# Progress Log
PRD: streaming-patches
Started: 2026-02-19

## CRITICAL: Branch Rules
- **ALL work for this PRD goes on branch `geoquant/streaming-ui`** — DO NOT create new branches
- Before any commit: `git branch --show-current` must show `geoquant/streaming-ui`
- If on wrong branch: `git checkout geoquant/streaming-ui` first
- VCS is git (not jj)

## Codebase Patterns
- UIElement interface lacks index signature; use `as unknown as AnyRecord` bridge type for generic nested-path traversal
- UITree = { root: string, elements: Record<string, UIElement> } from @cloudflare/kumo/catalog
- Test runner: `pnpm test` in `_examples/kumo-stream/` (not pnpm --filter)
- Vitest globals enabled; import { describe, it, expect } from "vitest"
- Test helper pattern: `el()` factory + `tree()` factory for concise test setup

---

## Task - core-1 + testing-1
- Implemented `src/core/rfc6902.ts`: RFC 6902 subset (add/replace/remove) applied to UITree
  - `applyPatch(spec, patch)` — immutable, returns new shallow copy per call
  - `parsePatchLine(line)` — parses JSON string to JsonPatchOp, null for invalid input
  - JSON Pointer path parsing with RFC 6901 escaping (~0, ~1)
  - /- array-append convention for nested paths (e.g. /elements/card/children/-)
  - AnyRecord bridge type to handle UIElement <-> Record<string, unknown> incompatibility
- Implemented `src/__tests__/rfc6902.test.ts`: 27 tests covering all ops and edge cases
  - add /root, add /elements/{key}, add with /-, replace, remove, no-op remove, edge cases, immutability, parsePatchLine
- Files changed: `src/core/rfc6902.ts`, `src/__tests__/rfc6902.test.ts`
- **Learnings:** UIElement's interface type doesn't satisfy `Record<string, unknown>` constraint due to missing index signature. Need explicit bridge types (toRecord/toElement) for generic nested-path operations.

## Task - core-2 + testing-2
- Implemented `src/core/jsonl-parser.ts`: stateful JSONL streaming parser
  - `createJsonlParser()` returns `{ push, flush }` interface
  - `push(chunk)` buffers text, splits on `\n`, parses complete lines via `parsePatchLine`
  - `flush()` attempts to parse remaining buffer contents
  - Silently skips: empty lines, invalid JSON, markdown fences (``` prefixed)
  - Returns `readonly JsonPatchOp[]` from both push and flush
- Implemented `src/__tests__/jsonl-parser.test.ts`: 21 tests covering all verification steps
  - Single complete line, multiple lines in one chunk, line split across 2-3 chunks
  - Empty/whitespace lines skipped, invalid JSON skipped, markdown fences skipped
  - flush returns buffered incomplete line, clears buffer after flush
  - Combined push+flush workflow simulating token-by-token streaming
- Files changed: `src/core/jsonl-parser.ts`, `src/__tests__/jsonl-parser.test.ts`
- **Learnings:** Parser reuses `parsePatchLine` from rfc6902.ts — good separation of concerns. The `isSkippable` check for markdown fences needs `.trim()` since LLMs sometimes indent fence markers.
