# Streaming Feature — Correlated Security & Performance Review

3 independent review agents examined the full branch (152 commits, ~21K lines, 112 files) across 3 domains. Below are the correlated findings.

## Architecture Overview

```
Client (StreamingDemo) → SSE → /api/chat (Workers AI) → JSONL patches
    ↓
streaming/ (parser, RFC6902 patches, action registry, hooks)
    ↓
generative/ (component map, validator, normalizations, renderer)
    ↓
loadable/ (UMD bundle, shadow DOM, batched rendering)
```

---

## CRITICAL / MUST-FIX (7 items)

### Security

| #   | Issue                                                                                                                                          | Files                                           | Impact                                                       |
| --- | ---------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------- | ------------------------------------------------------------ |
| 1   | **`ExternalResult` carries unsanitized URLs** — `handleNavigate` returns raw URL; consumers bypassing `processActionResult` get XSS            | `src/streaming/action-registry.ts:355-369`      | Sanitize URL at creation in `handleNavigate`, not downstream |
| 2   | **`on*` event handler props not blocked** — `sanitizeProps` only blocks 4 props; `onError`, `onLoad`, etc. pass through to rendered components | `src/generative/ui-tree-renderer.tsx:38-46`     | Block all `on*` prefixed props or use allowlist              |
| 3   | **`style` prop allows CSS injection on Div** — arbitrary CSS enables exfiltration, clickjacking, spoofing                                      | `src/generative/ui-tree-renderer.tsx:1027-1028` | Block `style` or sanitize to safe CSS subset                 |
| 4   | **Error messages leak internals to client** — raw `Error.message` from Workers AI forwarded in 500 response                                    | `pages/api/chat.ts:279-286`                     | Return generic error, log real error server-side             |

### Performance / Correctness

| #   | Issue                                                                                                                                                 | Files                          | Impact                                              |
| --- | ----------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------ | --------------------------------------------------- |
| 5   | **`useMemo` used as mutable ref** — `pendingRef` and `scheduledRef` violate React's contract; patches can be silently lost under concurrent rendering | `src/streaming/hooks.ts:75-80` | Switch to `useRef`                                  |
| 6   | **Rate limiter fails open silently** — if binding unavailable, all requests pass unthrottled with no logging                                          | `pages/api/chat.ts:176-178`    | Log error; consider fail-closed or fallback counter |
| 7   | **No aggregate token budget** — 20 turns × 4K chars = 80K+ chars per request; cost amplification and context overflow risk                            | `pages/api/chat.ts:216-227`    | Add total character budget check                    |

---

## HIGH / SHOULD-FIX (8 items)

| #   | Issue                                                                                                           | Domain     | Files                             |
| --- | --------------------------------------------------------------------------------------------------------------- | ---------- | --------------------------------- |
| 8   | `text-sanitizer.ts` misleading name — implies XSS protection but only strips emoji                              | streaming  | `src/streaming/text-sanitizer.ts` |
| 9   | Block `id` prop on Div — DOM clobbering risk                                                                    | generative | `ui-tree-renderer.tsx:1029`       |
| 10  | No prototype pollution tests for RFC 6902                                                                       | streaming  | `tests/streaming/rfc6902.test.ts` |
| 11  | System prompt cache poisons on rejection — rejected promise cached forever                                      | endpoint   | `pages/api/chat.ts:133-145`       |
| 12  | `flushSync` on every non-batched patch — blocks main thread during rapid streaming                              | loadable   | `src/loadable/index.ts:229-242`   |
| 13  | 8 chained normalization passes on every tree change during streaming                                            | generative | `ui-tree-renderer.tsx:1107-1124`  |
| 14  | Validation cache (`WeakMap<UIElement>`) misses every time during streaming (new objects from immutable updates) | generative | `ui-tree-renderer.tsx:85-94`      |
| 15  | `as unknown as` double-casts in RFC 6902 violate project type-safety convention                                 | streaming  | `rfc6902.ts:36-42`                |

---

## MEDIUM / CAN DEFER (10 items)

| #   | Issue                                                                | Domain               |
| --- | -------------------------------------------------------------------- | -------------------- |
| 16  | URL policy allows relative URLs — potential open redirect            | streaming            |
| 17  | Action dispatch `CustomEvent` on `window` — any script can eavesdrop | loadable             |
| 18  | `window.CloudflareKumo` global assignable by any script              | loadable             |
| 19  | Shadow DOM stylesheet URL hardcoded (`/.well-known/stylesheet.css`)  | loadable             |
| 20  | `RuntimeValueStore` grows without bound (no prune API)               | streaming            |
| 21  | `sanitizeUnknownText` recursive without depth limit                  | streaming            |
| 22  | Expand `BLOCKED_SEGMENTS` with legacy dunder methods                 | streaming            |
| 23  | Validate history `role` at parse boundary not just filter            | endpoint             |
| 24  | `max_tokens: 16384` generous for demo (4096 sufficient)              | endpoint             |
| 25  | `isRecord` utility duplicated across modules                         | streaming/generative |

---

## CROSS-CUTTING THEMES

### Trust boundary gaps

The 3 reviews independently found the same pattern: **sanitization happens too late**. URLs are sanitized in `processActionResult` (not at creation), props are sanitized in the renderer (not at parse), errors are forwarded raw to the client. Moving validation to the boundary where data enters the system would close all 3 gaps.

### Type safety violations

All 3 domains use `as` casts extensively (`as Record<string, unknown>`, `as unknown as`, `as AnyComponent`). The streaming/generative modules justify this pragmatically (dynamic rendering bridge), but it violates the project's AGENTS.md rule. The endpoint casts are unjustified and should use proper type guards.

### Performance during streaming

Two reviews independently flagged that immutable updates during streaming defeat caching strategies (WeakMap, useMemo). The 8-pass normalization + per-patch validation + `flushSync` creates cumulative overhead. The batched rendering API (`applyPatchBatched`) mitigates this but the non-batched path is the default.

---

## WHAT'S DONE WELL

- **No API keys in code** — Workers AI bindings used correctly throughout
- **Component allowlisting** — only `COMPONENT_MAP` types render, unknown types produce warnings
- **`dangerouslySetInnerHTML` blocked** — explicit in `BLOCKED_PROPS`
- **Discriminated unions** — `ActionResult`, `UrlSanitizationResult`, `ContainerMount` all properly typed
- **Immutability discipline** — RFC 6902 returns new objects, `readonly` modifiers throughout
- **Error boundaries** — every rendered element wrapped
- **Abort cleanup** — `AbortController` properly cleaned up on unmount
- **Rate limiting** — present (even if fail-open needs fixing)
- **Solid test coverage** — ~20 test files covering core paths, drift detection, structural grading

---

## RECOMMENDED FIX ORDER

**Phase 1 — Security (before merge):** Items 1-4, 8-10
**Phase 2 — Correctness (before merge):** Items 5-7, 11
**Phase 3 — Performance (can follow-up):** Items 12-14
**Phase 4 — Hardening (backlog):** Items 15-25
