# Code Review: `geoquant/kumo-regression-prevention` Branch

3 review agents analyzed all committed + uncommitted changes (14 files, +938/-45 lines). Findings below are correlated and deduplicated.

## Branch Summary

Bug fix (`overflow-hidden` → `overflow-x-hidden` in combobox) + 6 regression prevention layers: Tailwind conflict lint (AST-based), browser compat post-build test, CSS class contract test, eslint-plugin-tailwindcss, oxlint ES2023 rule disabling, explicit `es2022` build target. Plus VR script improvements and workflow changes.

---

## Critical (2)

### C1. Shell injection in `getChangedFiles()` — `ci/visual-regression/run-visual-regression.ts:115`

`GITHUB_BASE_REF` interpolated into `execSync()` shell command. Script can run locally where env is untrusted.
**Fix:** Use `execFileSync("git", ["diff", "--name-only", \`origin/${base}...HEAD\`])` or validate ref against `^[a-zA-Z0-9._/-]+$`.

### C2. `contents: write` permission on entire workflow — `.github/workflows/preview.yml:7`

Only VR job needs `contents: write`. Other jobs (build, deploy, comment) only need `contents: read`.
**Fix:** Move to per-job permissions.

---

## High (5)

### H1. Ternary `""` branch false negative — `tests/lint/tailwind-conflicts.test.ts:112-116`

`cn("overflow-y-auto", cond ? "overflow-hidden" : "")` — ternary returns `[]` so conflict is missed. When one branch is empty string, the other should be extracted like `&&`.
**Fix:** Check if either ternary branch is `""` and extract the other.

### H2. `CONFLICT_PAIRS` list is very narrow — `tests/lint/tailwind-conflicts.test.ts:33-48`

Only 12 pairs (overflow, display, visibility). Missing position, text-align, flex-direction, align-items, justify-content, etc.
**Decision:** Either expand or document intentional narrowness.

### H3. CSS completeness check gap — `tests/css-contract/css-classes.test.ts:153-200`

Parses _source_ `kumo-binding.css` for classes but contract checks _compiled_ output. A class defined in source but unused by components could be tree-shaken by Tailwind, causing the completeness check to demand a manifest entry that the contract test would then fail.
**Fix:** Document that all classes in `kumo-binding.css` must be used by at least one component, or also verify against compiled output.

### H4. Screenshot branch accumulation — `ci/visual-regression/run-visual-regression.ts:146`

Every CI run creates `vr-screenshots-{pr}-{runId}` branch with PNG binaries. Never cleaned up.
**Fix:** Add cleanup of old branches for same PR, or at minimum document as TODO.

### H5. Unchecked `postPRComment` API response — `ci/visual-regression/run-visual-regression.ts:559-567`

Response from GitHub comment create/update API never checked. 422 from oversized markdown report is a realistic failure mode.
**Fix:** Check `response.ok` and log warning on failure.

---

## Medium (8)

| ID  | Finding                                                                                                  | File                               | Note                                |
| --- | -------------------------------------------------------------------------------------------------------- | ---------------------------------- | ----------------------------------- |
| M1  | `isWorkerUnreachable()` missing `ETIMEDOUT`, `EHOSTUNREACH`, `ECONNRESET`; `"fetch failed"` is too broad | `run-visual-regression.ts:92-110`  | Acknowledged fragility              |
| M2  | `ghAnnotation` message should percent-encode `%` not just strip newlines                                 | `run-visual-regression.ts:88`      | GH Actions spec requires it         |
| M3  | Race: before/after screenshot mismatch silently drops new/removed components                             | `run-visual-regression.ts:686-697` | Should report as "New"/"Removed"    |
| M4  | `eslint-plugin-tailwindcss@4.0.0-beta.0` — beta dep; `config: {}` is TW v4 workaround                    | `eslint.config.js`, `package.json` | Well-documented, pinned             |
| M5  | `callees` list includes unused entries (`classnames`, `ctl`, `cva`, `tv`)                                | `eslint.config.js:80`              | Trim to `["cn"]`                    |
| M6  | `classnames-order` warn + eventual `--fix` will cause large one-time diff                                | `eslint.config.js:84`              | Consider normalizing in separate PR |
| M7  | `DIFF_THRESHOLD_PERCENT` JSDoc still says "causes non-zero exit" — stale after uncommitted changes       | `run-visual-regression.ts:24-27`   | Update JSDoc                        |
| M8  | Tailwind conflicts test only scans `src/components/`, misses `src/blocks/`                               | `tailwind-conflicts.test.ts:9`     | Blocks use `cn()` too               |

---

## Low (5)

| ID  | Finding                                                                                                          | Note                                                            |
| --- | ---------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------- |
| L1  | `KNOWN_EXCEPTIONS` uses substring match for file paths                                                           | Could over-suppress; use exact/suffix match                     |
| L2  | `rdp-` skip in CSS completeness check is dead code (only runs on `kumo-binding.css` which has no `rdp-` classes) | Remove or document as safety net                                |
| L3  | No `source: "kumo"` entries in CSS manifest despite type allowing it                                             | Remove from union type or add kumo.css coverage                 |
| L4  | Post-build tests skip silently without `dist/` in CI                                                             | Add CI-specific non-skip behavior or ensure build precedes test |
| L5  | `Array.prototype.with()` regex pattern has documented false neg/pos                                              | Acceptable, honestly documented                                 |

---

## Positive Findings (all 3 agents agreed)

- **Coherent story:** Bug fix + 6 prevention layers, each targeting a different failure mode
- **Combobox fix is correct:** `overflow-x-hidden` preserves `overflow-y: auto` scrolling
- **`es2022` target is correct:** Pins syntax downleveling independent of Vite defaults
- **Removing `rollup-plugin-preserve-directives` is safe:** It only worked with `preserveModules: true`
- **VR gate→informational shift is defensible:** Component libraries have frequent intentional visual changes
- **Test patterns are well-designed:** `describe.skipIf(!isBuilt)`, actionable error messages, manifest approach
- **Documentation in AGENTS.md is accurate and useful**
- **Changeset is correct:** Patch bump for bug fix

---

## Recommended Action Priority

1. **Must fix before merge:** C1 (shell injection), C2 (permission scope)
2. **Should fix:** H1 (ternary false negative), H5 (unchecked API response), M7 (stale JSDoc)
3. **Nice to fix:** H2 (expand conflict pairs), H3 (completeness check gap), H4 (branch cleanup)
4. **Track for later:** M4 (upgrade eslint plugin when stable), M6 (normalize class ordering), M8 (scan blocks)
