# Plan: Correlate branch code + uncommitted changes review

## Goal

- Produce a correlated review of: (1) current branch commits (vs base) and (2) uncommitted working tree changes.
- Output: issues/risks + consistency notes (style, types, tests, security) tied to specific files/areas.

## Constraints

- Plan mode: read-only exploration only; no code edits, no commits, no running mutating commands.
- VCS: detect `.jj/` first; if absent, use git read-only commands.

## Approach (planning)

1. Gather VCS context: branch name, upstream tracking, recent commits, divergence from base.
2. Gather working tree context: status + staged/unstaged diffs.
3. Map changes to areas (packages/kumo vs docs vs figma vs ci/lint) and identify likely impact.
4. Correlate: do uncommitted changes align with commit intent? any partial refactors? missing updates/tests/changesets?
5. Produce review checklist + recommended next actions.

## Findings (read-only)

- VCS: git; base branch: `origin/main`.
- Current branch: `geoquant/streaming-ui`; tracks `origin/geoquant/streaming-ui`; ahead by 3 commits.
- Working tree: no staged/unstaged changes; only untracked: `.opencode/plans/1771778308410-jolly-comet.md`.
- Branch-wide diffs (vs `origin/main`) are large; concentrated in:
  - `packages/kumo-docs-astro/` (streaming docs page, demos, `/api/chat`, Astro config + dev HMR plugin, wrangler/env types).
  - `packages/kumo/` + tests (streaming/generative/catalog/loadable, registry outputs, fixtures, many tests).
  - Repo metadata/tooling (`.changeset/*`, `pnpm-lock.yaml`, `.opencode/state/*`, `.gitignore`).
- Correlation note: docs demo additions likely drove `packages/kumo/ai/*` registry output changes.

## Review focus areas

- Docs runtime safety: `packages/kumo-docs-astro/src/pages/api/chat.ts` (bindings exist, budgets/rate limit, gateway coupling, failure modes).
- Docs build stability: `packages/kumo-docs-astro/astro.config.mjs` git calls in CI/shallow clones.
- Demo extraction: `packages/kumo-docs-astro/src/components/demos/StreamingDemo.tsx` matches `*Demo.tsx` pattern; confirm intended inclusion.
- Generated outputs: confirm `packages/kumo/ai/*` changes are regenerated, not hand-edited.

## Execution plan (what I will do next)

- Scope: product code only (per user): `packages/kumo/` + `packages/kumo-docs-astro/`; ignore `.opencode/**` + lockfile/changesets unless they directly affect those packages.
- Run 3 parallel `review` agents (read-only) and then correlate their findings:
  1. Docs API + demo runtime: `packages/kumo-docs-astro/src/pages/api/chat.ts`, `packages/kumo-docs-astro/src/components/demos/StreamingDemo.tsx`, `packages/kumo-docs-astro/src/pages/streaming.astro`, `packages/kumo-docs-astro/astro.config.mjs`, `packages/kumo-docs-astro/wrangler.jsonc`.
  2. Library streaming/generative core: `packages/kumo/src/streaming/**`, `packages/kumo/src/generative/**`, `packages/kumo/src/catalog/**`, `packages/kumo/src/loadable/**`.
  3. Tests + registry outputs: `packages/kumo/tests/**`, `packages/kumo/ai/component-registry.*`, `packages/kumo/ai/schemas.ts` (consistency with demos + codegen expectations).
- Correlate outputs against commit intent by sampling key commits via `git log origin/main..HEAD` + `git show <sha>` for any flagged areas.

## Verification (read-only)

- Ensure no uncommitted product-code changes: `git status`, `git diff`.
- Ensure review targets match base diff: `git diff origin/main...HEAD --name-only -- packages/kumo packages/kumo-docs-astro`.

## Notes

- Will use explore agents to collect: `status`, `diff`, `log`, and any relevant file reads.

## Unresolved questions

- None.
