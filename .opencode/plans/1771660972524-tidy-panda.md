# Code Review: `geoquant/kumo-regression-prevention`

3 independent review agents analyzed CI/build, test suite, and component/docs changes. Findings correlated below.

## Branch Summary

13 commits, 14 files, +938/-45 lines. Regression prevention framework: CI visual regression gate, 3 new test categories (browser compat, CSS class contract, Tailwind conflict lint), combobox overflow fix, ESLint Tailwind plugin, docs updates.

---

## Correlated Findings (by severity)

### MAJOR (2 issues, confirmed by 2/3 reviewers each)

| #   | Issue                                                | Files                                                  | Notes                                                                                                                                                                                                                                                                                                                                                                                    |
| --- | ---------------------------------------------------- | ------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | **`cancelled` VR result silently passes the gate**   | `.github/workflows/preview.yml:232-234`                | If VR job is cancelled (e.g., `cancel-in-progress` concurrency), gate passes without checking. Combined with `cancel-in-progress: true`, pushing a new commit mid-VR cancels the old run. New run gets its own gate, but edge cases exist (fork PRs, partial cancellations). **Recommendation:** Treat `cancelled` same as `failure` — require `visual-change-approved` label to bypass. |
| 2   | **`isWorkerUnreachable` string-matching is fragile** | `ci/visual-regression/run-visual-regression.ts:93-101` | Regex `50[234]` excludes 500. Error message format depends on upstream (undici). Node version changes could break matching. **Recommendation:** Match on `error.cause?.code` where possible. Document expected error format. Consider broadening to `50[0-4]`.                                                                                                                           |

### MEDIUM (4 issues)

| #   | Issue                                                                    | Files                                   | Notes                                                                                                                                                                                                                |
| --- | ------------------------------------------------------------------------ | --------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 3   | **Label bypass UX is confusing**                                         | `.github/workflows/preview.yml:222,241` | Labels frozen at workflow trigger time. Error says "re-run this check" but user must re-run entire workflow. **Fix:** Add `types: [labeled]` to `pull_request` trigger, or clarify message to "re-run the workflow". |
| 4   | **Tailwind conflict test misses object-syntax `cn()`**                   | `tailwind-conflicts.test.ts`            | `cn({ "overflow-hidden": condition })` not parsed. `button.tsx` uses this pattern. **Fix:** Handle `ObjectLiteralExpression` property names.                                                                         |
| 5   | **CSS class contract regex matches inside CSS comments**                 | `css-classes.test.ts`                   | Compiled Tailwind strips comments so low risk in practice. **Fix:** Add comment noting the assumption.                                                                                                               |
| 6   | **`Array.prototype.with()` regex has false-positive/negative tradeoffs** | `browser-compat.test.ts:89-93`          | Pattern requires digit after `.with(`, misses variable-index usage, may match non-Array `.with()` calls. **Fix:** Add comment documenting heuristic limitations.                                                     |

### MINOR (6 issues)

| #   | Issue                                                                                                     | Files                              |
| --- | --------------------------------------------------------------------------------------------------------- | ---------------------------------- |
| 7   | **`ghAnnotation` message not sanitized** (newlines could break workflow commands)                         | `run-visual-regression.ts:85-87`   |
| 8   | **`eslint-plugin-tailwindcss@4.0.0-beta.0`** — beta dep in production library, no tracking issue          | `package.json`, `eslint.config.js` |
| 9   | **`no-contradicting-classname` disabled** — the exact rule that would catch the combobox bug class is off | `eslint.config.js:63`              |
| 10  | **`structuredClone` mislabeled as ES2023+ in commit message** (it's HTML spec)                            | Commit `70d6cca`                   |
| 11  | **Worker unreachable = silent pass** could mask repeated infrastructure failures                          | `run-visual-regression.ts:653-670` |
| 12  | **`exec()` only reports first match per line** in browser-compat test                                     | `browser-compat.test.ts`           |

### NIT (5 issues)

| #   | Issue                                                                                            |
| --- | ------------------------------------------------------------------------------------------------ |
| 13  | `banner: (_chunk) =>` should be `() =>` — param unused                                           |
| 14  | `diffPercent` rounding before threshold check shifts effective threshold to ~0.505%              |
| 15  | Unused `__filename` in all 3 test files (only `__dirname` used)                                  |
| 16  | `CONFLICT_PAIRS` manually maintained — could derive from `tailwind-merge` class groups long-term |
| 17  | Fix-up commits (`7170227`, `3040f38`, `70d6cca`) are squash candidates                           |

---

## Positive Observations (consensus across all 3 reviewers)

1. **Combobox fix is correct and minimal** — `overflow-x-hidden` precisely constrains horizontal axis, allowing `overflow-y-auto` to work. Verified by all reviewers.
2. **Three-layer ES2023 defense** — source lint (oxlint rule disable) + build target (es2022) + post-build test. Excellent defense-in-depth.
3. **Escape hatches everywhere** — `KNOWN_EXCEPTIONS`, `describe.skipIf(!isBuilt)`, label bypass, manual conflict pairs. Every check has documented override path.
4. **TypeScript compiler API for `cn()` parsing** — genuinely clever. Correctly handles ternaries, `&&`, nested calls. Would have caught the combobox bug.
5. **CI gate architecture** — `if: always()` + `needs` pattern is the correct approach. VR runner / gate job separation is clean.
6. **Actionable error messages** — every test failure tells the developer exactly what to do.
7. **`rollup-plugin-preserve-directives` removal** — correct cleanup; plugin didn't work with current config.

---

## Recommended Actions

### Must-fix before merge

- [ ] Treat `cancelled` VR result as failure (require label bypass) — #1
- [ ] Clarify label bypass UX (add `types: [labeled]` or fix error message) — #3

### Should-fix

- [ ] Handle object-syntax `cn()` in tailwind conflict test — #4
- [ ] Document `isWorkerUnreachable` fragility, consider broadening regex — #2
- [ ] Add comments documenting heuristic limitations in browser-compat and css-classes tests — #5, #6
- [ ] Sanitize `ghAnnotation` message for newlines — #7

### Nice-to-have

- [ ] Track `eslint-plugin-tailwindcss` stable release, re-enable `no-contradicting-classname` — #8, #9
- [ ] Squash fix-up commits before merge — #17
- [ ] Remove unused `__filename`, fix `(_chunk)` param — #13, #15
- [ ] Add unit test for combobox overflow fix specifically
