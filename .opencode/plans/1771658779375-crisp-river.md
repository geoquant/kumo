# PR Cleanup Plan: geoquant/kumo-regression-prevention

## Review Summary

3 independent reviewers analyzed CI/build, tests, and config/docs changes. The core regression prevention work is solid. The branch has **cleanup issues that will get it rejected by upstream**.

---

## Critical (must fix before PR)

### 1. Remove development artifacts from branch

- `.opencode/state/kumo-regression-prevention/` — AI agent state files (prd.json, prd.md, progress.txt)
- `_examples/A2UI` and `_examples/json-render` — orphaned git submodules (no `.gitmodules`, unknown repos)
- `specs/kumo-regression-prevention.md` — planning doc; move relevant content to PR description

### 2. Add missing changeset

The combobox fix (`overflow-hidden` → `overflow-x-hidden`) changes published package behavior. Pre-push hook will block without a `patch` changeset.

### 3. Handle `cancelled` state in VR gate job

`.github/workflows/preview.yml` — the workflow has `cancel-in-progress: true`, so rapid pushes will cancel VR runs. `cancelled` result falls through to failure, emitting misleading "VR Failed" errors.

Fix: add `"cancelled"` to pass-through condition.

---

## Medium (should fix)

### 4. Stale comment in vite.config.ts (L233-235)

References `rollup-plugin-preserve-directives` which was removed from deps. Reword.

### 5. Stale comment in tailwind-conflicts.test.ts (L246-248)

Says combobox conflict is expected — but the fix is in this same branch. Remove.

### 6. CSS contract test says "minor bump" for breaking change

`css-classes.test.ts:36-37` says "minor version bump" for removing a public class. This is a breaking change → should say "major" (or clarify pre-1.0 convention). Same inconsistency in AGENTS.md.

### 7. `process.exit(1)` in VR script → use `throw` instead

`ci/visual-regression/run-visual-regression.ts:740` — bypasses cleanup. The existing `main().catch()` already calls `process.exit(1)`. Use `throw` so error flows through the handler.

### 8. Beta eslint plugin justification

`eslint-plugin-tailwindcss@4.0.0-beta.0` with all rules at `warn` level. Either:

- Justify in PR description (gradual adoption, fix existing violations first)
- Or promote to `error` to make it actually enforce

---

## Low (nice-to-have polish)

### 9. `ghAnnotation()` title escaping

VR script — titles with commas would break GH Actions annotation syntax. Current titles are safe but function is generic.

### 10. `isWorkerUnreachable` 5xx match is fragile

`"Worker request failed: 5"` substring match → use regex `/Worker request failed: 5\d{2}/`.

### 11. VR gate error message should say "re-run"

After adding `visual-change-approved` label, devs must re-run the check. Error message doesn't mention this.

### 12. Vite target comment says "ES2020 default" — Vite default is `modules`, not ES2020

### 13. `unconditionalClasses` naming in tailwind-conflicts.test.ts

Includes `&&` conditional classes. Rename to `coOccurringClasses` or improve JSDoc.

### 14. browser-compat double `.test()` + `.exec()`

Combine into single `.exec()` call for clarity.

### 15. browser-compat missing note that banned list isn't exhaustive

Missing APIs: `Object.groupBy`, `Promise.withResolvers`, `Set.prototype.difference`, etc. Add comment.

---

## Files to modify

| File                                                   | Action                                                                       |
| ------------------------------------------------------ | ---------------------------------------------------------------------------- |
| `.opencode/state/kumo-regression-prevention/*`         | `git rm`                                                                     |
| `_examples/A2UI`, `_examples/json-render`              | `git rm`                                                                     |
| `specs/kumo-regression-prevention.md`                  | `git rm` (move to PR body)                                                   |
| `.github/workflows/preview.yml`                        | Fix cancelled handling, improve error msg                                    |
| `ci/visual-regression/run-visual-regression.ts`        | Replace `process.exit(1)` with throw, fix annotation escaping, fix 5xx regex |
| `packages/kumo/vite.config.ts`                         | Update stale comment                                                         |
| `packages/kumo/tests/lint/tailwind-conflicts.test.ts`  | Remove stale combobox comment, rename field                                  |
| `packages/kumo/tests/css-contract/css-classes.test.ts` | Fix "minor" → "major" bump guidance                                          |
| `packages/kumo/tests/build/browser-compat.test.ts`     | Combine test+exec, add "not exhaustive" note                                 |
| `packages/kumo/AGENTS.md`                              | Fix "minor" → "major"                                                        |
| (new) `.changeset/*.md`                                | Add patch changeset for combobox fix                                         |

## Verification

1. `pnpm --filter @cloudflare/kumo build && pnpm --filter @cloudflare/kumo test` — all tests pass
2. `pnpm lint` — no new lint errors
3. `pnpm typecheck` — no type errors
4. `git diff --stat upstream/main..HEAD` — verify no dev artifacts remain
5. Verify `.gitmodules` doesn't exist and no submodule entries remain
