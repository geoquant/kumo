# Plan: Align kumo-stream w/ GENERATIVE-UI

Scope: `_examples/kumo-stream/` + `_examples/GENERATIVE-UI.md` (current branch: `geoquant/streaming-ui`).

## Goals

- Make `kumo-stream` satisfy `_examples/GENERATIVE-UI.md` “Cross-Boundary Generative UI” goals end-to-end (SPA + cross-boundary UMD).
- Reconcile known mismatches:
  - Theme change event name (doc vs UMD implementation).
  - ErrorBoundary doc reference (doc points to nonexistent `loadable.tsx`).
  - `submit_form` guidance (system prompt vs doc/implementation).
  - SPA ChatDemo streaming path (browser Anthropic SDK) vs expected SSE `/api/chat`.
- Apply patch sanitization in all patch-application paths (esp UMD API path).
- Harden RFC6902 handling: invalid/blocked/disallowed paths => no-op (never wipe/replace whole tree).
- Keep intermediate-state rendering safe (streaming partial trees must not crash / must degrade safely).

Non-goals:

- No changes to `packages/kumo/` APIs.
- No changes outside `_examples/`.

## Current State (facts from repo)

- `.well-known` + SSE server exists: `_examples/kumo-stream/server/index.ts` serves:
  - `/.well-known/component-loadable.umd.js`
  - `/.well-known/stylesheet.css`
  - `/.well-known/component-registry.json`
  - `/.well-known/generative-ui.json`
  - `POST /api/chat` SSE endpoint (server-side Anthropic key).
- Cross-boundary HTML demo uses SSE `/api/chat` and UMD API: `_examples/kumo-stream/public/cross-boundary.html`.
- React SPA ChatDemo currently uses browser Anthropic SDK + `dangerouslyAllowBrowser: true`:
  - `_examples/kumo-stream/src/app/ChatDemo.tsx`
  - `_examples/kumo-stream/src/core/stream-client.ts`
- Patch sanitization exists (`sanitizePatch`) and is used in React hook + server DPU mode:
  - `_examples/kumo-stream/src/core/hooks.ts`
  - `_examples/kumo-stream/server/index.ts`
  - UMD API currently does NOT sanitize patches before applying: `_examples/kumo-stream/src/loadable/index.ts`.
- Theme event mismatch:
  - Doc shows `window.addEventListener('theme-change', ...)`: `_examples/GENERATIVE-UI.md`.
  - UMD `setTheme()` dispatches `CustomEvent('kumo-theme-change')`, and `ThemeWrapper` listens for `kumo-theme-change`:
    - `_examples/kumo-stream/src/loadable/index.ts`
    - `_examples/kumo-stream/src/loadable/theme.tsx`
- ErrorBoundary doc mismatch:
  - Doc references `loadable.tsx` ErrorBoundary; actual per-element boundary is `ElementErrorBoundary` in `_examples/kumo-stream/src/core/UITreeRenderer.tsx`.
- RFC6902 blocked segment bug:
  - `_examples/kumo-stream/src/core/rfc6902.ts` returns `[]` segments on blocked `__proto__/constructor/prototype`, which currently makes `replace` treat it as “replace whole tree” and `remove` treat it as “wipe tree”.

## Approach (minimal, surgical)

1. Fix docs to describe the real reference implementation (and align event names + submit_form semantics).
2. Make SPA use the same streaming surface as cross-boundary: SSE `POST /api/chat` (server-side key), not browser SDK.
3. Make UMD patch-application path sanitize patch values (same as React hook).
4. Harden RFC6902 path parsing + op application so invalid/blocked/disallowed paths are no-ops (never wholesale replace/wipe).
5. Add/adjust tests to lock in safety behavior.

## Step-by-step Implementation

### 0) Baseline / guardrails (no behavior change)

- Re-skim `_examples/GENERATIVE-UI.md` sections that mention theme events, ErrorBoundary, submit_form.
- Locate all patch application callsites:
  - React: `_examples/kumo-stream/src/core/hooks.ts`
  - UMD: `_examples/kumo-stream/src/loadable/index.ts`
  - Server DPU: `_examples/kumo-stream/server/index.ts`

### 1) RFC6902 hardening (core correctness + security)

Files:

- `_examples/kumo-stream/src/core/rfc6902.ts`
- `_examples/kumo-stream/src/__tests__/rfc6902.test.ts`

Changes:

- Change path parsing to distinguish "valid empty/root" from "invalid/blocked".
  - Replace `parsePath(): string[]` with an ADT return, e.g. `{ ok: true; segments: string[] } | { ok: false }`.
  - Treat blocked segments (`__proto__`, `constructor`, `prototype`) as `{ ok: false }`.
- Apply a strict allowlist for top-level segments:
  - Allow only `/root/...` and `/elements/...`.
  - Disallow ops that target the whole document (`""`, `"/"`) or the whole `elements` map (`/elements`): treat as invalid => no-op.
  - Disallow unknown top-level keys (previously would write arbitrary props onto tree).
- On invalid path:
  - `applyPatch()` returns a shallow copy of input tree (preserve "always new object" contract) and performs no mutations.
- On empty/root path ("" or "/"):
  - Make _all_ ops behave as no-ops (shallow copy). This removes the current dangerous behavior:
    - `replace ""` => whole-tree replace
    - `remove ""` => wipe tree

Tests:

- Update existing edge-case tests to reflect new semantics.
- Add new cases:
  - `replace` with `""` and `"/"` is no-op.
  - `remove` with `""` and `"/"` is no-op.
  - Any op with blocked segment anywhere is no-op (and does not wipe/replace).
  - `remove /elements` and `replace /elements` are no-op.
  - Unknown top-level segment (e.g. `/state/x`) is no-op.

### 2) UMD patch sanitization consistency

Files:

- `_examples/kumo-stream/src/loadable/index.ts`
- (optional test) `_examples/kumo-stream/src/__tests__/loadable-tree-access.test.ts`

Changes:

- Import `sanitizePatch` from `_examples/kumo-stream/src/core/text-sanitizer.ts`.
- In all UMD patch application methods:
  - `applyPatch`, `applyPatchBatched`, `applyPatches`, `applyPatchesBatched`
  - sanitize each op before calling `applyRfc6902Patch`.
- Keep behavior identical aside from sanitization (no new API surface).

Test:

- Add a focused assertion: applying a patch with a string containing leading emoji tokens results in a sanitized value in `api.getTree()`.

### 3) Theme event name reconciliation (doc + compatibility)

Files:

- `_examples/kumo-stream/src/loadable/theme.tsx`
- `_examples/kumo-stream/src/loadable/index.ts`
- `_examples/GENERATIVE-UI.md`

Changes (recommended for compatibility + minimal churn):

- Keep `CloudflareKumo.setTheme()` as-is for `data-mode`.
- Add compatibility for both event names:
  - `ThemeWrapper` listens to both `kumo-theme-change` and `theme-change` (same payload shape: `{ detail: { mode } }`).
  - `setTheme()` dispatches _both_ events (or dispatches `theme-change` in addition to existing `kumo-theme-change`).

Docs:

- Update `_examples/GENERATIVE-UI.md` theme section to reference the canonical event(s) actually supported.
  - Prefer documenting `kumo-theme-change` (implementation) and note `theme-change` compatibility.
  - Update code snippet accordingly.

### 4) ErrorBoundary doc reference fix

Files:

- `_examples/GENERATIVE-UI.md`

Changes:

- Replace “`loadable.tsx` ErrorBoundary class” reference with the real implementation location:
  - Per-element error boundary: `_examples/kumo-stream/src/core/UITreeRenderer.tsx` (`ElementErrorBoundary`).
- Keep narrative the same: per-element boundaries prevent stream-wide crashes.

### 5) submit_form guidance reconciliation

Files:

- `_examples/kumo-stream/src/core/system-prompt.ts`
- `_examples/GENERATIVE-UI.md`

Changes:

- Update system prompt `submit_form` section to match actual host behavior:
  - `params` = static metadata only (e.g. `form_type`, scoping `formKey`/`fieldKeys`).
  - Runtime user-entered values are captured by the host and included via `context.runtimeValues` at dispatch time.
  - Remove/replace the line that instructs the model to include user-entered values in `params`.
- Ensure the prompt examples show `submit_form` with static params only.

### 6) SPA streaming path: use SSE `/api/chat` (align w/ GENERATIVE-UI)

Files:

- `_examples/kumo-stream/src/core/stream-client.ts` (refactor/replace)
- `_examples/kumo-stream/src/app/ChatDemo.tsx`
- `_examples/kumo-stream/vite.config.ts` (dev proxy)
- (optional docs) `_examples/GENERATIVE-UI.md` or `_examples/kumo-stream/README` if it exists

Changes:

- Replace browser Anthropic SDK streaming in SPA with the same SSE protocol as cross-boundary:
  - `POST /api/chat` with `{ message, history, renderMode: "jsonl" }`.
  - Parse SSE frames with `data:` JSON payloads (`{type:"text",delta}` / `{type:"done"}` / `{type:"error"}`), then feed `delta` into existing `createJsonlParser()`.
- Implement the SSE reader in TS in `_examples/kumo-stream/src/core/stream-client.ts` (or a new helper module) using the cross-boundary HTML logic as reference (chunk-safe, CRLF-safe, multiline `data:` safe).
- In `vite.config.ts`, add `server.proxy` for `/api` (and optionally `/.well-known`) to `http://localhost:3001` so SPA can call same-origin `/api/chat` during `pnpm dev` while the Express server is running.
- Update `ChatDemo.tsx`:
  - Remove `getApiKey()` requirement and error string about missing `VITE_ANTHROPIC_API_KEY`.
  - On submit: start SSE stream via new `startStream()` that targets `/api/chat`.
  - Preserve existing `applyPatches` + parser + action handling.

Optional (if you want a smooth dev experience):

- Keep a fallback mode behind a flag (e.g. if `/api/chat` fails and `VITE_ANTHROPIC_API_KEY` exists, use browser Anthropic). Only do this if it stays small; default path should be SSE.

Tests:

- Prefer unit tests for the SSE parser (pure function) using canned SSE chunk sequences.
  - If too heavy, at least ensure the parser tolerates chunk splits and CRLF.

## Verification Checklist

Run from repo root.

**Unit tests**

- `pnpm -C _examples/kumo-stream test`
  - Confirms RFC6902 hardening tests, UMD sanitization tests, and existing loadable tests.

**Typecheck/build**

- `pnpm -C _examples/kumo-stream typecheck`
- `pnpm -C _examples/kumo-stream build`
- `pnpm -C _examples/kumo-stream build:loadable`

**Manual E2E (cross-boundary)**

1. In one terminal: `pnpm -C _examples/kumo-stream serve`
2. Visit `http://localhost:3001/cross-boundary.html`
3. Validate:
   - Streaming renders progressively (root appears before children).
   - Theme toggle updates Kumo components.
   - Action events fire (`kumo-action`), counter buttons patch the tree.
   - `submit_form` shows payload w/ runtime values (inputs/selects/checkboxes) without requiring LLM to stuff `params`.

**Manual E2E (SPA)**

1. Terminal A: `pnpm -C _examples/kumo-stream serve` (Express on `:3001`)
2. Terminal B: `pnpm -C _examples/kumo-stream dev` (Vite on `:4200`)
3. Visit `http://localhost:4200/`
4. Validate:
   - ChatDemo streams via `/api/chat` (no browser API key required).
   - Stop/abort works; stream completion flushes parser.
   - Theme toggle affects rendered Kumo tree.

## Commit Plan (user wants “commit everything”, with exclusions)

Important exclusions:

- `_examples/kumo-stream/.env` (gitignored)
- `_examples/kumo-stream/node_modules/` (gitignored)
- `.opencode/plans/*` (do NOT commit planning artifacts)

Staging approach (safe + explicit):

- Stage only intended scope:
  - `git add _examples/GENERATIVE-UI.md _examples/kumo-stream`
- Then verify nothing unwanted is staged:
  - `git diff --staged --name-only`
  - Ensure no `.env`, no `node_modules`, no `.opencode/plans/`.

## Risks / gotchas

- RFC6902 semantics change: if any existing caller relied on `replace ""` or `remove ""` to reset/replace, it will stop working. (Expected: nobody should rely on this; explicit reset APIs exist.)
- Vite dev proxy requires Express server running on `:3001` for SPA to stream; failure mode should show a clear error state.
- Theme event name: dispatching two events should be harmless; keep payload identical.

## Unresolved questions

- None (default decisions picked: support both theme event names; SPA defaults to SSE `/api/chat`).
