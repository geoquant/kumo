# Code Review: Streaming UI Hardening Commit

**Commit:** `3aff1c1` — harden streaming UI: block on\* props, prototype pollution, URL sanitize; rename text-sanitizer→text-normalizer; fix hooks refs; add aggregate char budget to chat endpoint

**Reviewed by:** 3 independent code-review agents + oracle validation  
**Files changed:** 16 (+322/-95)

---

## Verdict: APPROVE with minor follow-ups

The commit is well-executed security hardening. All critical security mitigations are correct and complete. Two agents produced a false positive (`.toBe()` → `.toStrictEqual()` "weakening") which was invalidated by code inspection — `coerceElementProps` always returns a new object, so `.toStrictEqual()` is the correct assertion.

---

## Findings (oracle-adjusted severity)

### Actionable — follow-up commit

| #   | Sev | File                        | Finding                                                                                                                                                                                 | Fix                                                          |
| --- | --- | --------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------ |
| 1   | LOW | `prompt-builder.ts:455-467` | `SYNTHETIC_TYPES.Div` still lists `style`/`id` as allowed props — renderer now blocks them. LLM wastes tokens emitting stripped props.                                                  | Remove `style`/`id` from `propsLines` and update description |
| 2   | LOW | `chat.ts:57-66`             | `parseChatRequest` validates ALL history entries before downstream `.slice(-20)`. 10k entries × 4k chars = 40MB traversal before trim. Mitigated by Workers CPU limits + rate limiting. | Move `.slice(-MAX_HISTORY_TURNS)` before validation          |
| 3   | LOW | `rfc6902.test.ts`           | Missing test for `__proto__` as element key (`/elements/__proto__`). Code is correct — `parsePath` blocks at any position — but test coverage gap.                                      | Add 1 test case                                              |

### Dismissed — intentional or not a vulnerability

| #   | Finding                                                    | Oracle rationale                                                                                                                               |
| --- | ---------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| 4   | Aggregate budget includes system prompt                    | Intentional — holistic cost control prevents context overflow regardless of source. Comment is explicit.                                       |
| 5   | `.toBe()` → `.toStrictEqual()` weakening                   | **FALSE POSITIVE** — `coerceElementProps` always returns `{ ...element, props }`. `.toBe()` would fail. `.toStrictEqual()` is the correct fix. |
| 6   | Naming inconsistency (file=normalizer, exports=sanitize\*) | Module comment is clear ("NOT XSS sanitization"). Renaming exports is breaking change. Low value.                                              |
| 7   | `while` loop no iteration cap                              | Bounded by finite element count. In practice 0-1 iterations. Counter suffix would be slightly cleaner but not worth changing.                  |
| 8   | `shadowStylesheetHref` unsanitized                         | Developer API, not LLM-controlled. Trust boundary is developer → config → DOM. Not a vulnerability.                                            |

### Confirmed correct (all 3 agents agree)

- `on*` event handler blocking via `charCodeAt(2) >= 65 && <= 90` — matches React convention
- `parsePath` returning `null` instead of `[]` — closes real vuln where `replace` op could overwrite entire tree
- `x-forwarded-for` removal — correct for Cloudflare Workers (`cf-connecting-ip` is authoritative)
- Error message sanitization — 503 + generic message prevents info leak
- System prompt cache try/catch — correct retry-on-failure pattern, no race condition
- `useMemo` → `useRef` migration — idiomatic React, dependency arrays correct
- URL sanitization at `handleNavigate` — correct placement at creation time
- `style`/`id` removal from `filterDivProps` — correct security hardening
- Prototype pollution prevention in rfc6902 — `BLOCKED_SEGMENTS` checked after RFC 6901 decoding, covers all 3 vectors

---

## Follow-up fixes (all size S, <1hr combined)

### 1. Update Div prompt docs

**File:** `packages/kumo/src/catalog/prompt-builder.ts:455-467`

- Remove `style?: Record<string, unknown>` and `id?: string` from `propsLines`
- Update description to: `"Generic HTML container. Props: className, role, aria-*, data-*."`

### 2. Cap history before validation

**File:** `packages/kumo-docs-astro/src/pages/api/chat.ts:57-66`

- In `parseChatRequest`, slice history to 20 entries before `.every()` validation

### 3. Add element-key prototype pollution test

**File:** `packages/kumo/tests/streaming/rfc6902.test.ts`

- Add test: `applyPatch(base, { op: "add", path: "/elements/__proto__", value: ... })` → expect `result === base`

---

## Verification

```bash
pnpm --filter @cloudflare/kumo test         # all streaming/generative tests pass
pnpm --filter @cloudflare/kumo typecheck    # no type errors
pnpm lint                                    # no lint violations
```
