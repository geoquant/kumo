# Progress Log
PRD: streaming-ui
Started: 2026-02-21

## Codebase Patterns
- Intra-package imports use relative paths (e.g., `../catalog/types`), not `@cloudflare/kumo/catalog`
- New module directories need: types.ts, implementation files, index.ts barrel
- Build wiring (vite.config.ts entry + package.json exports) is a separate task from source creation
- Pre-existing test failures: stack/cluster/ai-schemas dist files missing (stale build)
- `AnyRecord` pattern used to bridge UIElement (no index signature) with dynamic path traversal
- Tree-shakeability: keep React imports in separate files (hooks.ts, context.tsx) from pure modules
- oxlint enforces no `unknown | undefined` — `unknown` already includes `undefined`
- Action types (ActionEvent, ActionDispatch) split into `action-types.ts` for lightweight import by hooks; full action system (factories, registry) in streaming-3
- oxlint enforces `Array#toSorted()` over `Array#sort()` — always use immutable array methods
- New module export pattern: vite entry `name: resolve(__dirname, "src/name/index.ts")` → package.json `"./name": { "types": "./dist/src/name/index.d.ts", "import": "./dist/name.js" }`
- Defensive JSON parsing: registry JSON types are untrustworthy at module boundaries — use `isRecord()` guards, not type assertions
- oxlint `no-base-to-string`: `String(unknownValue)` fails lint — type-narrow to string/number/boolean first, fall back to `JSON.stringify`

---
<!-- Task logs below - APPEND ONLY -->

## Task - streaming-1
- Ported JSONL parser, RFC 6902 engine, and types to `packages/kumo/src/streaming/`
- Files: `types.ts`, `rfc6902.ts`, `jsonl-parser.ts`, `index.ts`
- Types re-export from `../catalog/types` (UITree, UIElement, Action, etc.)
- Added EMPTY_TREE and EMPTY_DATA constants
- Barrel exports all public API: createJsonlParser, applyPatch, parsePatchLine + types
- **Learnings:** Source is a direct port with only import path changes; `toRecord`/`toElement` casts are necessary because UIElement lacks index signature

## Task - streaming-2
- Ported useUITree hook, runtime value store, and supporting modules
- New files: `hooks.ts`, `runtime-value-store.ts`, `runtime-value-store-context.tsx`, `text-sanitizer.ts`, `action-types.ts`
- Updated `index.ts` barrel to export all new public API
- `action-types.ts` contains only ActionEvent/ActionDispatch types (lightweight dep for hooks); full action system is streaming-3
- `text-sanitizer.ts` ported early (needed by hooks for sanitizePatch)
- Fixed `unknown | undefined` → `unknown` in runtime-value-store to satisfy oxlint
- Tree-shakeability verified: React imports confined to hooks.ts and runtime-value-store-context.tsx
- **Learnings:** When porting hooks that depend on not-yet-ported modules, extract minimal type-only deps into separate files rather than stubbing

## Task - streaming-3
- Ported action system: handler factory, registry with built-ins, result processor, URL policy
- New files: `action-handler.ts`, `action-registry.ts`, `process-action-result.ts`, `url-policy.ts`
- `action-handler.ts` re-exports ActionEvent/ActionDispatch from `action-types.ts` (no duplication)
- `action-registry.ts` contains 4 built-in handlers: increment, decrement, submit_form, navigate
- `process-action-result.ts` dispatches ActionResult discriminated union to host callbacks, uses sanitizeUrl for external URLs
- `url-policy.ts` is a standalone pure module: allows http/https/relative, blocks javascript:/data:/file:/protocol-relative
- `text-sanitizer.ts` was already ported in streaming-2 (no work needed)
- Fixed `Array#sort()` → `Array#toSorted()` in action-registry to satisfy oxlint unicorn rule
- Changed `[kumo-stream]` console.warn prefix to `[kumo]` since this is now in the library
- Updated barrel `index.ts` with all new exports (types + values)
- **Learnings:** oxlint enforces `Array#toSorted()` over `Array#sort()` — use immutable array methods when porting

## Task - streaming-4
- Wired `@cloudflare/kumo/streaming` into build pipeline and package exports
- Files changed: `packages/kumo/vite.config.ts`, `packages/kumo/package.json`
- Added `streaming` entry to vite.config.ts lib entry map (alongside catalog, utils, registry)
- Added `./streaming` export to package.json with types + import paths
- Barrel `index.ts` already existed from streaming-1
- Build produces `dist/streaming.js` (JS) and `dist/src/streaming/index.d.ts` (types)
- All 177 export path validation tests pass including new streaming export
- **Learnings:** Top-level module export pattern: vite entry `name: resolve(__dirname, "src/name/index.ts")` + package.json `"./name": { "types": "./dist/src/name/index.d.ts", "import": "./dist/name.js" }`

## Task - streaming-5
- Ported 9 streaming engine test files to `packages/kumo/tests/streaming/`
- Files: `rfc6902.test.ts`, `jsonl-parser.test.ts`, `action-handler.test.ts`, `action-registry.test.ts`, `process-action-result.test.ts`, `runtime-value-store.test.ts`, `url-policy.test.ts`, `text-sanitizer.test.ts`, `streaming-integration.test.ts`
- 116 tests across 9 files, all passing on first run
- Import path changes: `../core/X` → `@/streaming/X` (vitest alias)
- Action types imported from `@/streaming/action-types` (not `action-handler`) to match module split
- Zero new dependencies added to package.json
- Typecheck and lint pass cleanly (no new warnings)
- **Learnings:** Test files use vitest `@/` alias not tsconfig paths; tsconfig excludes `**/*.test.ts` so LSP "cannot find module" errors are expected and harmless

## Task - prompt-1
- Ported system prompt template to `packages/kumo/src/catalog/system-prompt.ts`
- New file: `system-prompt.ts` with `buildSystemPrompt()` function and `SystemPromptOptions` interface
- Updated `index.ts` barrel to export `buildSystemPrompt` and `SystemPromptOptions`
- Template accepts optional `componentsSection` string (to be generated by prompt-2's prompt builder)
- Sections: design rules, accessibility, JSONL/RFC6902 format, UITree schema, emission strategy, action system, 2 examples (counter + form), closing rules
- Fixed duplicate rule #6 from original source (now numbered 1-8 correctly)
- Model-agnostic: no provider-specific instructions
- **Learnings:** System prompt sections decomposed into module-level constants for readability; `componentsSection` is injected rather than imported (avoids coupling to prompt builder that doesn't exist yet in catalog)

## Task - prompt-2
- Created `packages/kumo/src/catalog/prompt-builder.ts` with `buildComponentDocs()` function
- Ported from `kumo-stream/src/core/system-prompt-components.ts` with key decoupling:
  - Source depends on `KNOWN_TYPES` (generative module) + `ComponentPropsSchemas` (zod) — tightly coupled
  - Prompt builder takes raw `registryJson` as input — no dependency on generative or zod schemas
  - Prop filtering uses registry JSON directly instead of cross-referencing zod schemas
- Prop filtering: skips className, id, lang, title, on*, set*, aria-* prefixes
- Prop scoring: required (+3) > enum (+2) > interesting names (+1); props with score ≤0 excluded
- Top 10 props per component (configurable via `maxPropsPerComponent`)
- 9 category groups: Layout, Content, Interactive, Data Display, Navigation, Action, Feedback, Brand, Other
- Sub-component types: SelectOption, BreadcrumbsLink/Current/Separator, TableHeader/Head/Body/Row/Cell/Footer
- Type aliases: Textarea→InputArea, RadioGroup→Radio
- Synthetic types: Div (generic container), RadioItem (radio option)
- Optional `components` filter for subset output
- Exported `buildComponentDocs` and `PromptBuilderOptions` from catalog barrel
- Fixed `no-base-to-string` lint error: handle `prop.default` serialization for non-primitive types via `JSON.stringify`
- Files changed: `prompt-builder.ts` (new), `index.ts` (barrel update)
- **Learnings:** oxlint `no-base-to-string` catches `String(unknownValue)` — always type-narrow before stringifying; decoupling from `ComponentPropsSchemas`/zod means the prompt builder works without async schema loading

## Task - prompt-3
- Replaced stub `generatePrompt()` in catalog.ts with rich implementation using `buildSystemPrompt` + `buildComponentDocs`
- Added `GeneratePromptOptions` type: `components?`, `maxPropsPerComponent?`, `includeExamples?`
- Updated `KumoCatalog` interface to accept optional options parameter (backwards compatible)
- Added `loadRegistry()` function to async-load `component-registry.json` (cached, alongside schemas)
- Updated `initCatalog()` to load both schemas and registry in parallel
- Added `stripExampleSections()` helper for `includeExamples: false` option
- Exported `GeneratePromptOptions` type and `loadRegistry` from barrel
- Files changed: `catalog.ts`, `types.ts`, `index.ts`
- **Learnings:** `initCatalog()` is the natural place to load both schemas and registry JSON — the registry is needed for prompt generation but not validation, so loading it eagerly in `initCatalog` avoids a second async boundary at `generatePrompt` call time
