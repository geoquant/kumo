# Progress Log
PRD: streaming-ui
Started: 2026-02-21

## Codebase Patterns
- Intra-package imports use relative paths (e.g., `../catalog/types`), not `@cloudflare/kumo/catalog`
- New module directories need: types.ts, implementation files, index.ts barrel
- Build wiring (vite.config.ts entry + package.json exports) is a separate task from source creation
- Pre-existing test failures: stack/cluster/ai-schemas dist files missing (stale build)
- `AnyRecord` pattern used to bridge UIElement (no index signature) with dynamic path traversal
- Tree-shakeability: keep React imports in separate files (hooks.ts, context.tsx) from pure modules
- oxlint enforces no `unknown | undefined` — `unknown` already includes `undefined`
- Action types (ActionEvent, ActionDispatch) split into `action-types.ts` for lightweight import by hooks; full action system (factories, registry) in streaming-3
- oxlint enforces `Array#toSorted()` over `Array#sort()` — always use immutable array methods
- New module export pattern: vite entry `name: resolve(__dirname, "src/name/index.ts")` → package.json `"./name": { "types": "./dist/src/name/index.d.ts", "import": "./dist/name.js" }`
- Defensive JSON parsing: registry JSON types are untrustworthy at module boundaries — use `isRecord()` guards, not type assertions
- oxlint `no-base-to-string`: `String(unknownValue)` fails lint — type-narrow to string/number/boolean first, fall back to `JSON.stringify`
- Codegen-as-manifest pattern: generate pure data (arrays/objects) not React components; hand-written code imports manifest. Drift detection tests compare manifest against registry.
- `Object.assign(StatefulSelectInner, { Option: Select.Option })` pattern for compound function components (avoids `.Option` property type issue on plain functions)
- Cross-module imports: generative→streaming uses `../streaming/X`, generative→ai uses `../../ai/schemas.js` (relative, not `@cloudflare/kumo/ai/schemas`)
- React 19 forwardRef components are `typeof === "object"`, not `"function"` — accept function/object/string when checking React component values
- vitest.config.ts `tests/` include glob was `.ts` only — needed `.{ts,tsx}` to pick up tsx test files in tests/ directory
- COMPONENT_MAP mutation in tests: cast via `(COMPONENT_MAP as Record<string, unknown>)` to avoid type errors when injecting spy components (no `any` casts)
- UMD loadable build: separate `vite.loadable.config.ts` with `@tailwindcss/vite` plugin, no `@vitejs/plugin-react` needed (esbuild handles JSX via tsconfig `jsx: "react-jsx"`), `cssCodeSplit: false` for single CSS output, `inlineDynamicImports: true` for UMD compat

---
<!-- Task logs below - APPEND ONLY -->

## Task - streaming-1
- Ported JSONL parser, RFC 6902 engine, and types to `packages/kumo/src/streaming/`
- Files: `types.ts`, `rfc6902.ts`, `jsonl-parser.ts`, `index.ts`
- Types re-export from `../catalog/types` (UITree, UIElement, Action, etc.)
- Added EMPTY_TREE and EMPTY_DATA constants
- Barrel exports all public API: createJsonlParser, applyPatch, parsePatchLine + types
- **Learnings:** Source is a direct port with only import path changes; `toRecord`/`toElement` casts are necessary because UIElement lacks index signature

## Task - streaming-2
- Ported useUITree hook, runtime value store, and supporting modules
- New files: `hooks.ts`, `runtime-value-store.ts`, `runtime-value-store-context.tsx`, `text-sanitizer.ts`, `action-types.ts`
- Updated `index.ts` barrel to export all new public API
- `action-types.ts` contains only ActionEvent/ActionDispatch types (lightweight dep for hooks); full action system is streaming-3
- `text-sanitizer.ts` ported early (needed by hooks for sanitizePatch)
- Fixed `unknown | undefined` → `unknown` in runtime-value-store to satisfy oxlint
- Tree-shakeability verified: React imports confined to hooks.ts and runtime-value-store-context.tsx
- **Learnings:** When porting hooks that depend on not-yet-ported modules, extract minimal type-only deps into separate files rather than stubbing

## Task - streaming-3
- Ported action system: handler factory, registry with built-ins, result processor, URL policy
- New files: `action-handler.ts`, `action-registry.ts`, `process-action-result.ts`, `url-policy.ts`
- `action-handler.ts` re-exports ActionEvent/ActionDispatch from `action-types.ts` (no duplication)
- `action-registry.ts` contains 4 built-in handlers: increment, decrement, submit_form, navigate
- `process-action-result.ts` dispatches ActionResult discriminated union to host callbacks, uses sanitizeUrl for external URLs
- `url-policy.ts` is a standalone pure module: allows http/https/relative, blocks javascript:/data:/file:/protocol-relative
- `text-sanitizer.ts` was already ported in streaming-2 (no work needed)
- Fixed `Array#sort()` → `Array#toSorted()` in action-registry to satisfy oxlint unicorn rule
- Changed `[kumo-stream]` console.warn prefix to `[kumo]` since this is now in the library
- Updated barrel `index.ts` with all new exports (types + values)
- **Learnings:** oxlint enforces `Array#toSorted()` over `Array#sort()` — use immutable array methods when porting

## Task - streaming-4
- Wired `@cloudflare/kumo/streaming` into build pipeline and package exports
- Files changed: `packages/kumo/vite.config.ts`, `packages/kumo/package.json`
- Added `streaming` entry to vite.config.ts lib entry map (alongside catalog, utils, registry)
- Added `./streaming` export to package.json with types + import paths
- Barrel `index.ts` already existed from streaming-1
- Build produces `dist/streaming.js` (JS) and `dist/src/streaming/index.d.ts` (types)
- All 177 export path validation tests pass including new streaming export
- **Learnings:** Top-level module export pattern: vite entry `name: resolve(__dirname, "src/name/index.ts")` + package.json `"./name": { "types": "./dist/src/name/index.d.ts", "import": "./dist/name.js" }`

## Task - streaming-5
- Ported 9 streaming engine test files to `packages/kumo/tests/streaming/`
- Files: `rfc6902.test.ts`, `jsonl-parser.test.ts`, `action-handler.test.ts`, `action-registry.test.ts`, `process-action-result.test.ts`, `runtime-value-store.test.ts`, `url-policy.test.ts`, `text-sanitizer.test.ts`, `streaming-integration.test.ts`
- 116 tests across 9 files, all passing on first run
- Import path changes: `../core/X` → `@/streaming/X` (vitest alias)
- Action types imported from `@/streaming/action-types` (not `action-handler`) to match module split
- Zero new dependencies added to package.json
- Typecheck and lint pass cleanly (no new warnings)
- **Learnings:** Test files use vitest `@/` alias not tsconfig paths; tsconfig excludes `**/*.test.ts` so LSP "cannot find module" errors are expected and harmless

## Task - prompt-1
- Ported system prompt template to `packages/kumo/src/catalog/system-prompt.ts`
- New file: `system-prompt.ts` with `buildSystemPrompt()` function and `SystemPromptOptions` interface
- Updated `index.ts` barrel to export `buildSystemPrompt` and `SystemPromptOptions`
- Template accepts optional `componentsSection` string (to be generated by prompt-2's prompt builder)
- Sections: design rules, accessibility, JSONL/RFC6902 format, UITree schema, emission strategy, action system, 2 examples (counter + form), closing rules
- Fixed duplicate rule #6 from original source (now numbered 1-8 correctly)
- Model-agnostic: no provider-specific instructions
- **Learnings:** System prompt sections decomposed into module-level constants for readability; `componentsSection` is injected rather than imported (avoids coupling to prompt builder that doesn't exist yet in catalog)

## Task - prompt-2
- Created `packages/kumo/src/catalog/prompt-builder.ts` with `buildComponentDocs()` function
- Ported from `kumo-stream/src/core/system-prompt-components.ts` with key decoupling:
  - Source depends on `KNOWN_TYPES` (generative module) + `ComponentPropsSchemas` (zod) — tightly coupled
  - Prompt builder takes raw `registryJson` as input — no dependency on generative or zod schemas
  - Prop filtering uses registry JSON directly instead of cross-referencing zod schemas
- Prop filtering: skips className, id, lang, title, on*, set*, aria-* prefixes
- Prop scoring: required (+3) > enum (+2) > interesting names (+1); props with score ≤0 excluded
- Top 10 props per component (configurable via `maxPropsPerComponent`)
- 9 category groups: Layout, Content, Interactive, Data Display, Navigation, Action, Feedback, Brand, Other
- Sub-component types: SelectOption, BreadcrumbsLink/Current/Separator, TableHeader/Head/Body/Row/Cell/Footer
- Type aliases: Textarea→InputArea, RadioGroup→Radio
- Synthetic types: Div (generic container), RadioItem (radio option)
- Optional `components` filter for subset output
- Exported `buildComponentDocs` and `PromptBuilderOptions` from catalog barrel
- Fixed `no-base-to-string` lint error: handle `prop.default` serialization for non-primitive types via `JSON.stringify`
- Files changed: `prompt-builder.ts` (new), `index.ts` (barrel update)
- **Learnings:** oxlint `no-base-to-string` catches `String(unknownValue)` — always type-narrow before stringifying; decoupling from `ComponentPropsSchemas`/zod means the prompt builder works without async schema loading

## Task - prompt-3
- Replaced stub `generatePrompt()` in catalog.ts with rich implementation using `buildSystemPrompt` + `buildComponentDocs`
- Added `GeneratePromptOptions` type: `components?`, `maxPropsPerComponent?`, `includeExamples?`
- Updated `KumoCatalog` interface to accept optional options parameter (backwards compatible)
- Added `loadRegistry()` function to async-load `component-registry.json` (cached, alongside schemas)
- Updated `initCatalog()` to load both schemas and registry in parallel
- Added `stripExampleSections()` helper for `includeExamples: false` option
- Exported `GeneratePromptOptions` type and `loadRegistry` from barrel
- Files changed: `catalog.ts`, `types.ts`, `index.ts`
- **Learnings:** `initCatalog()` is the natural place to load both schemas and registry JSON — the registry is needed for prompt generation but not validation, so loading it eagerly in `initCatalog` avoids a second async boundary at `generatePrompt` call time

## Task - generative-1
- Created generative map codegen script and `src/generative/` module
- Architecture: manifest-based codegen (pure data) + hand-written React wrappers
  - `scripts/component-registry/generative-map-generator.ts` — generator that reads registry, outputs manifest
  - `src/generative/component-manifest.ts` — AUTO-GENERATED manifest declaring direct components, sub-component aliases, type aliases, wrapper targets, excluded components, registry snapshot
  - `src/generative/stateful-wrappers.tsx` — hand-written: StatefulSelect, StatefulCheckbox, StatefulSwitch, StatefulTabs, StatefulCollapsible (ported from kumo-stream)
  - `src/generative/generative-wrappers.tsx` — hand-written: GenerativeSurface, GenerativeInput, GenerativeInputArea, GenerativeCloudflareLogo, GenerativeSelect (extracted from kumo-stream component-map)
  - `src/generative/component-map.ts` — assembles COMPONENT_MAP and KNOWN_TYPES from manifest + wrappers
  - `src/generative/index.ts` — barrel export
- Wired generator into `scripts/component-registry/index.ts` main() — runs atomically with registry/schemas/markdown
- 13 excluded components with documented reasons (complex overlays, portals, host-state-dependent)
- 40 entries in COMPONENT_MAP: 18 direct + 12 sub-component aliases + 5 stateful wrappers + 5 generative wrappers + 1 type alias (Textarea) + 1 synthetic (Div) — with overlaps from overrides
- Files changed: `scripts/component-registry/generative-map-generator.ts` (new), `scripts/component-registry/index.ts` (wiring), `src/generative/` (5 new files + 1 generated)
- **Learnings:** Generate data manifests not React code as strings. Hand-written React files import the manifest. `REGISTRY_COMPONENT_NAMES` in manifest enables drift detection in separate test task (generative-4).

## Task - generative-2
- Ported UITreeRenderer and element validator to `packages/kumo/src/generative/`
- New files: `ui-tree-renderer.tsx`, `element-validator.ts`
- Updated `index.ts` barrel with: UITreeRenderer, isRenderableTree, getUnknownTypes, normalizeSiblingFormRowGrids, validateElement, logValidationError, ElementValidationResult
- UITreeRenderer: recursive renderer with error boundaries, schema validation, action dispatch, runtime value capture, URL policy, Grid→GridItem wrapping, form-row normalization
- Element validator: validates props against Zod schemas from `ai/schemas.ts`, handles type aliases (Textarea→InputArea), skips sub-components with no schema
- Import changes: `./types` → `../streaming/types`, `./component-map` → `./component-map.js`, `./action-handler` → `../streaming/action-handler`, `./element-validator` → `./element-validator.js`, `./runtime-value-store*` → `../streaming/runtime-value-store*`, `./url-policy` → `../streaming/url-policy`, `@cloudflare/kumo/ai/schemas` → `../../ai/schemas.js`
- Changed `[kumo-stream]` console.warn → `[kumo]` in URL policy blocked link warning
- generative-wrappers.tsx already existed from generative-1 (no changes needed)
- **Learnings:** Cross-module imports within package use relative paths — `../streaming/` from generative, `../../ai/` from generative to ai schemas. The `ai/` directory is in tsconfig include so TS resolves it correctly.

## Task - generative-3
- Wired `@cloudflare/kumo/generative` into build pipeline and package exports
- Files changed: `packages/kumo/vite.config.ts`, `packages/kumo/package.json`, `packages/kumo/src/generative/component-map.ts`
- Added `generative` entry to vite.config.ts lib entry map (after streaming)
- Added `./generative` export to package.json with types + import paths
- Fixed eslint error in component-map.ts: removed `@typescript-eslint/no-explicit-any` disable comment (rule not configured in this project's eslint; only jsx-a11y rules active)
- Build produces `dist/generative.js` (18KB) and `dist/src/generative/index.d.ts` (types)
- All 747 tests pass including 129 package-json-validation tests covering new export
- **Learnings:** ESLint config only has jsx-a11y rules; `@typescript-eslint/*` rules are not configured. Don't use `eslint-disable-next-line @typescript-eslint/*` comments — they cause "Definition for rule not found" errors.

## Task - generative-4
- Created `packages/kumo/tests/generative/drift-detection.test.ts` with 36 tests across 7 describe blocks
- Tests cover: registry coverage, COMPONENT_MAP entry validity, stateful wrapper presence, generative wrapper presence, no stale entries, excluded component documentation, codegen staleness
- Codegen staleness test: dynamically imports `generateComponentManifest`, runs it against live registry JSON, compares output to checked-in `component-manifest.ts`
- React 19 `forwardRef` returns objects (not functions) — type checks use `function || object || string` not just `function || string`
- All 783 tests pass, typecheck clean, lint clean
- **Learnings:** React 19 forwardRef components have `typeof === "object"`, not `"function"`. When checking if a value is a valid React component, accept function/object/string. Codegen staleness tests should dynamic-import the generator and compare output vs checked-in file rather than hash-based checks.

## Task - generative-5
- Ported 9 generative rendering test files to `packages/kumo/tests/generative/`
- Files: `element-validator.test.ts`, `element-validation-rendering.test.tsx`, `stateful-wrappers.test.tsx`, `ui-tree-renderer-action.test.tsx`, `streaming-action-integration.test.tsx`, `use-ui-tree-on-action.test.tsx`, `runtime-value-capture.test.tsx`, `layout-normalization.test.tsx`, `component-map-new-entries.test.tsx`
- 63 new tests across 9 files, all passing (862 total)
- Import path changes: `../core/X` → `@/generative/X` or `@/streaming/X` (vitest alias)
- ActionEvent/ActionDispatch types imported from `@/streaming/action-types` (not action-handler)
- Removed `eslint-disable-next-line @typescript-eslint/no-explicit-any` comments (rule not configured)
- COMPONENT_MAP spy injection uses `Record<string, unknown>` cast instead of `any` cast
- Fixed vitest.config.ts: `tests/**/*.{test,spec}.ts` → `tests/**/*.{test,spec}.{ts,tsx}` to include tsx test files
- Typecheck, lint, and all 862 tests pass cleanly
- **Learnings:** vitest.config.ts `tests/` include glob was `.ts` only — needed `.{ts,tsx}` for tsx tests; cast COMPONENT_MAP via `Record<string, unknown>` not `any` for spy injection

## Task - loadable-1
- Ported UMD loadable entry point to `packages/kumo/src/loadable/`
- New files: `index.ts`, `action-dispatch.ts`, `theme.tsx`
- Import remapping: `../core/rfc6902` → `../streaming/rfc6902`, `../core/jsonl-parser` → `../streaming/jsonl-parser`, `../core/UITreeRenderer` → `../generative/ui-tree-renderer`, `../core/types` → `../streaming/types`, `../core/action-handler` → `../streaming/action-types`, `../core/runtime-value-store` → `../streaming/runtime-value-store`, `../core/action-registry` → `../streaming/action-registry`, `../core/process-action-result` → `../streaming/process-action-result`
- `action-dispatch.ts`: import from `../streaming/action-types` (not `../streaming/action-handler`) to use lightweight type-only dep
- `theme.tsx`: no import changes needed (only React imports)
- `index.ts`: window.CloudflareKumo API with 15+ methods; imports split across `../streaming/` (data layer) and `../generative/` (UITreeRenderer)
- No build wiring yet (separate task loadable-2 — UMD vite config + package.json exports)
- **Learnings:** Loadable module straddles streaming (patch/parser/actions/runtime) and generative (UITreeRenderer) — it's a thin orchestration layer, not a new domain. Action types come from `action-types.ts` not `action-handler.ts` to keep the type import lightweight.

## Task - loadable-2
- Created UMD Vite build config and wired package exports
- New file: `vite.loadable.config.ts`
- Modified: `package.json` (added `build:loadable` script, `./loadable/kumo-loadable.umd.js` and `./loadable/style.css` exports)
- Config: UMD format, `@tailwindcss/vite` for CSS processing, React bundled (not external), ES2017 target, `inlineDynamicImports: true`, `cssCodeSplit: false`
- No `@vitejs/plugin-react` needed — Vite's esbuild handles JSX via tsconfig `jsx: "react-jsx"`
- `@cloudflare/kumo/styles/standalone` aliased to source CSS so Tailwind plugin processes directives
- Output: `dist/loadable/kumo-loadable.umd.js` (1010KB raw, 303KB gzip) + `dist/loadable/style.css` (74KB raw, 13KB gzip) = ~316KB gzip total
- All 862 tests pass, typecheck clean, lint clean (0 errors)
- **Learnings:** UMD loadable build doesn't need `@vitejs/plugin-react` — esbuild's JSX transform suffices for production builds. The `@tailwindcss/vite` plugin is essential to process `@import "tailwindcss"` directives in standalone CSS. `"use client"` directive warnings from bundled deps are harmless in UMD context (no RSC).
