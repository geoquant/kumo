# Progress Log
PRD: agents-md-compliance
Started: 2026-02-21
Branch: geoquant/kumo-regression-prevention (DO NOT switch)

## Codebase Patterns
<!-- Consolidate reusable patterns here -->
- AGENTS.md locations: root, packages/kumo, packages/kumo-docs-astro, packages/kumo-figma, ci/
- All 5 files present as of task start
- Accurate counts: 38 components, 38 primitives, 44 demos + 2 non-demo, 3 blocks, 6 workflows, 6 lint rules
- Docs: 37 component pages, 3 block pages
- CLI commands: ls, doc, add, blocks, init, migrate, ai (7 total)
- Scoring candidates evaluated: lint/ (6 files, skip), .github/ (7 files, skip), kumo/scripts/ (20 files, child of existing), _examples/ (3 example projects, skip)
- VR (visual regression): in preview.yml + preview-deploy.yml, NOT pullrequest.yml. Informational only — never blocks merge.
- Lefthook pre-commit: `glob` filters staged files by extension, `{staged_files}` passes filtered paths to command
- oxlint no-primitive-colors rule only fires on JSX className/class attributes — plain .ts strings won't trigger it, need .tsx with JSX

---
<!-- Task logs below - APPEND ONLY -->

## Task - docs-1
- Created .bak snapshots of all 5 AGENTS.md files before regeneration
- Files: AGENTS.md.bak, packages/kumo/AGENTS.md.bak, packages/kumo-docs-astro/AGENTS.md.bak, packages/kumo-figma/AGENTS.md.bak, ci/AGENTS.md.bak
- Verified: md5 checksums match originals, line counts confirmed (131, 129, 95, 105, 90)
- **Learnings:** All AGENTS.md files are in expected locations per root AGENTS.md STRUCTURE section

## Task - docs-2
- Regenerated all 5 AGENTS.md files with corrected counts and current date/commit
- Key fixes: 35→38 components, 37→38 primitives, added 6 workflows section, added `ai` CLI command, 5→6 lint rules, added demo/block/page counts
- Root: 144 lines. Subdirs: 80, 69, 69, 70 lines (all within limits)
- Scoring: evaluated lint/, .github/, kumo/scripts/, _examples/ — none met threshold for new AGENTS.md
- Files changed: AGENTS.md, packages/kumo/AGENTS.md, packages/kumo-docs-astro/AGENTS.md, packages/kumo-figma/AGENTS.md, ci/AGENTS.md
- **Learnings:** Previous root AGENTS.md incorrectly stated "No GitHub Actions workflows checked into repo" — 6 exist at .github/workflows/. ci/AGENTS.md also incorrectly said "No workflow YAML checked in". Both stale claims fixed.

## Task - docs-3
- Verification-only task — no file changes needed
- Confirmed: root AGENTS.md lines 38-47 document all 6 workflows (reviewer, bonk, pullrequest, preview, preview-deploy, release)
- Confirmed: correct counts — 38 components (line 29), 38 primitives (line 139), 44+ demos (line 33), 3 blocks (line 30)
- Confirmed: no content duplication — root delegates detail to child files, child files cross-reference root
- **Learnings:** Duplication check pattern: root should summarize + delegate via "See child AGENTS.md"; child should have "Parent: See root AGENTS.md". Counts in both are OK if contextual (root in WHERE TO LOOK, child in STRUCTURE).

## Task - docs-4
- Verification-only task — no file changes needed
- Confirmed: packages/kumo/AGENTS.md line 16 lists `ai` in CLI commands, line 40 in WHERE TO LOOK table
- Confirmed: packages/kumo/AGENTS.md line 12 shows correct "38 UI components"
- Cross-verified: `ai.ts` exists in `src/command-line/commands/`, 38 component dirs exist
- **Learnings:** kumo/lint/ has 5 rule files (not 6) — `kumo-plugin.js` is the plugin entry, not a rule. Root AGENTS.md "6 custom JS rules" counts all files including plugin; kumo AGENTS.md "5 custom oxlint rules" counts only rules. Both accurate in their context.

## Task - docs-5
- Fixed ci/AGENTS.md VR gate reference: was `pullrequest.yml` with `skip-vr` bypass, actually `preview.yml` (informational, never blocks merge)
- Verified kumo-docs-astro/AGENTS.md counts all correct: 37 component pages, 3 block pages, 44 demos + 2 non-demo
- Files changed: ci/AGENTS.md
- **Learnings:** VR is in preview.yml (same-repo) and preview-deploy.yml (fork), NOT pullrequest.yml. It's a detection tool — posts before/after screenshots to PR comment — never a merge gate. No `skip-vr` label exists.

## Task - docs-6
- Merged regression prevention content back into packages/kumo/AGENTS.md after docs-2 regeneration lost it
- Added 3 WHERE TO LOOK rows: CSS class contract, browser compat guard, Tailwind conflict lint
- Added full "Regression Prevention Tests" subsection under Testing with table + explanation bullets
- tests/ structure in STRUCTURE section was already correct from regeneration (kept)
- Deleted all 5 .bak files (AGENTS.md.bak, packages/kumo/AGENTS.md.bak, packages/kumo-docs-astro/AGENTS.md.bak, packages/kumo-figma/AGENTS.md.bak, ci/AGENTS.md.bak)
- Files changed: packages/kumo/AGENTS.md (15 lines added), 5 .bak files deleted
- **Learnings:** Selective merge is better than wholesale restore. The .bak had 129 lines with some opinionated observations (DateRangePicker duplication, catalog race condition) that aren't appropriate for AGENTS.md. Final: 95 lines — above the 80-line guideline but justified by the regression prevention mandate.

## Task - docs-7
- Created INCIDENTS.md at repo root (31 lines)
- Framed as UI component library (not edge infra); explains no direct production traffic
- "Production-Adjacent Surfaces" table covers: npm package, docs site (kumo-ui.com), VR detection, CSS contract, browser compat
- No historical incidents; incident template with date, severity, summary, root cause, resolution, prevention
- Files created: INCIDENTS.md
- **Learnings:** VR is referenced as prevention mechanism in the table rather than a separate section — more natural since it's one of several CI-based protections alongside CSS contract and browser compat tests.

## Task - docs-8
- Created ARCHITECTURE.md at repo root (89 lines, under 100 limit)
- ASCII diagram shows 3-package unidirectional pipeline: docs → kumo → figma, plus ci/, lint/, workflows
- 5 sections: codegen pipeline, theming, publish flow, CI workflows
- References (not duplicates) all 4 child AGENTS.md files via markdown links
- Artifact bus pattern + VR detection documented in CI section
- Files created: ARCHITECTURE.md
- **Learnings:** ASCII art > mermaid for ARCHITECTURE.md — renders in plain text (git diff, terminal, any editor) without requiring a mermaid renderer. Keep diagrams readable at 80 columns.

## Task - ci-1
- Hardened /review workflow prompt in .github/workflows/reviewer.yml
- Restructured prompt into 4 sections: Context, Focus Areas, Auto-Flags, Review Mechanics
- Added: read ARCHITECTURE.md (structure, codegen pipeline, theming) and INCIDENTS.md (failure modes, prevention)
- Added auto-generated file flags: ai/schemas.ts, ai/component-registry.json, ai/component-registry.md, src/styles/theme-kumo.css, src/primitives/*
- Added scaffolding check: PLOP_INJECT_EXPORT marker in packages/kumo/src/index.ts
- Added changeset check: flag if packages/kumo/ changed but no .changeset/ file added
- Added regression prevention test references: CSS class contract, browser compat guard, Tailwind conflict lint
- Static prompt ~218 words ≈ ~290 tokens (well under ~1K limit)
- Files changed: .github/workflows/reviewer.yml
- **Learnings:** Structured prompt with ## headers is more maintainable than run-on paragraphs. Keeps each concern scannable and independently editable. The `prompt: |` YAML block scalar preserves markdown formatting.

## Task - ci-2
- Updated .opencode/agents/kumo.md with accurate counts and 4 new sections
- Fixed component count: 35→38 in Package Structure
- Added block count (3) and primitive count (38) to Package Structure tree
- Added CLI commands list to command-line/ tree comment
- Added `ai` command to Common Commands section
- Added "Regression Prevention Tests" section with test category table (css-contract, build, lint)
- Added "CI Protection" section: VR gate, changesets, oxlint
- Added "Incident Prevention" section: risk surfaces, link to INCIDENTS.md
- Added ARCHITECTURE.md reference after Package Structure
- Audited all numeric counts — no stale values remain
- Files changed: .opencode/agents/kumo.md (30 lines added, 214→244 lines)
- **Learnings:** The kumo.md agent file serves bonk (GitHub Actions AI agent). It needs to be self-contained enough for an agent with no prior context, so explicit counts and cross-references to docs (ARCHITECTURE.md, INCIDENTS.md) are valuable. Relative links (../../) work from .opencode/agents/ to repo root.

## Task - infra-1
- Added pre-commit oxlint hook to lefthook.yml
- Hook config: glob `*.{ts,tsx,js,jsx,astro}`, runs `pnpm oxlint {staged_files}`
- Lefthook install confirmed: detects both pre-commit and pre-push hooks
- Verified: staged `_test-lint-hook.tsx` with `bg-blue-500` in className → `kumo(no-primitive-colors)` error, hook exits non-zero
- Test file removed after verification
- Existing pre-push validate-changeset hook unchanged
- Files changed: lefthook.yml (6 lines added)
- **Learnings:** The no-primitive-colors rule only fires on JSXAttribute nodes (className/class). A plain .ts file with a color string won't trigger it — must use .tsx with actual JSX. Root .oxlintrc.json includes the shared custom plugin at ./packages/kumo/lint/kumo-plugin.js and has 3 rules (no-cross-package-imports, no-primitive-colors, no-tailwind-dark-variant).
