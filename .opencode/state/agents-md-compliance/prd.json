{
  "prdName": "agents-md-compliance",
  "branch": "geoquant/kumo-regression-prevention",
  "branchPolicy": "ALL work MUST stay on branch geoquant/kumo-regression-prevention. Do NOT create new branches. Do NOT switch branches.",
  "tasks": [
    {
      "id": "docs-1",
      "category": "docs",
      "description": "Snapshot existing AGENTS.md files before regeneration",
      "steps": [
        "Run: find . -name 'AGENTS.md' -not -path '*/node_modules/*' -exec cp {} {}.bak \\;",
        "Verify .bak files exist for: AGENTS.md, packages/kumo/AGENTS.md, packages/kumo-docs-astro/AGENTS.md, packages/kumo-figma/AGENTS.md, ci/AGENTS.md"
      ],
      "passes": true
    },
    {
      "id": "docs-2",
      "category": "docs",
      "description": "Regenerate all AGENTS.md files via index-knowledge --create-new",
      "steps": [
        "Root AGENTS.md exists with Generated: header containing current date and commit hash",
        "Root AGENTS.md is 50-150 lines",
        "All subdirectory AGENTS.md files are 30-80 lines each",
        "index-knowledge scoring evaluated lint/, .github/, packages/kumo/scripts/, _examples/ for new AGENTS.md"
      ],
      "passes": true
    },
    {
      "id": "docs-3",
      "category": "docs",
      "description": "Verify regenerated root AGENTS.md fixes all known gaps",
      "steps": [
        "Root AGENTS.md documents 6 GitHub Actions workflows (reviewer, bonk, pullrequest, preview, preview-deploy, release)",
        "Root AGENTS.md has correct counts: 38 components, 38 primitives, 44+ demos, 3 blocks",
        "No content duplication between parent and child AGENTS.md files"
      ],
      "passes": true
    },
    {
      "id": "docs-4",
      "category": "docs",
      "description": "Verify regenerated packages/kumo/AGENTS.md fixes all known gaps",
      "steps": [
        "packages/kumo/AGENTS.md documents CLI ai command",
        "packages/kumo/AGENTS.md has correct component count (38)"
      ],
      "passes": true
    },
    {
      "id": "docs-5",
      "category": "docs",
      "description": "Verify regenerated ci/AGENTS.md and docs AGENTS.md fix known gaps",
      "steps": [
        "ci/AGENTS.md documents VR gate CI job",
        "packages/kumo-docs-astro/AGENTS.md has correct demo/block/component page counts"
      ],
      "passes": true
    },
    {
      "id": "docs-6",
      "category": "docs",
      "description": "Merge back hand-added regression prevention content lost during regeneration",
      "steps": [
        "Diff each .bak file against regenerated output",
        "packages/kumo/AGENTS.md contains regression prevention tests section (CSS contract, browser compat, Tailwind conflict lint)",
        "packages/kumo/AGENTS.md contains expanded tests/ structure (css-contract, build, lint)",
        "packages/kumo/AGENTS.md contains WHERE TO LOOK rows for CSS class contract, browser compat guard, Tailwind conflict lint",
        "All .bak files deleted after merge complete"
      ],
      "passes": true
    },
    {
      "id": "docs-7",
      "category": "docs",
      "description": "Create INCIDENTS.md at repo root",
      "steps": [
        "File exists at repo root: INCIDENTS.md",
        "Header explains this is a UI component library (not edge infrastructure)",
        "Contains incident template with fields: date, severity, summary, root cause, resolution, prevention",
        "Accurately states no historical incidents",
        "References VR gate as prevention mechanism",
        "Cross-references docs site deployment as production-adjacent surface"
      ],
      "passes": true
    },
    {
      "id": "docs-8",
      "category": "docs",
      "description": "Create lightweight ARCHITECTURE.md at repo root",
      "steps": [
        "File exists at repo root: ARCHITECTURE.md",
        "Contains ASCII or mermaid diagram of monorepo package relationships",
        "Documents theming: semantic tokens -> light-dark() CSS custom properties -> automatic dark mode",
        "Documents 3-step codegen pipeline: docs demos -> registry -> Figma data (correct ordering)",
        "Documents publish flow: changesets -> version PR -> npm publish",
        "Documents CI: 6 GitHub Actions workflows, artifact bus pattern, VR gate",
        "References (not duplicates) each package's AGENTS.md for detailed conventions",
        "File is under 100 lines"
      ],
      "passes": false
    },
    {
      "id": "ci-1",
      "category": "ci",
      "description": "Harden /review workflow prompt in .github/workflows/reviewer.yml",
      "steps": [
        "Prompt instructs agent to read ARCHITECTURE.md for structural context",
        "Prompt instructs agent to read INCIDENTS.md for failure modes to watch for",
        "Prompt flags PRs editing auto-generated files (ai/schemas.ts, ai/component-registry.json, src/styles/theme-kumo.css, src/primitives/*)",
        "Prompt flags PRs adding components without scaffolding (checks PLOP_INJECT_EXPORT marker)",
        "Prompt flags PRs to packages/kumo/ missing a changeset",
        "Prompt references regression prevention test categories for component changes",
        "Static prompt text stays under ~1K tokens"
      ],
      "passes": false
    },
    {
      "id": "ci-2",
      "category": "ci",
      "description": "Update .opencode/agents/kumo.md with accurate counts and new sections",
      "steps": [
        "Component count updated from 35 to 38 in Package Structure section",
        "Regression prevention tests section added (CSS contract, browser compat, Tailwind conflict)",
        "VR gate mentioned as CI protection mechanism",
        "ARCHITECTURE.md referenced for structural overview",
        "CLI ai command added to Common Commands section",
        "Incident prevention focus section added per mandate spirit",
        "No stale numeric counts remain in the file"
      ],
      "passes": false
    },
    {
      "id": "infra-1",
      "category": "infra",
      "description": "Add pre-commit oxlint hook to lefthook.yml",
      "steps": [
        "lefthook.yml contains a pre-commit section",
        "oxlint command uses glob: '*.{ts,tsx,js,jsx,astro}'",
        "oxlint command runs: pnpm oxlint {staged_files}",
        "Stage a test .ts file containing bg-blue-500, verify pre-commit hook catches it",
        "Remove test file after verification"
      ],
      "passes": false
    },
    {
      "id": "infra-2",
      "category": "infra",
      "description": "Add pre-push AGENTS.md staleness warning to lefthook.yml",
      "steps": [
        "lefthook.yml pre-push section contains check-agents-staleness command",
        "Staleness check extracts commit hash from AGENTS.md Generated: header line",
        "Staleness check counts commits since that hash via git rev-list --count",
        "Warning triggers when >50 commits stale (does NOT fail the push)",
        "Staleness check skips on merge and rebase",
        "Existing validate-changeset pre-push hook unchanged and still functional"
      ],
      "passes": false
    },
    {
      "id": "docs-9",
      "category": "docs",
      "description": "Update README.md to reference ARCHITECTURE.md and INCIDENTS.md",
      "steps": [
        "README.md contains a reference/link to ARCHITECTURE.md",
        "README.md contains a reference/link to INCIDENTS.md"
      ],
      "passes": false
    }
  ],
  "context": {
    "patterns": [
      "AGENTS.md generation: .agents/skills/index-knowledge/SKILL.md (4-phase: discover, score, generate, review)",
      "Reviewer workflow: .github/workflows/reviewer.yml (inline prompt in 'Run Reviewer' step, ask-bonk action, Opus 4.6)",
      "Bonk agent config: .opencode/agents/kumo.md (agent: kumo in bonk.yml, 214 lines)",
      "Git hooks: lefthook.yml (pre-push validate-changeset only)",
      "Lefthook staged files: glob filters staged files, then {staged_files} receives filtered subset"
    ],
    "keyFiles": [
      "AGENTS.md",
      "packages/kumo/AGENTS.md",
      "packages/kumo-docs-astro/AGENTS.md",
      "packages/kumo-figma/AGENTS.md",
      "ci/AGENTS.md",
      ".github/workflows/reviewer.yml",
      ".github/workflows/bonk.yml",
      ".opencode/agents/kumo.md",
      "lefthook.yml",
      "README.md"
    ],
    "nonGoals": [
      "GitLab CI AI review bot (another team)",
      "AI approval as merge gate (Rajesh/Joaquin)",
      "Global review agent (company-level)",
      "Codex compliance blocking (Ryan's team)",
      "AGENTS.md for every directory (scoring determines)",
      "Headless opencode pre-push review (too slow for hook)"
    ]
  }
}
