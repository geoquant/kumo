# Progress Log
PRD: stack-cluster-layout-primitives
Started: 2026-02-19

## Codebase Patterns
- **Render prop (NOT polymorphic `as`)**: Use Link pattern — `useRender` from `@base-ui/react/use-render` + `mergeProps` from `@base-ui/react/merge-props`. Type: `useRender.ComponentProps<"div">`. No type casts needed. Consumer composes via `<Stack render={<section />}>`. Default: `<div />`.
- **Variant exports**: `KUMO_{NAME}_VARIANTS` (with `.classes` and `.description`) + `KUMO_{NAME}_DEFAULT_VARIANTS` as const objects. Derived types via `keyof typeof`.
- **Variant function**: `{name}Variants()` function using `cn()` to compose base classes + variant classes. Consumed by component and available as public API.
- **Component scaffolding**: Create `src/components/{name}/` with `{name}.tsx` + `index.ts`. Then update 3 files: `src/index.ts` (PLOP_INJECT_EXPORT), `vite.config.ts` (PLOP_INJECT_COMPONENT_ENTRY), `package.json` (exports map).
- **Gap token scale (Stack/Cluster)**: none→gap-0, xs→gap-1, sm→gap-2, base→gap-4, lg→gap-6, xl→gap-8. Different from Grid's responsive gap scale.

---
<!-- Task logs below - APPEND ONLY -->

## Task - component-1
- Implemented Stack component at `packages/kumo/src/components/stack/stack.tsx`
- Vertical flex layout with constrained gap (none/xs/sm/base/lg/xl) and align (start/center/end/stretch) props
- `render` prop via useRender (Base UI), forwardRef, displayName, cn() composition
- Replaced polymorphic `as` prop with `render` prop — zero type casts, full type inference
- Exported KUMO_STACK_VARIANTS, KUMO_STACK_DEFAULT_VARIANTS, stackVariants()
- Files changed:
  - `packages/kumo/src/components/stack/stack.tsx` (new)
  - `packages/kumo/src/components/stack/index.ts` (new)
  - `packages/kumo/src/index.ts` (barrel export at PLOP marker)
  - `packages/kumo/vite.config.ts` (build entry at PLOP marker)
  - `packages/kumo/package.json` (exports map entry)
- **Learnings:** Export path validation tests in `tests/imports/` will fail for new components until a build is run. This is expected — the `describe.skipIf(!isBuilt)` guard only skips when dist/ doesn't exist at all, not when a single new component is missing.

## Task - component-2
- Implemented Cluster component at `packages/kumo/src/components/cluster/cluster.tsx`
- Horizontal flex layout with constrained gap (none/xs/sm/base/lg/xl), justify (start/center/end/between), align (start/center/end/baseline/stretch), wrap (wrap/nowrap) props
- Same pattern as Stack: `render` prop via useRender, forwardRef, displayName, cn() composition
- Exported KUMO_CLUSTER_VARIANTS, KUMO_CLUSTER_DEFAULT_VARIANTS, clusterVariants()
- Files changed:
  - `packages/kumo/src/components/cluster/cluster.tsx` (new)
  - `packages/kumo/src/components/cluster/index.ts` (new)
  - `packages/kumo/src/index.ts` (barrel export at PLOP marker)
  - `packages/kumo/vite.config.ts` (build entry at PLOP marker)
  - `packages/kumo/package.json` (exports map entry)
- **Learnings:** Cluster is identical structure to Stack but with `flex` (no `flex-col`) as base class, plus `justify` and `wrap` variant axes. The shared gap scale confirms these are a matched pair.

## Task - component-3
- Verification task: confirmed Stack and Cluster share identical gap token scale (none→gap-0, xs→gap-1, sm→gap-2, base→gap-4, lg→gap-6, xl→gap-8)
- Grid gap scale confirmed unchanged: uses different tokens (none/sm/base/lg) with responsive behavior (e.g. `gap-2 md:gap-6 lg:gap-8`)
- No code changes needed — implementations from component-1 and component-2 already satisfied this
- **Learnings:** Grid uses a 4-value gap scale (none/sm/base/lg) with responsive classes, while Stack/Cluster use a 6-value scale (none/xs/sm/base/lg/xl) with static classes. These are intentionally different.

## Task - export-1
- Already completed during component-1 and component-2
- Barrel exports at `packages/kumo/src/index.ts` lines 204-222 export Stack, Cluster, and all variant/type symbols

## Task - export-2
- Already completed during component-1 and component-2
- Vite build entries at `packages/kumo/vite.config.ts` lines 190-197
- `pnpm --filter @cloudflare/kumo build` succeeds

## Task - demo-1
- Created `packages/kumo-docs-astro/src/components/demos/StackDemo.tsx`
- Three exported demos following GridDemo pattern:
  - `StackDemo()` — basic usage with default gap
  - `StackGapDemo()` — all 6 gap variants (none/xs/sm/base/lg/xl)
  - `StackAlignDemo()` — all 4 align variants (stretch/start/center/end)
- Uses `Surface` + `Text` from `@cloudflare/kumo` for visual items, `text-kumo-subtle` labels
- **Learnings:** Demo naming is load-bearing — function names must end with `Demo` suffix and file must be `{Component}Demo.tsx` for the codegen extraction pipeline to pick them up.

## Task - demo-2
- Created `packages/kumo-docs-astro/src/components/demos/ClusterDemo.tsx`
- Four exported demos:
  - `ClusterDemo()` — basic usage with default gap
  - `ClusterGapDemo()` — 4 representative gap variants (none/sm/base/xl)
  - `ClusterJustifyDemo()` — all 4 justify variants (start/center/end/between)
  - `ClusterWrapAlignDemo()` — wrap (wrap/nowrap) + all align variants (start/center/baseline/stretch)
- Uses mixed-size items to visually demonstrate alignment differences
- **Learnings:** Cluster demos need more items than Stack to show wrapping behavior. Using `max-w-xs` on the wrap demo container forces wrapping to be visible.

## Task - codegen-1
- Ran `codegen:demos` (225 demos from 45 files, Stack: 3, Cluster: 4 extracted)
- Ran `codegen:registry` (42 total: 39 components + 3 blocks, Stack + Cluster regenerated)
- Verified Stack in `ai/component-registry.json`: props = gap, align, render, children, className, id, lang, title
- Verified Cluster in `ai/component-registry.json`: props = gap, justify, align, wrap, render, children, className, id, lang, title
- Verified `ai/schemas.ts`: `StackPropsSchema` (line 669), `ClusterPropsSchema` (line 429), both in `KumoComponentType` union and schema maps
- Files changed (all auto-generated):
  - `packages/kumo/ai/component-registry.json`
  - `packages/kumo/ai/component-registry.md`
  - `packages/kumo/ai/schemas.ts`
- **Learnings:** `codegen:registry` in kumo already runs `codegen:demos` in docs internally as a pre-step. Running it separately first is safe (idempotent) but not strictly required. Pre-existing warnings (DatePicker, Table schema generation failures) are known issues with fallback handling — not related to Stack/Cluster.

## Task - integration-1
- Added Stack and Cluster imports + COMPONENT_MAP entries in `_examples/kumo-stream/src/core/component-map.ts`
- Both placed in "Layout" section alongside Surface and Grid
- UITreeRenderer resolves `type:"Stack"` and `type:"Cluster"` via `COMPONENT_MAP[type]` (line 149)
- `KNOWN_TYPES` set auto-derives from map keys, so `getUnknownTypes()` also recognizes them
- Files changed: `_examples/kumo-stream/src/core/component-map.ts`
- **Learnings:** component-map.ts is the single bridge between LLM JSON and React. Adding a component is: 1) import from @cloudflare/kumo, 2) add to COMPONENT_MAP object with matching key name. KNOWN_TYPES derives automatically.

## Task - integration-2
- Updated Layout section in `_examples/kumo-stream/src/core/system-prompt.ts` (lines 79-96)
- Added Stack: gap (6 values) + align (4 values) + usage guidance (vertical stacking)
- Added Cluster: gap (6 values) + justify (4 values) + align (5 values) + wrap (2 values) + usage guidance (horizontal rows)
- Demoted Div to "Escape hatch (AVOID — prefer Stack/Cluster/Grid)" with single-sentence guidance
- Surface and Grid remain unchanged
- Files changed: `_examples/kumo-stream/src/core/system-prompt.ts`
- **Learnings:** System prompt layout order matters for LLM attention: Surface → Stack → Cluster → Grid → Div puts the most useful primitives first and the escape hatch last, naturally steering the LLM toward constrained components.

## Task - integration-3
- Rewrote Example 2 (Doctor Appointment Form) in system prompt to use Stack/Cluster
- Added `card-stack` (Stack, gap:"lg") as card's single child — wraps header, form-grid, actions
- Added `header` (Stack, gap:"xs") to tightly pair heading + subtitle
- Replaced `actions` Div (`className:"flex justify-end gap-2 pt-4"`) with Cluster (`gap:"sm"`, `justify:"end"`)
- Zero Div usage remaining in Example 2
- Grid retained for form layout (2up) — correct tool for the job
- Files changed: `_examples/kumo-stream/src/core/system-prompt.ts`
- **Learnings:** Example 2 now demonstrates the idiomatic composition pattern: Surface → Stack (vertical sections) → Grid (form) + Cluster (actions). This teaches the LLM the intended hierarchy: Surface for containment, Stack for vertical flow, Cluster for horizontal groups, Grid for form fields.

## Task - test-1
- Fixed streaming integration test at line 282 in `_examples/kumo-stream/src/__tests__/streaming-integration.test.ts`
- Changed `el("layout-1", "Stack", { direction: "horizontal", gap: "4" }, ...)` → `el("layout-1", "Cluster", { gap: "base", wrap: "nowrap" }, ...)`
- Three fixes: 1) Stack→Cluster (horizontal layout), 2) removed invalid `direction` prop, 3) `gap: "4"`→`gap: "base"` (valid token)
- Test verifies JSONL parsing/tree-building, not React rendering — assertions on tree structure (root, element count, children arrays) remain unchanged
- All 8 tests in file pass
- Files changed: `_examples/kumo-stream/src/__tests__/streaming-integration.test.ts`
- **Learnings:** The test's `el()` helper creates raw UIElement objects for parser testing — component type and props aren't validated at this level. But using valid types/props is still important for test readability and as documentation of correct usage patterns.

## Task - build-1
- `pnpm --filter @cloudflare/kumo build` succeeds (library build + CSS + blocks + CLI)
- `pnpm --filter @cloudflare/kumo typecheck` clean — zero errors
- `pnpm typecheck` (workspace-wide): 14 pre-existing errors in kumo-docs-astro — all Phosphor `IconProps` type mismatches, unrelated to Stack/Cluster
- No code changes needed — verification task only
- **Learnings:** kumo-docs-astro has known Phosphor icon type errors (14 total). These predate this work and affect SearchDialog, SidebarNav, EmptyDemo, DialogDemo, FigmaPage, ResourceListDemo, and Heading components. All are `className`/`size`/`weight` prop mismatches against `IconProps`.

## Task - changeset-1
- Created `.changeset/stack-cluster-layout-primitives.md` with `@cloudflare/kumo: minor`
- Documents both Stack and Cluster components with prop signatures and usage examples
- Follows existing changeset style (cf. `date-picker-component.md` for minor component additions)
- Files changed: `.changeset/stack-cluster-layout-primitives.md` (new)
- **Learnings:** Changeset filenames can be descriptive (not just random slugs) — existing files like `date-picker-component.md` use readable names. The `pnpm changeset` CLI generates random slugs, but manual creation with descriptive names works fine.
