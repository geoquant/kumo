{
  "prdName": "stack-cluster-layout-primitives",
  "branch": "geoquant/streaming-ui",
  "tasks": [
    {
      "id": "component-1",
      "category": "component",
      "description": "Scaffold and implement Stack component following Link pattern: forwardRef, displayName, cn(), render prop (useRender), KUMO_STACK_VARIANTS and KUMO_STACK_DEFAULT_VARIANTS exports",
      "steps": [
        "Stack component exists at packages/kumo/src/components/stack/stack.tsx",
        "<Stack gap=\"base\"> renders display:flex; flex-direction:column with 16px gap",
        "gap prop accepts only \"none\" | \"xs\" | \"sm\" | \"base\" | \"lg\" | \"xl\"",
        "align prop accepts \"start\" | \"center\" | \"end\" | \"stretch\" (default: \"stretch\")",
        "render prop composes onto any element via useRender (default: <div />)",
        "className merges via cn()",
        "Component uses forwardRef and sets .displayName = \"Stack\"",
        "KUMO_STACK_VARIANTS and KUMO_STACK_DEFAULT_VARIANTS are exported"
      ],
      "passes": true
    },
    {
      "id": "component-2",
      "category": "component",
      "description": "Scaffold and implement Cluster component following Link pattern: forwardRef, displayName, cn(), render prop (useRender), KUMO_CLUSTER_VARIANTS and KUMO_CLUSTER_DEFAULT_VARIANTS exports",
      "steps": [
        "Cluster component exists at packages/kumo/src/components/cluster/cluster.tsx",
        "<Cluster gap=\"base\"> renders display:flex; flex-wrap:wrap with 16px gap",
        "gap prop accepts only \"none\" | \"xs\" | \"sm\" | \"base\" | \"lg\" | \"xl\"",
        "justify prop accepts \"start\" | \"center\" | \"end\" | \"between\" (default: \"start\")",
        "align prop accepts \"start\" | \"center\" | \"end\" | \"baseline\" | \"stretch\" (default: \"center\")",
        "wrap prop accepts \"wrap\" | \"nowrap\" (default: \"wrap\")",
        "render prop composes onto any element via useRender (default: <div />)",
        "className merges via cn()",
        "Component uses forwardRef and sets .displayName = \"Cluster\"",
        "KUMO_CLUSTER_VARIANTS and KUMO_CLUSTER_DEFAULT_VARIANTS are exported"
      ],
      "passes": true
    },
    {
      "id": "component-3",
      "category": "component",
      "description": "Unified gap token scale: Stack and Cluster share the same gap token to pixel mapping — none=0, xs=4px, sm=8px, base=16px, lg=24px, xl=32px. Grid's gap scale remains as-is.",
      "steps": [
        "Stack gap tokens map: none→gap-0, xs→gap-1, sm→gap-2, base→gap-4, lg→gap-6, xl→gap-8",
        "Cluster gap tokens map identically to Stack",
        "Grid's gap scale is unchanged (still has responsive behavior)"
      ],
      "passes": true
    },
    {
      "id": "export-1",
      "category": "export",
      "description": "Export Stack and Cluster from @cloudflare/kumo barrel index using PLOP_INJECT_EXPORT marker",
      "steps": [
        "import { Stack } from '@cloudflare/kumo' resolves correctly",
        "import { Cluster } from '@cloudflare/kumo' resolves correctly",
        "KUMO_STACK_VARIANTS, KUMO_STACK_DEFAULT_VARIANTS exported from package",
        "KUMO_CLUSTER_VARIANTS, KUMO_CLUSTER_DEFAULT_VARIANTS exported from package"
      ],
      "passes": true
    },
    {
      "id": "export-2",
      "category": "export",
      "description": "Add Stack and Cluster build entries in vite.config.ts using PLOP_INJECT_COMPONENT_ENTRY marker",
      "steps": [
        "Stack entry exists in vite.config.ts component entries",
        "Cluster entry exists in vite.config.ts component entries",
        "pnpm --filter @cloudflare/kumo build succeeds"
      ],
      "passes": true
    },
    {
      "id": "demo-1",
      "category": "demo",
      "description": "Create Stack demo component in kumo-docs-astro for the codegen pipeline",
      "steps": [
        "Demo file exists at packages/kumo-docs-astro/src/components/demos/ for Stack",
        "Demo shows basic Stack usage with gap variants",
        "Demo shows align prop usage"
      ],
      "passes": true
    },
    {
      "id": "demo-2",
      "category": "demo",
      "description": "Create Cluster demo component in kumo-docs-astro for the codegen pipeline",
      "steps": [
        "Demo file exists at packages/kumo-docs-astro/src/components/demos/ for Cluster",
        "Demo shows basic Cluster usage with gap and justify variants",
        "Demo shows wrap and align prop usage"
      ],
      "passes": true
    },
    {
      "id": "codegen-1",
      "category": "codegen",
      "description": "Run codegen pipeline: demos first, then registry. Verify Stack and Cluster appear in ai/component-registry.json and ai/schemas.ts",
      "steps": [
        "pnpm --filter @cloudflare/kumo codegen:registry succeeds",
        "Stack appears in ai/component-registry.json with correct props",
        "Cluster appears in ai/component-registry.json with correct props",
        "ai/schemas.ts includes Stack and Cluster Zod schemas"
      ],
      "passes": true
    },
    {
      "id": "integration-1",
      "category": "integration",
      "description": "Add Stack and Cluster to COMPONENT_MAP in kumo-stream so UITreeRenderer can resolve them",
      "steps": [
        "Stack is in COMPONENT_MAP at _examples/kumo-stream/src/core/component-map.ts",
        "Cluster is in COMPONENT_MAP at _examples/kumo-stream/src/core/component-map.ts",
        "UITreeRenderer resolves type:\"Stack\" to the Stack component",
        "UITreeRenderer resolves type:\"Cluster\" to the Cluster component"
      ],
      "passes": true
    },
    {
      "id": "integration-2",
      "category": "integration",
      "description": "Update system prompt Layout section to teach Stack/Cluster with constrained vocabulary and demote Div to escape hatch",
      "steps": [
        "System prompt at _examples/kumo-stream/src/core/system-prompt.ts has updated Layout section",
        "Stack documented with gap and align props and constrained values",
        "Cluster documented with gap, justify, align, wrap props and constrained values",
        "Div is described as \"Escape hatch (AVOID — prefer Stack/Cluster/Grid)\"",
        "Surface and Grid remain documented"
      ],
      "passes": true
    },
    {
      "id": "integration-3",
      "category": "integration",
      "description": "Update system prompt Example 2 (Doctor Appointment Form) to use Cluster for button row and Stack for card content",
      "steps": [
        "Example 2 in system prompt uses Stack for vertical layout sections",
        "Example 2 in system prompt uses Cluster for button rows",
        "Example 2 no longer uses Div for layout purposes"
      ],
      "passes": false
    },
    {
      "id": "test-1",
      "category": "testing",
      "description": "Fix streaming integration test at line ~282 to use Cluster (horizontal layout) with valid props instead of incorrect Stack reference",
      "steps": [
        "Test at _examples/kumo-stream/src/__tests__/streaming-integration.test.ts uses Cluster with valid props",
        "Test passes successfully"
      ],
      "passes": false
    },
    {
      "id": "build-1",
      "category": "build",
      "description": "Verify full build and typecheck pass",
      "steps": [
        "pnpm --filter @cloudflare/kumo build succeeds",
        "pnpm typecheck passes (or pre-existing errors only)"
      ],
      "passes": false
    },
    {
      "id": "changeset-1",
      "category": "changeset",
      "description": "Create changeset for minor version bump documenting Stack and Cluster addition",
      "steps": [
        "Changeset file exists in .changeset/",
        "Changeset references @cloudflare/kumo with minor bump",
        "Changeset describes Stack and Cluster layout primitives"
      ],
      "passes": false
    }
  ],
  "context": {
    "branch": "geoquant/streaming-ui — STAY ON THIS BRANCH. Do not create new branches or switch branches.",
    "patterns": [
      "Layout component pattern: packages/kumo/src/components/grid/grid.tsx — follow KUMO_GRID_VARIANTS const, typed gap/variant unions, forwardRef, displayName, cn() composition",
      "Polymorphic as prop pattern: packages/kumo/src/components/surface/surface.tsx",
      "Scaffolding: pnpm --filter @cloudflare/kumo new:component (preferred) or manual creation following Grid pattern",
      "Barrel exports: packages/kumo/src/index.ts uses PLOP_INJECT_EXPORT marker",
      "Build entries: packages/kumo/vite.config.ts uses PLOP_INJECT_COMPONENT_ENTRY marker",
      "Demo location: packages/kumo-docs-astro/src/components/demos/",
      "Codegen pipeline: demos first (codegen:demos in docs), then registry (codegen:registry in kumo)",
      "Styling: ONLY semantic tokens (bg-kumo-*, text-kumo-*). NEVER raw Tailwind colors. NEVER dark: variant.",
      "cn() utility for className composition"
    ],
    "keyFiles": [
      "packages/kumo/src/components/grid/grid.tsx",
      "packages/kumo/src/components/surface/surface.tsx",
      "packages/kumo/src/index.ts",
      "packages/kumo/vite.config.ts",
      "_examples/kumo-stream/src/core/component-map.ts",
      "_examples/kumo-stream/src/core/system-prompt.ts",
      "_examples/kumo-stream/src/core/UITreeRenderer.tsx",
      "_examples/kumo-stream/src/__tests__/streaming-integration.test.ts",
      "packages/kumo/ai/component-registry.json",
      "packages/kumo/ai/schemas.ts",
      "packages/kumo-docs-astro/src/components/demos/"
    ],
    "nonGoals": [
      "recursive prop — use nested Stacks instead",
      "splitAfter prop — use composition (Stack + Cluster) instead",
      "Center/Sidebar/Switcher/Cover primitives — future work",
      "Catalog module UIElement schema changes",
      "Figma plugin generators for Stack/Cluster",
      "A2UI protocol alignment",
      "Grid gap scale changes — Grid keeps its responsive behavior"
    ]
  }
}
