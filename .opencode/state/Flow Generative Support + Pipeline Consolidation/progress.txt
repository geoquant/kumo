# Progress Log
PRD: Flow Generative Support + Pipeline Consolidation
Started: 2026-02-27

## Codebase Patterns
<!-- Consolidate reusable patterns here -->
- Discovery fallback pattern: resolve from `index.ts` exports first, then map export/import identifiers to source files; this handles non-conventional component filenames safely.
- Manifest derivation pattern: emit unified runtime lookup tables from existing manifest primitives (`TYPE_ALIASES`, `SUB_COMPONENT_ALIASES`) so prompt/validator/map consumers read one generated SSOT.
- Prompt scope pattern: derive prompt component allowlist from `ALL_GENERATIVE_TYPES` and control token budget via a local `EXCLUDED_FROM_PROMPT` set, default-include everything else.
- Registry coverage pattern: add discovery integration tests that assert both detection and assigned category so codegen inclusion regressions fail fast.
- Manifest import pattern: cross-module imports from `catalog/` → `generative/component-manifest.js` are safe (no circular deps); use `TYPE_RESOLUTION_MAP` for registry ref derivation, `TYPE_ALIASES` for alias annotations.
- Synthetic sub-component pattern: sub-components without registry `subComponents` entries need `SYNTHETIC_TYPES` entries in prompt-builder with `category` field for correct prompt grouping; test via `buildComponentDocs` with component filter.
- Drift detection pattern: manifest-level invariant tests validate internal consistency (every registry component classified, no stale references, sub-component parent integrity) without needing to run codegen; codegen-time warnings catch stale references during `pnpm codegen:registry`.
- Wrapper bucket overlap: a component CAN appear in both STATEFUL_WRAPPER_TARGETS and GENERATIVE_WRAPPER_TARGETS (e.g. Select); but must NOT appear in DIRECT and a wrapper list, or EXCLUDED and a wrapper list. Wrapper targets are NOT in ALL_GENERATIVE_TYPES �� they enter the component map via wrapper loops.
- Playground preset pattern: `PRESET_PROMPTS` is `as const` array of `{ label, prompt }` in `_PlaygroundPage.tsx`; card-level presets generate single components, page-level presets generate full layouts with multiple component types. Prompts should reference generative type names (Flow, FlowParallel, FlowNode) explicitly to guide LLM output.

---
<!-- Task logs below - APPEND ONLY -->

## Task - [d1-discovery-fallback]
- Implemented and validated discovery fallback coverage for non-conventional components exported via `index.ts`.
- Files changed: `packages/kumo/scripts/component-registry/discovery.ts`, `packages/kumo/scripts/component-registry/discovery.test.ts`, `.opencode/state/Flow Generative Support + Pipeline Consolidation/prd.json`, `.opencode/state/Flow Generative Support + Pipeline Consolidation/progress.txt`.
- **Learnings:** fallback resolution should check `.tsx` and `.ts` source targets to avoid coupling discovery to UI-only file extensions.

## Task - [d4-manifest-ssot]
- Implemented unified manifest derivations in codegen: `TYPE_RESOLUTION_MAP` (alias + sub-component lookup) and `ALL_GENERATIVE_TYPES` (deduped sorted union).
- Files changed: `packages/kumo/scripts/component-registry/generative-map-generator.ts`, `packages/kumo/src/generative/component-manifest.ts`, `.opencode/state/Flow Generative Support + Pipeline Consolidation/prd.json`, `.opencode/state/Flow Generative Support + Pipeline Consolidation/progress.txt`.
- **Learnings:** keeping generated manifest tables sorted stabilizes downstream diffs and makes drift checks deterministic.

## Task - [d7-prompt-components-auto]
- Replaced manual prompt component list with a manifest-derived allowlist (`ALL_GENERATIVE_TYPES`) filtered by `EXCLUDED_FROM_PROMPT`; exported `ALL_GENERATIVE_TYPES` from the generative barrel for docs usage.
- Files changed: `packages/kumo-docs-astro/src/lib/playground.ts`, `packages/kumo/src/generative/index.ts`, `packages/kumo-docs-astro/src/components/SearchDialog.tsx`, `.opencode/state/Flow Generative Support + Pipeline Consolidation/prd.json`, `.opencode/state/Flow Generative Support + Pipeline Consolidation/progress.txt`.
- **Learnings:** docs package consumes `@cloudflare/kumo/generative` through built type exports, so barrel export updates must propagate to dist types before Astro typecheck resolves new symbols.

## Task - [d2-flow-registry]
- Added discovery regression coverage for Flow fallback resolution to verify `discoverFromDir` emits `Flow` in `Layout` and preserves `flow/diagram.tsx` source mapping.
- Files changed: `packages/kumo/scripts/component-registry/discovery.test.ts`, `.opencode/state/Flow Generative Support + Pipeline Consolidation/prd.json`, `.opencode/state/Flow Generative Support + Pipeline Consolidation/progress.txt`.
- **Learnings:** category assignment should be asserted at discovery-layer tests, not only in generated artifacts, to catch mapping drift earlier than codegen snapshots.

## Task - [d3-flow-subcomponents]
- Already implemented: FlowNode and FlowParallel in SUB_COMPONENT_OVERRIDES (generative-map-generator.ts:95-96), propagated to component-manifest.ts SUB_COMPONENT_ALIASES, TYPE_RESOLUTION_MAP, and ALL_GENERATIVE_TYPES. component-map.ts picks them up programmatically via the SUB_COMPONENT_ALIASES loop.
- Files verified: `packages/kumo/scripts/component-registry/generative-map-generator.ts`, `packages/kumo/src/generative/component-manifest.ts`, `packages/kumo/src/generative/component-map.ts`
- Verification: 1006 tests pass, typecheck clean, drift-detection.test.ts confirms "every sub-component alias has a map entry"
- **Learnings:** task was implemented in prior session but PRD not updated; compound components need entries in SUB_COMPONENT_OVERRIDES to be flattened as top-level generative types.

## Task - [d8-flow-component-map]
- Added explicit Flow wiring verification to `component-map-new-entries.test.tsx`: 3 KNOWN_TYPES assertions (Flow, FlowNode, FlowParallel), 3 COMPONENT_MAP entry assertions with type checks, and 1 UITreeRenderer rendering test with nested Flow → FlowNode → FlowParallel tree.
- Files changed: `packages/kumo/tests/generative/component-map-new-entries.test.tsx`
- Verification: 1013 tests pass (7 new), typecheck clean
- **Learnings:** compound components wired via manifest loops don't appear by name in component-map.ts source — explicit per-component rendering tests are needed to catch sub-component resolution failures (e.g. `Flow.Node` not accessible on the namespace import).

## Task - [d5-prompt-from-manifest]
- Replaced hardcoded `UI_TYPE_TO_REGISTRY_REF` in `prompt-builder.ts` with derivation from manifest's `TYPE_RESOLUTION_MAP`. Replaced hardcoded alias annotations (`uiType === "Textarea"` conditionals) with dynamic lookup from `TYPE_ALIASES`.
- Files changed: `packages/kumo/src/catalog/prompt-builder.ts`
- Behavioral changes: FlowNode/FlowParallel/RadioItem now in resolution map; RadioGroup resolves as `Radio.Group` sub-component (correct semantic) rather than aliasing to `Radio` parent. RadioGroup won't show prompt docs if registry lacks `Radio.Group` sub-component entry, but `Radio` itself covers the parent docs.
- Verification: 1013 tests pass, typecheck clean, lint 0 errors
- **Learnings:** `TYPE_RESOLUTION_MAP` field names differ from prompt-builder's `RegistryRef` (`registryComponent` vs `component`); mapping at derivation time avoids leaking manifest field names into consumers.

## Task - [d6-validator-from-manifest]
- Replaced hardcoded `TYPE_TO_SCHEMA_KEY` in `element-validator.ts` with derivation from manifest's `TYPE_ALIASES` and `SUB_COMPONENT_ALIASES`. Added `VALIDATED_SUB_COMPONENTS` set for sub-components that should validate against parent schema (RadioGroup → Radio).
- Files changed: `packages/kumo/src/generative/element-validator.ts`
- Behavioral changes: new sub-components from manifest (FlowNode, FlowParallel, BreadcrumbsCurrent, BreadcrumbsLink, BreadcrumbsSeparator) now skip validation explicitly rather than falling through as unknown types. Net behavior identical.
- Verification: 1013 tests pass, typecheck clean, lint 0 errors
- **Learnings:** sub-component → parent schema validation only makes sense when the sub-component conceptually wraps the parent (RadioGroup → Radio). Structural sub-components (TableRow, SelectOption) have no prop overlap with parent schemas — validating them against the parent would cause false failures.

## Task - [d9-flow-prompt-docs]
- Added `FlowNode` and `FlowParallel` synthetic entries to prompt-builder's `SYNTHETIC_TYPES` with `category: "Layout"` for correct grouping. Extended `SyntheticEntry` interface with optional `category` field. Added Flow composition hint. Added 4 prompt contract tests verifying Flow docs appear under Layout heading.
- Files changed: `packages/kumo/src/catalog/prompt-builder.ts`, `packages/kumo/tests/generative/prompt-contracts.test.ts`
- Verification: 1017 tests pass (4 new), typecheck clean, lint 0 errors
- **Learnings:** sub-components without registry `subComponents` entries resolve to `null` in `resolveRegistryEntry` and are silently dropped from prompt output — they MUST have synthetic entries or they won't appear in LLM context. The `category` field on synthetics enables proper prompt group assignment without hardcoding type names in `groupForType`.

## Task - [d11-drift-detection]
- Added `drift-detection.test.ts` (19 tests) validating manifest internal consistency: registry coverage (every component classified in at least one bucket), no bucket conflicts (direct vs excluded, direct vs wrapper, excluded vs wrapper), sub-component integrity (parents exist, aliases in resolution map), phantom detection (stale exclusions/wrappers/aliases), ALL_GENERATIVE_TYPES completeness, and wrapper target validity.
- Added codegen-time drift detection in `generateComponentManifest` — logs warnings to stderr for stale exclusions, stale wrapper targets, and orphaned sub-component parents during `pnpm codegen:registry`.
- Files changed: `packages/kumo/scripts/component-registry/drift-detection.test.ts` (new), `packages/kumo/scripts/component-registry/generative-map-generator.ts`
- Verification: 1036 tests pass (19 new), typecheck clean, lint 0 errors in changed files
- **Learnings:** `computeDirectComponents` makes "unclassified" structurally impossible — anything not excluded/stateful/generative IS direct by construction. Real drift risks are stale references and orphaned sub-component parents, not missing classifications. Wrapper buckets can overlap (Select is both stateful and generative).

## Task - [d10-workers-flow-preset]
- Added "Workers flow" pill preset to `PRESET_PROMPTS` in `_PlaygroundPage.tsx`. Prompt describes a two-section page: a Flow diagram (Client Request → WAF Rules/Rate Limiting parallel → my-worker → KV Store/D1 Database parallel → Response) above a bindings Table (MY_KV, MY_DB, AUTH_SERVICE, ASSETS).
- Files changed: `packages/kumo-docs-astro/src/components/demos/_PlaygroundPage.tsx`
- Verification: typecheck 0 errors, 1036 tests pass, lint 0 errors in changed file
- **Learnings:** page-level presets work best when they combine multiple generative types (Flow + Table) to demonstrate cross-component composition. Using explicit generative type names in prompts (FlowParallel, not "parallel branch") gives the LLM stronger signal for correct component selection.

## Task - [verify-manifest-integration]
- Added `manifest-integration.test.ts` (18 tests) validating cross-cutting contracts between component-manifest.ts → element-validator.ts and component-manifest.ts → prompt-builder.ts. Three test suites: manifest→validator (7 tests: alias schema resolution, alias validation routing, sub-component pass-through, direct component schema coverage, Div synthetic), manifest→prompt-builder (4 tests: resolution map → prompt docs, alias annotations, direct component docs, synthetic type docs), cross-consumer consistency (7 tests: resolution map supersets, ALL_GENERATIVE_TYPES handling in both consumers, alias target agreement, sub-component parent consistency).
- Files changed: `packages/kumo/tests/generative/manifest-integration.test.ts` (new)
- Verification: 1054 tests pass (18 new), typecheck 0 errors, lint clean
- **Learnings:** RadioGroup is in VALIDATED_SUB_COMPONENTS — it validates against Radio parent schema, not null pass-through. Integration tests should assert "no throw" rather than "valid=true" for sub-components with parent-schema validation, since empty props may legitimately fail the parent schema. `Object.entries()` on `as const` objects yields `unknown` values — iterate with `Object.keys()` + indexed access for type safety.
