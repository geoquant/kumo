# Progress Log
PRD: Flow Generative Support + Pipeline Consolidation
Started: 2026-02-27

## Codebase Patterns
<!-- Consolidate reusable patterns here -->
- Discovery fallback pattern: resolve from `index.ts` exports first, then map export/import identifiers to source files; this handles non-conventional component filenames safely.
- Manifest derivation pattern: emit unified runtime lookup tables from existing manifest primitives (`TYPE_ALIASES`, `SUB_COMPONENT_ALIASES`) so prompt/validator/map consumers read one generated SSOT.
- Prompt scope pattern: derive prompt component allowlist from `ALL_GENERATIVE_TYPES` and control token budget via a local `EXCLUDED_FROM_PROMPT` set, default-include everything else.
- Registry coverage pattern: add discovery integration tests that assert both detection and assigned category so codegen inclusion regressions fail fast.

---
<!-- Task logs below - APPEND ONLY -->

## Task - [d1-discovery-fallback]
- Implemented and validated discovery fallback coverage for non-conventional components exported via `index.ts`.
- Files changed: `packages/kumo/scripts/component-registry/discovery.ts`, `packages/kumo/scripts/component-registry/discovery.test.ts`, `.opencode/state/Flow Generative Support + Pipeline Consolidation/prd.json`, `.opencode/state/Flow Generative Support + Pipeline Consolidation/progress.txt`.
- **Learnings:** fallback resolution should check `.tsx` and `.ts` source targets to avoid coupling discovery to UI-only file extensions.

## Task - [d4-manifest-ssot]
- Implemented unified manifest derivations in codegen: `TYPE_RESOLUTION_MAP` (alias + sub-component lookup) and `ALL_GENERATIVE_TYPES` (deduped sorted union).
- Files changed: `packages/kumo/scripts/component-registry/generative-map-generator.ts`, `packages/kumo/src/generative/component-manifest.ts`, `.opencode/state/Flow Generative Support + Pipeline Consolidation/prd.json`, `.opencode/state/Flow Generative Support + Pipeline Consolidation/progress.txt`.
- **Learnings:** keeping generated manifest tables sorted stabilizes downstream diffs and makes drift checks deterministic.

## Task - [d7-prompt-components-auto]
- Replaced manual prompt component list with a manifest-derived allowlist (`ALL_GENERATIVE_TYPES`) filtered by `EXCLUDED_FROM_PROMPT`; exported `ALL_GENERATIVE_TYPES` from the generative barrel for docs usage.
- Files changed: `packages/kumo-docs-astro/src/lib/playground.ts`, `packages/kumo/src/generative/index.ts`, `packages/kumo-docs-astro/src/components/SearchDialog.tsx`, `.opencode/state/Flow Generative Support + Pipeline Consolidation/prd.json`, `.opencode/state/Flow Generative Support + Pipeline Consolidation/progress.txt`.
- **Learnings:** docs package consumes `@cloudflare/kumo/generative` through built type exports, so barrel export updates must propagate to dist types before Astro typecheck resolves new symbols.

## Task - [d2-flow-registry]
- Added discovery regression coverage for Flow fallback resolution to verify `discoverFromDir` emits `Flow` in `Layout` and preserves `flow/diagram.tsx` source mapping.
- Files changed: `packages/kumo/scripts/component-registry/discovery.test.ts`, `.opencode/state/Flow Generative Support + Pipeline Consolidation/prd.json`, `.opencode/state/Flow Generative Support + Pipeline Consolidation/progress.txt`.
- **Learnings:** category assignment should be asserted at discovery-layer tests, not only in generated artifacts, to catch mapping drift earlier than codegen snapshots.

## Task - [d3-flow-subcomponents]
- Already implemented: FlowNode and FlowParallel in SUB_COMPONENT_OVERRIDES (generative-map-generator.ts:95-96), propagated to component-manifest.ts SUB_COMPONENT_ALIASES, TYPE_RESOLUTION_MAP, and ALL_GENERATIVE_TYPES. component-map.ts picks them up programmatically via the SUB_COMPONENT_ALIASES loop.
- Files verified: `packages/kumo/scripts/component-registry/generative-map-generator.ts`, `packages/kumo/src/generative/component-manifest.ts`, `packages/kumo/src/generative/component-map.ts`
- Verification: 1006 tests pass, typecheck clean, drift-detection.test.ts confirms "every sub-component alias has a map entry"
- **Learnings:** task was implemented in prior session but PRD not updated; compound components need entries in SUB_COMPONENT_OVERRIDES to be flattened as top-level generative types.
