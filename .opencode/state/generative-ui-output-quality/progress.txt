# Progress Log
PRD: generative-ui-output-quality
Started: 2026-02-21

## Codebase Patterns
- **JSONL → UITree pipeline**: `createJsonlParser().push(chunk)` → `JsonPatchOp[]` → `applyPatch(tree, op)` → new `UITree`. Parser in `src/streaming/jsonl-parser.ts`, patch engine in `src/streaming/rfc6902.ts`.
- **UITree is flat**: `{ root: string, elements: Record<string, UIElement> }`. Children referenced by key arrays, not nesting.
- **UIElement**: `{ key, type, props, children?: string[], parentKey?: string }`. Types map to COMPONENT_MAP entries.
- **COMPONENT_MAP layers**: direct (18) → sub-component aliases (12) → type aliases (1) → generative wrappers (8) → stateful wrappers (5) → synthetic (1). In `src/generative/component-map.ts`.
- **Validation flow**: `validateElement()` checks props against Zod schemas from `ai/schemas.ts`. `repairElement()` strips invalid top-level props. Sub-components (TableRow, SelectOption) skip validation.
- **Test pattern**: Vitest with `@/` path aliases resolved at runtime (LSP shows errors but tests run fine). `happy-dom` environment.
- **Generative wrapper pattern**: `forwardRef`, read prop, default if missing, delegate to real component. See `src/generative/generative-wrappers.tsx`.
- **Normalization pattern**: Functions like `normalizeSiblingFormRowGrids` mutate tree in `useMemo` chain in `ui-tree-renderer.tsx:107`.
- **Branch**: `geoquant/streaming-ui` — do NOT change branches.

---

## Audit: 2026-02-21

### Status per PRD Task

| ID            | Task                                | Status  |
|---------------|-------------------------------------|---------|
| testing-1     | Structural graders + fixtures       | DONE    |
| prompt-1      | 3 new few-shot examples             | DONE    |
| prompt-2      | Anti-patterns + composition recipes | DONE    |
| prompt-3      | Prompt builder enhancements         | DONE    |
| generative-1  | GenerativeGrid wrapper              | MISSING |
| generative-2  | GenerativeStack wrapper             | MISSING |
| generative-3  | GenerativeText wrapper              | MISSING |
| validator-1   | ENUM_COERCION_MAP + pre-Zod coerce  | MISSING |
| validator-2   | normalizeSurfaceOrphans()           | MISSING |
| endpoint-1    | Chat endpoint maxProps + components | PARTIAL (maxProps=6, Field/Label/ClipboardText absent) |
| integration-1 | Full integration verification       | MISSING |

### Existing Infrastructure
- 5 generative wrappers: Surface, Input, InputArea, CloudflareLogo, Select
- 3 few-shot examples: user-card, form, table
- INTERESTING_PROP_NAMES scoring exists (+1 tier)
- normalizeSiblingFormRowGrids() normalization exists (pattern to follow)
- repairElement() strips invalid props (coercion layer goes before this)
- 11 generative test files (structural graders added)

---

## Task - testing-1
- Implemented structural graders: `parseJsonlToTree()`, `walkTree()`, `gradeTree()` with 8 quality rules
- Created 4 JSONL fixture files: user-card, settings-form, counter, pricing-table
- 27 tests total: 2 parseJsonlToTree, 1 walkTree, 24 gradeTree (8 rule pass/fail + 4 fixture sweep)
- Files changed:
  - `tests/generative/structural-graders.test.ts` (new, ~595 lines)
  - `tests/generative/fixtures/user-card.jsonl` (new)
  - `tests/generative/fixtures/settings-form.jsonl` (new)
  - `tests/generative/fixtures/counter.jsonl` (new)
  - `tests/generative/fixtures/pricing-table.jsonl` (new)
- **Learnings:**
  - Orphan detection must run outside `walkTree` — orphans are by definition unreachable from root
  - `Object.values(tree.elements)` returns `unknown` in strict TS; cast to `UIElement[]`
   - Fixtures derived from system-prompt.ts examples ensure consistency between prompt examples and grader expectations

## Task - prompt-1
- Added 3 new few-shot examples to `system-prompt.ts`: EXAMPLE_DASHBOARD, EXAMPLE_LIST, EXAMPLE_EMPTY_STATE
- All follow canonical `Surface > Stack > [children]` pattern with proper gap values
- Dashboard: `Surface > Stack(gap=lg) > [heading, Grid(variant=4up, gap=base) > [Surface(color=neutral) > Stack(gap=sm) > [label, value], ...]]`
- List: `Surface > Stack(gap=lg) > [heading, Table with Badge in status cells, Cluster(gap=sm) action buttons]`
- Empty state: `Surface > Stack(gap=lg, align=center) > [Empty(title, description), Button(primary)]`
- Updated buildSystemPrompt() sections array and docstring (now 6 total examples)
- Files changed:
  - `packages/kumo/src/catalog/system-prompt.ts` (3 new constants + sections array update)
- **Learnings:**
  - Badge only supports `variant` values: primary, secondary, destructive, outline, beta — no "success"/"error"/"warning"
  - Empty component uses `title` and `description` string props (not children for text content)
  - Grid `variant="4up"` + `gap="base"` is the canonical stat grid pattern
  - Surface accepts `color` prop (e.g. "neutral") for visual differentiation of nested cards

## Task - prompt-2
- Added `LAYOUT_ANTI_PATTERNS` section: 4 NEVER rules targeting common LLM layout mistakes (orphan Surface children, unconfigured Grid, nested Surface-in-Surface, unnecessary Div)
- Added `COMPOSITION_RECIPES` section: markdown table with 6 proven patterns (section header, stat grid, form group, action bar, key-value pair, status list row) + prop usage guidance subsection
- Prop guidance covers Stack.gap, Grid.variant, Cluster.justify, Surface usage patterns
- Both sections wired into buildSystemPrompt() between DESIGN_RULES and ACCESSIBILITY (logical placement — layout rules before format rules)
- Files changed:
  - `packages/kumo/src/catalog/system-prompt.ts` (2 new constants + sections array + docstring update)
- **Learnings:**
  - Surface does NOT have a `color` prop in Zod schema — the PRD step "Surface.color" is aspirational; real guidance focuses on Surface as container (delegate layout to inner Stack/Grid)
  - Placing anti-patterns before examples is strategic: LLMs weigh early instructions more heavily
  - Composition recipes as a markdown table is efficient for token usage vs. prose explanations

## Task - prompt-3
- Added `LAYOUT_CRITICAL_PROP_NAMES` set (`gap`, `justify`) with +2 scoring tier to `prompt-builder.ts`
- Moved `gap` and `justify` from INTERESTING_PROP_NAMES to LAYOUT_CRITICAL_PROP_NAMES (avoids double-counting)
- Added `color` and `layout` to INTERESTING_PROP_NAMES (+1 tier)
- Updated `scoreProp()` to sum: required(+3) + enum(+2) + layout-critical(+2) + interesting(+1)
- Added `COMPOSITION_HINTS` record mapping Surface, Grid, Stack, Cluster to usage hint strings
- Hints render as `  Hint: ...` line right after the component description in buildComponentDocs() output
- Verified: gap and justify now appear in top-N props for Stack (score=4), Grid (score=4), Cluster (score=4)
- Files changed:
  - `packages/kumo/src/catalog/prompt-builder.ts` (LAYOUT_CRITICAL_PROP_NAMES, COMPOSITION_HINTS, scoreProp update, hint rendering)
- **Learnings:**
  - Scoring tiers: required(+3) > enum(+2) = layout-critical(+2) > interesting(+1). A required enum prop scores 5; an optional layout-critical enum scores 4.
  - `gap` and `justify` were already in INTERESTING_PROP_NAMES — moved to LAYOUT_CRITICAL to avoid double-counting (+2 replaces +1, net gain +1)
  - Hints are indented with 2 spaces to visually nest under the component description bullet

## Task - generative-1, generative-2, generative-3
- Implemented 3 generative wrappers: GenerativeGrid, GenerativeStack, GenerativeText
- GenerativeGrid: defaults `variant="2up"` when both `variant` and `columns` are missing; defaults `gap="base"` when missing
- GenerativeStack: defaults `gap="base"` when missing
- GenerativeText: defaults `variant="body"` when missing; uses cast to `React.ComponentType<Record<string, unknown>>` because Text uses `DANGEROUS_className` not `className`
- All 3 registered in COMPONENT_MAP (layer 4, generative wrappers now 8 total)
- All use `forwardRef` pattern and have `displayName` set
- Files changed:
  - `packages/kumo/src/generative/generative-wrappers.tsx` (3 new wrapper components)
  - `packages/kumo/src/generative/component-map.ts` (3 new imports + 3 map registrations)
- **Learnings:**
  - Text component omits `className` from its public API; uses `DANGEROUS_className` instead. Generative wrappers for Text skip the `cn(readClassName(props))` pattern.
  - Grid does not have a real `columns` prop in the component — but LLMs may hallucinate it. Checking for `columns` prevents overriding LLM intent when it tries to use custom columns.
  - Defaults spread BEFORE `...stripClassName(props)` so explicit LLM values override the defaults via object spread semantics.
