{
  "prdName": "generative-ui-output-quality",
  "tasks": [
    {
      "id": "testing-1",
      "category": "testing",
      "description": "Structural graders validate UITree output against 8 quality rules using static JSONL fixtures",
      "steps": [
        "tests/generative/structural-graders.test.ts exists",
        "4 JSONL fixture files exist in tests/generative/fixtures/ (user-card, settings-form, counter, pricing-table)",
        "parseJsonlToTree() builds UITree from JSONL string using createJsonlParser + applyPatch",
        "walkTree() provides depth-first traversal with (element, depth, parentKey) visitor",
        "gradeTree() runs all 8 rules and returns pass/fail per rule",
        "valid-component-types: all element types exist in COMPONENT_MAP",
        "valid-prop-values: enum props contain only valid values (via Zod schemas)",
        "required-props: Text elements have children, form elements have labels",
        "canonical-layout: root Surface wraps children in Stack",
        "no-orphan-nodes: every non-root element is referenced by a parent's children array",
        "a11y-labels: Input, Textarea, Select, Checkbox, Switch, RadioGroup have label/aria-label",
        "depth-limit: no element nesting deeper than 8 levels",
        "no-redundant-children: props.children is not an array",
        "All 8 grader rules pass on all 4 fixture files",
        "pnpm --filter @cloudflare/kumo test passes"
      ],
      "passes": true
    },
    {
      "id": "prompt-1",
      "category": "prompt",
      "description": "System prompt contains 3 new few-shot examples covering dashboard, list, and empty state archetypes",
      "steps": [
        "EXAMPLE_DASHBOARD constant added to system-prompt.ts with Grid(variant='4up') > Surface > Stack > stat pattern",
        "EXAMPLE_LIST constant added with Table + Badge in cells + Cluster action buttons",
        "EXAMPLE_EMPTY_STATE constant added with Empty component + Button(primary)",
        "All 3 new examples follow canonical Surface > Stack pattern",
        "All 3 new examples use proper gap values",
        "All examples included in buildSystemPrompt() sections array",
        "Total examples: 6 (3 existing + 3 new)"
      ],
      "passes": true
    },
    {
      "id": "prompt-2",
      "category": "prompt",
      "description": "System prompt includes explicit layout anti-patterns and composition recipes",
      "steps": [
        "Layout Anti-Patterns section added with 4 NEVER rules",
        "NEVER put multiple children directly in Surface without Stack wrapper",
        "NEVER use Grid without specifying variant or columns",
        "NEVER nest Surface inside Surface without Grid between them",
        "NEVER use Div when Stack, Grid, or Cluster can express the intent",
        "Composition Recipes table added with 6 patterns (section header, stat grid, form group, action bar, key-value pair, status list row)",
        "Prop usage guidance added for Stack.gap, Grid.variant, Cluster.justify, Surface.color"
      ],
      "passes": true
    },
    {
      "id": "prompt-3",
      "category": "prompt",
      "description": "Prompt builder surfaces layout-critical props with higher scores and appends composition hints",
      "steps": [
        "LAYOUT_CRITICAL_PROP_NAMES set added to prompt-builder.ts with gap, justify scored at +2",
        "color and layout added to INTERESTING_PROP_NAMES",
        "scoreProp() uses LAYOUT_CRITICAL_PROP_NAMES for +2 scoring separate from INTERESTING_PROP_NAMES (+1)",
        "COMPOSITION_HINTS record maps Surface, Grid, Stack, Cluster to usage hint strings",
        "Hints appended after component description line in prompt output",
        "Generated prompt output shows gap, justify in top-N props for Stack, Grid, Cluster"
      ],
      "passes": true
    },
    {
      "id": "generative-1",
      "category": "generative",
      "description": "GenerativeGrid wrapper defaults variant and gap when LLM omits them",
      "steps": [
        "GenerativeGrid component exists in generative-wrappers.tsx",
        "Defaults variant='2up' when BOTH variant AND columns props are missing",
        "Does NOT default variant when columns is set",
        "Defaults gap='base' when gap is missing",
        "Registered in COMPONENT_MAP overriding direct Grid mapping",
        "Has displayName set"
      ],
      "passes": true
    },
    {
      "id": "generative-2",
      "category": "generative",
      "description": "GenerativeStack wrapper defaults gap when LLM omits it",
      "steps": [
        "GenerativeStack component exists in generative-wrappers.tsx",
        "Defaults gap='base' when gap prop is missing",
        "Does NOT override gap when explicitly set by LLM",
        "Registered in COMPONENT_MAP overriding direct Stack mapping",
        "Has displayName set"
      ],
      "passes": true
    },
    {
      "id": "generative-3",
      "category": "generative",
      "description": "GenerativeText wrapper defaults variant when LLM omits it",
      "steps": [
        "GenerativeText component exists in generative-wrappers.tsx",
        "Defaults variant='body' when variant prop is missing",
        "Does NOT override variant when explicitly set by LLM",
        "Registered in COMPONENT_MAP overriding direct Text mapping",
        "Has displayName set"
      ],
      "passes": true
    },
    {
      "id": "validator-1",
      "category": "validator",
      "description": "Validator coerces common invalid enum values before Zod validation instead of stripping",
      "steps": [
        "ENUM_COERCION_MAP defined in element-validator.ts for Badge.variant, Stack.gap, Grid.gap, Text.variant",
        "Badge coercions: info->primary, success->positive, error->negative, danger->negative, warning->caution",
        "Stack.gap coercions: medium->base, large->lg, small->sm, extra->xl",
        "Grid.gap coercions: medium->base, large->lg, small->sm",
        "Text.variant coercions: title->heading2, subtitle->heading3, caption->secondary",
        "Coercion runs BEFORE Zod validation in validateElement(), not in repairElement()",
        "Flow: coerce -> validate -> fail -> repair (strip remaining)",
        "Coerced props are preserved (not stripped) — the corrected value passes validation"
      ],
      "passes": true
    },
    {
      "id": "validator-2",
      "category": "validator",
      "description": "Renderer auto-wraps Surface orphan children in Stack to enforce canonical layout pattern",
      "steps": [
        "normalizeSurfaceOrphans() function exists in ui-tree-renderer.tsx",
        "Called in UITreeRendererImpl useMemo chain alongside normalizeSiblingFormRowGrids",
        "Surface with multiple children not wrapped in single Stack gets auto-wrapped",
        "Synthetic Stack key is deterministic: auto-stack-{surface-key}",
        "Synthetic Stack has gap='lg' and type='Stack'",
        "Original children moved to synthetic Stack's children array",
        "Surface's children updated to [auto-stack-{surface-key}]",
        "Skip: Surface has 0 children",
        "Skip: Surface has exactly 1 child that IS a Stack",
        "Wrap: Surface has 1 non-Stack child (single orphan is still non-canonical)"
      ],
      "passes": true
    },
    {
      "id": "endpoint-1",
      "category": "endpoint",
      "description": "Chat endpoint exposes more props per component and includes additional component types",
      "steps": [
        "maxPropsPerComponent changed from 6 to 8 in chat.ts",
        "Field added to PROMPT_COMPONENTS array",
        "Label added to PROMPT_COMPONENTS array",
        "ClipboardText added to PROMPT_COMPONENTS array",
        "Generated system prompt includes props for Field, Label, ClipboardText"
      ],
      "passes": true
    },
    {
      "id": "integration-1",
      "category": "integration",
      "description": "All changes verified together: tests pass, types check, lint clean, golden prompts produce correct UI",
      "steps": [
        "pnpm --filter @cloudflare/kumo test passes (all tests including structural graders)",
        "pnpm --filter @cloudflare/kumo typecheck passes with no errors",
        "pnpm lint passes with no violations",
        "pnpm dev starts successfully",
        "Golden prompt 'user card' produces well-structured UI in StreamingDemo",
        "Golden prompt 'settings form' produces well-structured UI in StreamingDemo",
        "Golden prompt 'counter' produces well-structured UI in StreamingDemo",
        "Golden prompt 'pricing table' produces well-structured UI in StreamingDemo",
        "JSONL fixtures re-captured and graders still pass"
      ],
      "passes": true
    }
  ],
  "context": {
    "patterns": [
      "Generative wrappers: packages/kumo/src/generative/generative-wrappers.tsx — forwardRef, read prop, default if missing, delegate",
      "Renderer normalization: packages/kumo/src/generative/ui-tree-renderer.tsx:107 — normalizeSiblingFormRowGrids in useMemo",
      "Validator repair: packages/kumo/src/generative/element-validator.ts:166 — repairElement strips invalid top-level props",
      "Prop scoring: packages/kumo/src/catalog/prompt-builder.ts:231 — scoreProp sums required(+3), enum(+2), interesting(+1)",
      "Component map: packages/kumo/src/generative/component-map.ts — 6 layers: direct, sub-components, aliases, generative wrappers, stateful wrappers, synthetic"
    ],
    "keyFiles": [
      "packages/kumo/src/catalog/system-prompt.ts",
      "packages/kumo/src/catalog/prompt-builder.ts",
      "packages/kumo/src/generative/generative-wrappers.tsx",
      "packages/kumo/src/generative/component-map.ts",
      "packages/kumo/src/generative/element-validator.ts",
      "packages/kumo/src/generative/ui-tree-renderer.tsx",
      "packages/kumo-docs-astro/src/pages/api/chat.ts",
      "packages/kumo/ai/schemas.ts"
    ],
    "nonGoals": [
      "Eval harness with live LLM grading",
      "Model comparison/upgrade evaluation",
      "New Kumo component primitives (Divider, Container, StatCard)",
      "Snippet/template composition system",
      "Streaming parser or RFC 6902 patch engine changes",
      "Dynamic prompt scoping by user intent"
    ]
  }
}
