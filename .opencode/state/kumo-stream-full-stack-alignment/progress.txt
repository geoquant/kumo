# Progress Log
PRD: kumo-stream-full-stack-alignment
Started: 2026-02-20

## Codebase Patterns
- Runtime values: per-container `RuntimeValueStore` + React context provider in `UITreeRenderer` (UMD uses per-container Map; SPA uses `useRuntimeValueStore()`)
- Runtime capture: `UITreeRenderer` injects `onChange` for `Input` + `Textarea` to set store by `elementKey` (chain existing handler; read `event.target.value` safely)
- submit_form runtime: `UITreeRenderer` injects `context.runtimeValues = store.snapshotTouched()` on submit button click; handler builds stable JSON payload w/ scope + guardrails
- Prompt anti-drift: generate "Available Components" section from `@cloudflare/kumo/ai/component-registry.json` filtered by `@cloudflare/kumo/ai/schemas` + `KNOWN_TYPES`
- URL policy: `sanitizeUrl()` allow http(s)+relative only; block other schemes + `//...`; enforce in `processActionResult` (external) + `UITreeRenderer` (Link href)
- UMD tree observers: keep per-container subscriber Set; `notifyTree(containerId, tree)` on patch/batch/render; `reset()` clears subscribers
- UMD action runtime: expose `dispatchAction(event, containerId)` + `processActionResult(result, callbacks)`; host wires callbacks (applyPatches/sendMessage/openExternal)

---
<!-- Task logs below - APPEND ONLY -->

## Task - [functional-1]
- Implemented per-container runtime value store w/ touched tracking + clear-on-reset
- Files changed: `_examples/kumo-stream/src/core/runtime-value-store.ts`, `_examples/kumo-stream/src/core/runtime-value-store-context.tsx`, `_examples/kumo-stream/src/core/hooks.ts`, `_examples/kumo-stream/src/core/UITreeRenderer.tsx`, `_examples/kumo-stream/src/app/ChatDemo.tsx`, `_examples/kumo-stream/src/loadable/index.ts`, `_examples/kumo-stream/src/__tests__/runtime-value-store.test.ts`
- Learnings: keep store lifetime tied to container (UMD: `containerId` Map; React: hook + unmount cleanup)

## Task - [functional-2]
- Implemented runtime capture for `Input` + `Textarea` via `onChange` injection in `UITreeRenderer` (no controlled state)
- Files changed: `_examples/kumo-stream/src/core/UITreeRenderer.tsx`, `_examples/kumo-stream/src/__tests__/runtime-value-capture.test.tsx`, `.opencode/state/kumo-stream-full-stack-alignment/prd.json`, `.opencode/state/kumo-stream-full-stack-alignment/progress.txt`
- Learnings: keep capture logic in renderer so it works with any component-map impl; always chain existing handlers to avoid breaking host overrides

## Task - [functional-3]
- Implemented submit_form payload builder: merges static params + runtime-captured field values; supports `formKey` subtree scope + `fieldKeys` allowlist; ambiguity fail-closed
- Files changed: `_examples/kumo-stream/src/core/action-registry.ts`, `_examples/kumo-stream/src/core/UITreeRenderer.tsx`, `_examples/kumo-stream/src/__tests__/action-registry.test.ts`, `_examples/kumo-stream/src/__tests__/process-action-result.test.ts`, `.opencode/state/kumo-stream-full-stack-alignment/prd.json`, `.opencode/state/kumo-stream-full-stack-alignment/progress.txt`
- Learnings: keep runtime values out of UITree (avoid rerender churn); inject snapshot into submit_form click event context (`runtimeValues`) for portable UMD/SPA semantics

## Task - [prompt-1]
- Implemented generated "Available Components" prompt section derived from `@cloudflare/kumo` registry + schemas, filtered to kumo-stream supported types (incl aliases)
- Files changed: `_examples/kumo-stream/src/core/system-prompt.ts`, `_examples/kumo-stream/src/core/system-prompt-components.ts`, `_examples/kumo-stream/src/__tests__/system-prompt-components.test.ts`, `_examples/kumo-stream/src/__tests__/action-registry.test.ts`, `_examples/kumo-stream/src/core/UITreeRenderer.tsx`, `.opencode/state/kumo-stream-full-stack-alignment/prd.json`, `.opencode/state/kumo-stream-full-stack-alignment/progress.txt`
- Learnings: intersect registry props w/ Zod object shape keys to avoid advertising invalid props; treat `Div`/`RadioItem` as synthetic + unvalidated

## Task - [security-1]
- Implemented safe-by-default URL policy for external navigations + Link hrefs (allow http(s)+relative; block others)
- Files changed: `_examples/kumo-stream/src/core/url-policy.ts`, `_examples/kumo-stream/src/core/process-action-result.ts`, `_examples/kumo-stream/src/core/UITreeRenderer.tsx`, `_examples/kumo-stream/src/__tests__/process-action-result.test.ts`, `_examples/kumo-stream/src/__tests__/ui-tree-renderer-action.test.tsx`, `_examples/kumo-stream/src/__tests__/url-policy.test.ts`, `.opencode/state/kumo-stream-full-stack-alignment/prd.json`, `.opencode/state/kumo-stream-full-stack-alignment/progress.txt`
- Learnings: enforce policy at boundaries (renderer for href; action processor for external) so custom handlers inherit safety

## Task - [component-1]
- Implemented Field entry in `COMPONENT_MAP` (Code/Label already present) and added renderer resolution test.
- Files changed: `_examples/kumo-stream/src/core/component-map.ts`, `_examples/kumo-stream/src/__tests__/component-map-new-entries.test.tsx`, `.opencode/state/kumo-stream-full-stack-alignment/prd.json`, `.opencode/state/kumo-stream-full-stack-alignment/progress.txt`
- Learnings: even when controls auto-wrap with Field via `label`, exposing `Field` lets the model compose consistent form-group layouts and wrap arbitrary controls; keep prompt + validation in sync by mapping only shipped components.

## Task - [umd-1]
- Implemented UMD `getTree(containerId)` + `subscribeTree(containerId, cb)` APIs; subscriptions fire on applyPatch/applyPatches/renderTree.
- Files changed: `_examples/kumo-stream/src/loadable/index.ts`, `_examples/kumo-stream/src/__tests__/loadable-tree-access.test.ts`, `.opencode/state/kumo-stream-full-stack-alignment/prd.json`, `.opencode/state/kumo-stream-full-stack-alignment/progress.txt`
- Learnings: keep tree observation decoupled from DOM rendering so cross-boundary hosts can stop scraping; clear per-container subscribers in `reset()`

## Task - [umd-2]
- Implemented shared UMD action runtime exports (`createHandlerMap`, `dispatchAction`, `processActionResult`) and refactored cross-boundary demo to use them.
- Files changed: `_examples/kumo-stream/src/loadable/index.ts`, `_examples/kumo-stream/public/cross-boundary.html`, `_examples/kumo-stream/src/__tests__/loadable-action-runtime.test.ts`, `.opencode/state/kumo-stream-full-stack-alignment/prd.json`, `.opencode/state/kumo-stream-full-stack-alignment/progress.txt`
- Learnings: keep host-specific behavior as callbacks (apply patches, send message) so action model stays shared across SPA/UMD without duplicating registry logic
