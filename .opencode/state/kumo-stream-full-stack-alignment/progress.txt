# Progress Log
PRD: kumo-stream-full-stack-alignment
Started: 2026-02-20

## Codebase Patterns
- Runtime values: per-container `RuntimeValueStore` + React context provider in `UITreeRenderer` (UMD uses per-container Map; SPA uses `useRuntimeValueStore()`)
- Runtime capture: `UITreeRenderer` injects `onChange` for `Input` + `Textarea` to set store by `elementKey` (chain existing handler; read `event.target.value` safely)
- submit_form runtime: `UITreeRenderer` injects `context.runtimeValues = store.snapshotTouched()` on submit button click; handler builds stable JSON payload w/ scope + guardrails
- Prompt anti-drift: generate "Available Components" section from `@cloudflare/kumo/ai/component-registry.json` filtered by `@cloudflare/kumo/ai/schemas` + `KNOWN_TYPES`

---
<!-- Task logs below - APPEND ONLY -->

## Task - [functional-1]
- Implemented per-container runtime value store w/ touched tracking + clear-on-reset
- Files changed: `_examples/kumo-stream/src/core/runtime-value-store.ts`, `_examples/kumo-stream/src/core/runtime-value-store-context.tsx`, `_examples/kumo-stream/src/core/hooks.ts`, `_examples/kumo-stream/src/core/UITreeRenderer.tsx`, `_examples/kumo-stream/src/app/ChatDemo.tsx`, `_examples/kumo-stream/src/loadable/index.ts`, `_examples/kumo-stream/src/__tests__/runtime-value-store.test.ts`
- Learnings: keep store lifetime tied to container (UMD: `containerId` Map; React: hook + unmount cleanup)

## Task - [functional-2]
- Implemented runtime capture for `Input` + `Textarea` via `onChange` injection in `UITreeRenderer` (no controlled state)
- Files changed: `_examples/kumo-stream/src/core/UITreeRenderer.tsx`, `_examples/kumo-stream/src/__tests__/runtime-value-capture.test.tsx`, `.opencode/state/kumo-stream-full-stack-alignment/prd.json`, `.opencode/state/kumo-stream-full-stack-alignment/progress.txt`
- Learnings: keep capture logic in renderer so it works with any component-map impl; always chain existing handlers to avoid breaking host overrides

## Task - [functional-3]
- Implemented submit_form payload builder: merges static params + runtime-captured field values; supports `formKey` subtree scope + `fieldKeys` allowlist; ambiguity fail-closed
- Files changed: `_examples/kumo-stream/src/core/action-registry.ts`, `_examples/kumo-stream/src/core/UITreeRenderer.tsx`, `_examples/kumo-stream/src/__tests__/action-registry.test.ts`, `_examples/kumo-stream/src/__tests__/process-action-result.test.ts`, `.opencode/state/kumo-stream-full-stack-alignment/prd.json`, `.opencode/state/kumo-stream-full-stack-alignment/progress.txt`
- Learnings: keep runtime values out of UITree (avoid rerender churn); inject snapshot into submit_form click event context (`runtimeValues`) for portable UMD/SPA semantics

## Task - [prompt-1]
- Implemented generated "Available Components" prompt section derived from `@cloudflare/kumo` registry + schemas, filtered to kumo-stream supported types (incl aliases)
- Files changed: `_examples/kumo-stream/src/core/system-prompt.ts`, `_examples/kumo-stream/src/core/system-prompt-components.ts`, `_examples/kumo-stream/src/__tests__/system-prompt-components.test.ts`, `_examples/kumo-stream/src/__tests__/action-registry.test.ts`, `_examples/kumo-stream/src/core/UITreeRenderer.tsx`, `.opencode/state/kumo-stream-full-stack-alignment/prd.json`, `.opencode/state/kumo-stream-full-stack-alignment/progress.txt`
- Learnings: intersect registry props w/ Zod object shape keys to avoid advertising invalid props; treat `Div`/`RadioItem` as synthetic + unvalidated
