{
  "prdName": "kumo-regression-prevention",
  "tasks": [
    {
      "id": "contract-1",
      "category": "testing",
      "description": "CSS class contract test asserts all public CSS classes from kumo-binding.css exist in dist/kumo.css",
      "steps": [
        "Test file exists at packages/kumo/tests/css-contract/css-classes.test.ts",
        "Test reads dist/kumo.css and regex-matches each class selector",
        "Manifest covers: no-scrollbar, no-input-spinner, link-current, link-external-icon, skeleton-line, animate-bounce-in, float, kumo-tooltip-popup, kumo-popover-popup",
        "Test uses describe.skipIf(!isBuilt) pattern to skip when dist/ missing",
        "Run pnpm --filter @cloudflare/kumo build && pnpm --filter @cloudflare/kumo test -- tests/css-contract — all pass",
        "Remove a class from kumo-binding.css, rebuild, re-run test — test fails"
      ],
      "passes": true
    },
    {
      "id": "compat-1",
      "category": "build",
      "description": "Set explicit build.target: 'es2022' in vite.config.ts",
      "steps": [
        "vite.config.ts build block contains target: 'es2022'",
        "pnpm --filter @cloudflare/kumo build succeeds with new target"
      ],
      "passes": true
    },
    {
      "id": "compat-2",
      "category": "testing",
      "description": "Post-build test scans dist JS for banned browser APIs",
      "steps": [
        "Test file exists at packages/kumo/tests/build/browser-compat.test.ts",
        "Banned API list includes: toSorted, toReversed, toSpliced, findLast, findLastIndex, .with(, structuredClone, Array.fromAsync",
        "Test scans all dist/**/*.js files for banned API patterns",
        "Test uses describe.skipIf(!isBuilt) pattern",
        "Run pnpm --filter @cloudflare/kumo build && pnpm --filter @cloudflare/kumo test -- tests/build — all pass",
        "Temporarily add toSorted() call in a component, rebuild, re-run — test fails"
      ],
      "passes": true
    },
    {
      "id": "lint-1",
      "category": "testing",
      "description": "Tailwind class conflict lint scans component cn() calls for conflicting class pairs",
      "steps": [
        "Test file exists at packages/kumo/tests/lint/tailwind-conflicts.test.ts",
        "Test uses AST parsing (not regex) to find cn() calls in src/components/**/*.tsx",
        "Collects ALL string literal arguments within each cn() call and checks across them",
        "Conflict pairs include: overflow-hidden/overflow-y-auto, overflow-hidden/overflow-x-auto, overflow-hidden/overflow-auto, overflow-visible/overflow-hidden, hidden/block, hidden/flex, invisible/visible",
        "Run pnpm --filter @cloudflare/kumo test -- tests/lint/tailwind-conflicts — reports the live combobox conflict"
      ],
      "passes": true
    },
    {
      "id": "lint-2",
      "category": "bugfix",
      "description": "Fix the live combobox cn() conflict on main (overflow-hidden vs overflow-y-auto at combobox.tsx:181-182)",
      "steps": [
        "combobox.tsx no longer has conflicting overflow-hidden and overflow-y-auto in the same cn() call",
        "pnpm --filter @cloudflare/kumo test -- tests/lint/tailwind-conflicts passes with zero conflicts",
        "Combobox dropdown content is scrollable (overflow-y-auto preserved, overflow-hidden removed or scoped correctly)"
      ],
      "passes": false
    },
    {
      "id": "vr-1",
      "category": "ci",
      "description": "Visual regression script exits non-zero when pixel diff exceeds threshold",
      "steps": [
        "run-visual-regression.ts exits with non-zero code when any component screenshot diff exceeds 0.5%",
        "Script exits zero when all diffs are within threshold",
        "Script has fallback: continue-on-error behavior with annotation warning when screenshot worker is unreachable"
      ],
      "passes": false
    },
    {
      "id": "vr-2",
      "category": "ci",
      "description": "Visual Regression job in preview.yml becomes a required status check with label override",
      "steps": [
        "preview.yml Visual Regression job is configured as a required status check",
        "PR label visual-change-approved allows bypassing the check",
        "Visual change to dialog/select/combobox/dropdown blocks merge with diff report"
      ],
      "passes": false
    },
    {
      "id": "docs-1",
      "category": "docs",
      "description": "Document new test categories and conventions",
      "steps": [
        "CSS class manifest in test file has comment block explaining how to add/remove classes and version bump requirements",
        "AGENTS.md updated to mention css-contract, browser-compat, tailwind-conflicts test categories"
      ],
      "passes": false
    }
  ],
  "context": {
    "patterns": [
      "Post-build test with skip guard: packages/kumo/tests/imports/export-path-validation.test.ts — uses describe.skipIf(!isBuilt)",
      "CSS class definitions: packages/kumo/src/styles/kumo-binding.css — all 10 public CSS classes",
      "Visual regression pipeline: ci/visual-regression/run-visual-regression.ts — pixelmatch comparison, PR comment"
    ],
    "keyFiles": [
      "packages/kumo/vite.config.ts",
      "packages/kumo/src/styles/kumo-binding.css",
      "ci/visual-regression/run-visual-regression.ts",
      ".github/workflows/preview.yml",
      ".github/workflows/pullrequest.yml",
      "packages/kumo/tests/imports/test-utils.ts",
      "packages/kumo/tests/imports/export-path-validation.test.ts",
      "packages/kumo/src/components/combobox/combobox.tsx"
    ],
    "nonGoals": [
      "Stratus-side CI changes — kumo-only",
      "Full component test coverage (39 components) — separate effort",
      "Changeset severity classification automation",
      "Deprecation workflow for CSS classes — manifest handles it",
      "Combobox/dialog behavioral unit tests — separate effort",
      "DOM structure / test ID stability contract — different class of problem"
    ]
  }
}
