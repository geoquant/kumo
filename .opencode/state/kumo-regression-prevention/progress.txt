# Progress Log
PRD: kumo-regression-prevention
Started: 2026-02-20

## Codebase Patterns
- **Post-build test guard**: `const isBuilt = existsSync(join(distDir, "file.js")); describe.skipIf(!isBuilt)(...)`
- **Test discovery**: vitest.config.ts includes `tests/**/*.{test,spec}.ts` in unit project
- **CSS build pipeline**: vite build -> css-build.ts copies raw CSS + compiles kumo-standalone.css via @tailwindcss/cli
- **Dist CSS paths**: `dist/styles/kumo.css` (raw), `dist/styles/kumo-binding.css` (raw), `dist/styles/kumo-standalone.css` (compiled)
- **Build deps issue**: `motion` package needed `pnpm install` after being added to package.json (flow component)

---

## Task - contract-1
- Implemented CSS class contract test at `packages/kumo/tests/css-contract/css-classes.test.ts`
- Test scans `dist/styles/kumo-standalone.css` (compiled output) for all 9 public class selectors
- Includes manifest completeness check that verifies kumo-binding.css classes are all documented
- Files changed: `packages/kumo/tests/css-contract/css-classes.test.ts` (new)
- **Learnings:**
  - kumo-standalone.css is minified to ~1 line, regex matching works fine
  - The `classExistsInCss` helper uses word-boundary-like regex to avoid partial matches (e.g. `.float` not matching `.floating`)
  - All 9 classes from kumo-binding.css survive Tailwind v4 compilation
  - Pre-existing build failure: `motion/react` import in flow/diagram.tsx requires `pnpm install` after fresh clone

## Task - compat-1
- Added explicit `target: "es2022"` to vite.config.ts build block
- Vite default is `"modules"` (es2020); explicit es2022 prevents accidental downleveling
- Files changed: `packages/kumo/vite.config.ts`
- **Learnings:**
  - Vite's `build.target` is separate from `rollupOptions` — it controls esbuild's syntax lowering
  - ES2022 adds: top-level await, class fields, private methods, RegExp /d, Error.cause, Object.hasOwn, Array.at
  - Build succeeds cleanly with es2022, no syntax incompatibilities in current source

## Task - compat-2
- Created post-build browser compat test at `packages/kumo/tests/build/browser-compat.test.ts`
- Scans all 134 dist JS files for 8 banned ES2023+/ES2024 API patterns
- Includes KNOWN_EXCEPTIONS escape hatch with required justification
- Sanity-checks dist has >50 JS files to catch build structure changes
- Files changed: `packages/kumo/tests/build/browser-compat.test.ts` (new)
- **Learnings:**
  - `.with()` pattern needs careful regex — `(?:[\])]|\w)\.with\(\s*\d` avoids false positives from `startsWith(`, `endsWith(`, etc.
  - Current dist (134 JS files) is clean — zero banned APIs
  - `structuredClone` needs `\b` word boundary to avoid matching variable names containing the substring
  - Recursive file walk needed since dist has nested dirs (components/, primitives/, etc.)
