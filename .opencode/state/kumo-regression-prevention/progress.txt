# Progress Log
PRD: kumo-regression-prevention
Started: 2026-02-20

## Codebase Patterns
- **Post-build test guard**: `const isBuilt = existsSync(join(distDir, "file.js")); describe.skipIf(!isBuilt)(...)`
- **Test discovery**: vitest.config.ts includes `tests/**/*.{test,spec}.ts` in unit project
- **CSS build pipeline**: vite build -> css-build.ts copies raw CSS + compiles kumo-standalone.css via @tailwindcss/cli
- **Dist CSS paths**: `dist/styles/kumo.css` (raw), `dist/styles/kumo-binding.css` (raw), `dist/styles/kumo-standalone.css` (compiled)
- **Build deps issue**: `motion` package needed `pnpm install` after being added to package.json (flow component)
- **AST cn() parsing**: `ts.createSourceFile(path, source, ScriptTarget.Latest, true, ScriptKind.TSX)` + recursive visitor for CallExpression where `expression.text === "cn"`. Skip ternary branches via `isConditionalExpression` check.

---

## Task - contract-1
- Implemented CSS class contract test at `packages/kumo/tests/css-contract/css-classes.test.ts`
- Test scans `dist/styles/kumo-standalone.css` (compiled output) for all 9 public class selectors
- Includes manifest completeness check that verifies kumo-binding.css classes are all documented
- Files changed: `packages/kumo/tests/css-contract/css-classes.test.ts` (new)
- **Learnings:**
  - kumo-standalone.css is minified to ~1 line, regex matching works fine
  - The `classExistsInCss` helper uses word-boundary-like regex to avoid partial matches (e.g. `.float` not matching `.floating`)
  - All 9 classes from kumo-binding.css survive Tailwind v4 compilation
  - Pre-existing build failure: `motion/react` import in flow/diagram.tsx requires `pnpm install` after fresh clone

## Task - compat-1
- Added explicit `target: "es2022"` to vite.config.ts build block
- Vite default is `"modules"` (es2020); explicit es2022 prevents accidental downleveling
- Files changed: `packages/kumo/vite.config.ts`
- **Learnings:**
  - Vite's `build.target` is separate from `rollupOptions` — it controls esbuild's syntax lowering
  - ES2022 adds: top-level await, class fields, private methods, RegExp /d, Error.cause, Object.hasOwn, Array.at
  - Build succeeds cleanly with es2022, no syntax incompatibilities in current source

## Task - compat-2
- Created post-build browser compat test at `packages/kumo/tests/build/browser-compat.test.ts`
- Scans all 134 dist JS files for 8 banned ES2023+/ES2024 API patterns
- Includes KNOWN_EXCEPTIONS escape hatch with required justification
- Sanity-checks dist has >50 JS files to catch build structure changes
- Files changed: `packages/kumo/tests/build/browser-compat.test.ts` (new)
- **Learnings:**
  - `.with()` pattern needs careful regex — `(?:[\])]|\w)\.with\(\s*\d` avoids false positives from `startsWith(`, `endsWith(`, etc.
  - Current dist (134 JS files) is clean — zero banned APIs
  - `structuredClone` needs `\b` word boundary to avoid matching variable names containing the substring
  - Recursive file walk needed since dist has nested dirs (components/, primitives/, etc.)

## Task - lint-1
- Created Tailwind class conflict lint at `packages/kumo/tests/lint/tailwind-conflicts.test.ts`
- Uses TypeScript compiler API (ts.createSourceFile) for AST parsing of cn() calls
- Extracts string literals from all cn() arguments, splits into individual classes
- Handles ternary expressions: classes in opposite branches of `cond ? a : b` are NOT compared (mutually exclusive at runtime)
- Handles logical-AND: `cond && "classes"` ARE included (they co-occur with unconditional classes when condition is true)
- Handles nested cn() calls and parenthesized expressions
- 11 conflict pairs covering overflow, display, and visibility conflicts
- Correctly detects combobox.tsx:180 overflow-hidden/overflow-y-auto conflict
- Correctly ignores input-group.tsx ternary (overflow-visible vs overflow-hidden in opposite branches)
- Files changed: `packages/kumo/tests/lint/tailwind-conflicts.test.ts` (new)
- **Learnings:**
  - TS 5.9 `ParenthesizedExpression` uses `.expression` not `.operand`
  - input/input-group.tsx has a legitimate ternary usage of overflow-visible/overflow-hidden — AST-aware parsing essential to avoid false positives
  - `ts.createSourceFile` with `setParentNodes: true` and `ScriptKind.TSX` needed for JSX/TSX parsing
  - The test intentionally fails (reports combobox conflict) until lint-2 fixes it
